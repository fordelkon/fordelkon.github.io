<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>使用CMake的艺术2 | DL Kong</title><meta name=keywords content="C-Plus-Plus,CMake"><meta name=description content="上面我们实现了CMake的一套简要搭建流程，基本上简单的编译配置就靠上面的几个CMake命令就可以完成了。但一些大型项目的cmake的配置光靠上面的几个CMake命令是远远不够的，简单来说如何导入第三方库，嗯这就属于CMake进阶的内容了&mldr;"><meta name=author content="DL Kong"><link rel=canonical href=https://fordelkon.github.io/posts/cmake_intro_2/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.c7a0847263ef81d155d535eb3508757a49b1a3680807f60ed1f64e9d4a686070.css integrity="sha256-x6CEcmPvgdFV1TXrNQh1ekmxo2gIB/YO0fZOnUpoYHA=" rel="preload stylesheet" as=style><link rel=icon href=https://fordelkon.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fordelkon.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fordelkon.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fordelkon.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fordelkon.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://fordelkon.github.io/posts/cmake_intro_2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><style>@media screen and (min-width:769px){.post-content input[type=checkbox]:checked~label>img{transform:scale(1.6);cursor:zoom-out;position:relative;z-index:999}.post-content img.zoomCheck{transition:transform .15s ease;z-index:999;cursor:zoom-in}}</style><link rel=stylesheet href=/css/extended/xcode.css media="(prefers-color-scheme: light)"><link rel=stylesheet href=/css/extended/monokai.css media="(prefers-color-scheme: dark)"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Q603T56FWT"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Q603T56FWT")}</script><meta property="og:url" content="https://fordelkon.github.io/posts/cmake_intro_2/"><meta property="og:site_name" content="DL Kong"><meta property="og:title" content="使用CMake的艺术2"><meta property="og:description" content="上面我们实现了CMake的一套简要搭建流程，基本上简单的编译配置就靠上面的几个CMake命令就可以完成了。但一些大型项目的cmake的配置光靠上面的几个CMake命令是远远不够的，简单来说如何导入第三方库，嗯这就属于CMake进阶的内容了…"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-24T17:30:00+09:00"><meta property="article:modified_time" content="2025-08-24T17:30:00+09:00"><meta property="article:tag" content="C-Plus-Plus"><meta property="article:tag" content="CMake"><meta property="og:image" content="https://fordelkon.github.io/img/cmakeart.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fordelkon.github.io/img/cmakeart.png"><meta name=twitter:title content="使用CMake的艺术2"><meta name=twitter:description content="上面我们实现了CMake的一套简要搭建流程，基本上简单的编译配置就靠上面的几个CMake命令就可以完成了。但一些大型项目的cmake的配置光靠上面的几个CMake命令是远远不够的，简单来说如何导入第三方库，嗯这就属于CMake进阶的内容了&mldr;"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://fordelkon.github.io/posts/"},{"@type":"ListItem","position":2,"name":"使用CMake的艺术2","item":"https://fordelkon.github.io/posts/cmake_intro_2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用CMake的艺术2","name":"使用CMake的艺术2","description":"上面我们实现了CMake的一套简要搭建流程，基本上简单的编译配置就靠上面的几个CMake命令就可以完成了。但一些大型项目的cmake的配置光靠上面的几个CMake命令是远远不够的，简单来说如何导入第三方库，嗯这就属于CMake进阶的内容了\u0026hellip;\n","keywords":["C-Plus-Plus","CMake"],"articleBody":"上面我们实现了CMake的一套简要搭建流程，基本上简单的编译配置就靠上面的几个CMake命令就可以完成了。但一些大型项目的cmake的配置光靠上面的几个CMake命令是远远不够的，简单来说如何导入第三方库，嗯这就属于CMake进阶的内容了…\nCMakeLists.txt语法 本地变量、缓存变量、环境变量（变量） 变量通常通过set()来进行声明，set()命令语法如下：\n# 声明本地变量 set( ) 参数： ：要设置的本地变量名称。 ：变量的值（单个或多个），多个值时它们使用`;`拼接成一个字符串。 # 声明缓存变量 set( CACHE ) 参数： ：要设置的缓存变量名称。 ：缓存变量的值（值的具体含义由后边的选择参数决定）。 ： - STRING ：普通字符串变量。 - BOOL ：布尔类型变量，取值可以是 ON、OFF。 - PATH ：路径变量，用于存储目录路径。 - FILEPATH ：文件路径变量，用于存储文件的完整路径。 ：该缓存变量的字符串描述。 # 声明环境变量 set(ENV{variable} value) # 最好不要乱设置 该测试对应的源代码所在目录详见https://github.com/fordelkon/cmake_tutorial/tree/main/advanced_process/cmake_var。测试的CMakeLists.txt内容如下：\n# 指定最小Cmake的版本要求 cmake_minimum_required(VERSION 3.9) # 设置项目名称 project(CMAKE_VARIABLES) # 本地变量 set(LOCAL_VAR \"value\") set(LOCAL_LIST \"value1\" \"value2\") message(\"LOCAL_VAR is ${LOCAL_VAR}, LOCAL_LIST is ${LOCAL_LIST}\") # 缓存变量 set(CACHE_VAR_BOOL ON CACHE BOOL \"this is a bool cache variable\") set(CACHE_VAR_STRING \"cache value\" CACHE STRING \"this is a string variable\") message(\"CACHE_VAR_BOOL is ${CACHE_VAR_BOOL}, CACHE_VAR_STRING is ${CACHE_VAR_STRING}\") # 环境变量 message(\"My PC shell is $ENV{SHELL}\") 在CMakeLists.txt所在的目录下运行cmake -B build得到\n-- The C compiler identification is AppleClang 16.0.0.16000026 -- The CXX compiler identification is AppleClang 16.0.0.16000026 -- Detecting C compiler ABI info -- Detecting C compiler ABI info - done -- Check for working C compiler: /Library/Developer/CommandLineTools/usr/bin/cc - skipped -- Detecting C compile features -- Detecting C compile features - done -- Detecting CXX compiler ABI info -- Detecting CXX compiler ABI info - done -- Check for working CXX compiler: /Library/Developer/CommandLineTools/usr/bin/c++ - skipped -- Detecting CXX compile features -- Detecting CXX compile features - done LOCAL_VAR is value, LOCAL_LIST is value1;value2 CACHE_VAR_BOOL is ON, CACHE_VAR_STRING is cache value My PC shell is /bin/zsh -- Configuring done (0.4s) -- Generating done (0.0s) -- Build files have been written to: /Users/delkon/Desktop/UniversityWork/Year4/CMake_Art/advanced_process/cmake_var/build 修改LOCAL_VAR为changes value，CACHE_VAR_BOOL为OFF，再次运行cmake -B build得到\nLOCAL_VAR is changes value, LOCAL_LIST is value1;value2 CACHE_VAR_BOOL is ON, CACHE_VAR_STRING is cache value My PC shell is /bin/zsh -- Configuring done (0.0s) -- Generating done (0.0s) -- Build files have been written to: /Users/delkon/Desktop/UniversityWork/Year4/CMake_Art/advanced_process/cmake_var/build 可以看到LOCAL_VAR被改变了，但是CACHE_VAR_BOOL由于在./build/CMakeCache.txt被缓存所以没有发生改变。\nCMake运行其他的程序 find_package() find_package()是 CMake 中用于查找外部库或包的命令，有两种查找外部库或包的模式：\nConfig 模式：通过包自带的配置文件（如 Config.cmake 或 -config.cmake）查找库。现代 CMake 项目通常提供这些配置文件。 Module 模式：通过 CMake 自带的查找模块（如 Find.cmake）来查找库。早期的 CMake 使用这种方式查找库。 find_package( [version] [REQUIRED] [QUIET] [COMPONENTS components] [OPTIONAL_COMPONENTS components]) 参数： ：要查找包的名称。 [version] ：指定包的最低版本号（可选）。如果不指定版本号，将查找任意版本的包。 [REQUIRED] ：如果包未找到，则立即停止并给出错误。如果不加 REQUIRED，则会继续执行脚本，即使找不到该包。 [QUIET] ：抑制输出，即使找不到包也不显示消息。 [COMPONENTS components] ：指定包的特定组件，只有这些组件会被查找。用于包含多个模块的包。 [OPTIONAL_COMPONENTS components] ：指定一些可选的组件，如果没有找到这些组件，不会影响主要构建过程。 -------------------------------------------------------------------------------- 查找结果： - _FOUND：是否找到包。 - _INCLUDE_DIRS：包的头文件路径。 - _LIBRARIES：包的库文件路径。 - _VERSION：找到的包的版本号。 - _EXECUTABLE ：可执行文件的路径。 有时自己的笔记本上有好几个命名相同但版本不同的包，find_package()找到的包和自己预期的路径不太一样，这是我们可以显式地指定_EXECUTABLE内容，这样就可以索引到我们想要的包啦。\n该测试对应的源代码所在目录详见https://github.com/fordelkon/cmake_tutorial/tree/main/advanced_process/third_package。相关的测试CMakeLists.txt文件如下：\n# 指定最小Cmake的版本要求 cmake_minimum_required(VERSION 3.9) # 设置项目名称 project(THIRD_PACKAGE) set(FLAG OFF) # or ON if(FLAG) find_package(Python REQUIRED COMPONENTS Interpreter Development) if(Python_FOUND) message(\"Package include directory is ${Python_INCLUDE_DIRS}\") message(\"Package library is ${Python_LIBRARIES}\") message(\"Package version is ${Python_VERSION}\") message(\"Package executable file path is ${Python_EXECUTABLE}\") endif() else() set(Python_EXECUTABLE \"$ENV{CONDA_PYTHON_EXE}\") find_package(Python REQUIRED COMPONENTS Interpreter Development) if(Python_FOUND) message(\"Package include directory is ${Python_INCLUDE_DIRS}\") message(\"Package library is ${Python_LIBRARIES}\") message(\"Package version is ${Python_VERSION}\") message(\"Package executable file path is ${Python_EXECUTABLE}\") endif() endif() 当FLAG为ON时，得到\n....................................前面省略...................................... -- Found Python: /opt/homebrew/Frameworks/Python.framework/Versions/3.13/bin/python3.13 (found version \"3.13.0\") found components: Interpreter Development Development.Module Development.Embed Package include directory is /opt/homebrew/opt/python@3.13/Frameworks/Python.framework/Versions/3.13/include/python3.13 Package library is /opt/homebrew/opt/python@3.13/Frameworks/Python.framework/Versions/3.13/lib/libpython3.13.dylib Package version is 3.13.0 Package executable file path is /opt/homebrew/Frameworks/Python.framework/Versions/3.13/bin/python3.13 ....................................后面省略...................................... 这并不是我们想要的包的路径，通过设定FLAG为OFF，显式地指定_EXECUTABLE为我们所要的包的可执行文件的内容，运行结果如下：\n....................................前面省略...................................... -- Found Python: /Users/delkon/miniconda3/bin/python (found version \"3.10.13\") found components: Interpreter Development Development.Module Development.Embed Package include directory is /Users/delkon/miniconda3/include/python3.10 Package library is /Users/delkon/miniconda3/lib/libpython3.10.dylib Package version is 3.10.13 Package executable file path is /Users/delkon/miniconda3/bin/python ....................................后面省略...................................... 达到了我们的目的。\n配置时运行：execute_process() execute_process( COMMAND [args...] [WORKING_DIRECTORY ] [TIMEOUT ] [RESULT_VARIABLE ] [OUTPUT_VARIABLE ] [ERROR_VARIABLE ] [INPUT_FILE ] [OUTPUT_FILE ] [ERROR_FILE ] [INPUT_FILE ] ) 参数： - COMMAND [args...] ：指定要执行的命令及其参数。 - WORKING_DIRECTORY ：设置命令执行时的工作目录。 - TIMEOUT ：设置命令执行的超时时间（秒）。 - RESULT_VARIABLE ：命令执行后的返回值会被存储在 变量中。 - OUTPUT_VARIABLE ：命令标准输出的内容会被存储在 变量中。 - ERROR_VARIABLE ：命令标准错误的内容会被存储在 变量中。 - INPUT_FILE ：将文件的内容作为输入传递给命令。 - OUTPUT_FILE ：将命令的输出保存到指定的文件中。 - ERROR_FILE ：将命令的错误信息保存到指定的文件中。 execute_process()是 CMake 中的一个命令，通常用于在 CMake 配置期间调用外部程序或脚本。该测试对应的源代码所在目录详见https://github.com/fordelkon/cmake_tutorial/tree/main/advanced_process/run_cmd。其CMakeLists.txt测试文件如下：\n# 指定最小Cmake的版本要求 cmake_minimum_required(VERSION 3.9) # 设置项目名称 project(THIRD_PACKAGE) execute_process( COMMAND ls WORKING_DIRECTORY ${CMAKE_SOURCE_DIR} OUTPUT_VARIABLE ls_output ) message(\"Directory ${CMAKE_SOURCE_DIR} listing: ${ls_output}\") 运行结果如下：\n....................................前面省略...................................... Directory /Users/delkon/Desktop/UniversityWork/Year4/CMake_Art/advanced_process/run_cmd listing: CMakeLists.txt build ....................................后面省略...................................... 构建时运行add_custom_command()（了解一下，不常用） 在构建时运行一条命令有点难。主要是目标系统（target system）使这变的很难，因此这条命令并不常用，所以我们了解该命令一下就可以了。\nadd_custom_command( OUTPUT [ ...] COMMAND [args...] [MAIN_DEPENDENCY ] [DEPENDS [ ...]] [BYPRODUCTS [ ...]] [IMPLICIT_DEPENDS ...] [WORKING_DIRECTORY ] [COMMENT ] [VERBATIM] [APPEND] [USES_TERMINAL] ) 参数： - OUTPUT [ ...] ：指定自定义命令生成的文件或目标。这些文件将被 CMake 视为构建过程的输出，并且可以作为其他目标或命令的输入。 - COMMAND [args...] ：指定执行的命令及其参数。在构建过程中，CMake 将执行此命令。 - [MAIN_DEPENDENCY ] ：定义该命令的主要依赖文件，通常是触发自定义命令的源文件。如果这个文件发生变化，CMake 将重新执行命令。 - [DEPENDS [ ...]] ： 列出该命令依赖的文件或目标。如果依赖项发生变化，CMake 会重新执行此命令。可以依赖于文件、库或其他目标。 - [BYPRODUCTS [ ...]] ：指定该命令执行后生成的副产品文件，帮助 CMake 跟踪这些额外产生的文件。这些文件在命令执行过程中创建，但不会作为主要输出。 - [IMPLICIT_DEPENDS ...] ：指定命令的隐式依赖关系，通常是源文件的语言和路径，CMake 可以自动追踪这些文件的依赖关系。 - [WORKING_DIRECTORY ] ：指定命令执行时的工作目录。命令在这个目录中运行，适用于需要在特定目录下执行的命令。 - [COMMENT ] ：在构建时，显示在命令执行之前的注释。可以用于提示用户正在执行的操作。 - [VERBATIM] ：确保命令的参数在生成的构建文件中被精确传递，而不会因为转义字符或特殊符号发生不必要的修改。通常推荐使用这个选项。 - [APPEND] ：将命令追加到已有的自定义命令中，而不是覆盖它。多个自定义命令可以依次执行。 - [USES_TERMINAL] ：指定命令需要在终端中执行。对于交互式命令（例如，需要用户输入的命令），这个选项很有用。 控制流 配置时评估的控制流：if()语句 if(variable) # 如果variable是`ON`, `YES`, `TRUE`, `Y`或者任意非零值 else() # 如果variable是`0`, `OFF`, `NO`, `FALSE`, `N`, `IGNORE`, `NOTFOUND`, `\"\"`或者以`-NOTFOUND`结尾 endif() # 如果variable没有扩展为上述之一，CMake 将扩展它，然后再次尝试。 这里可以设置一些关键字：\n分组 关键字 功能 一元运算符 NOT 取反运算，条件为假时返回真。 一元运算符 DEFINED 检查变量是否已经定义。 一元运算符 DEFINED 判断文件或目录是否存在。 一元运算符 COMMAND 判断命令是否存在。 一元运算符 POLICY 判断 CMake 策略是否定义。 一元运算符 TARGET 判断指定的目标是否存在。 二元运算符 AND 逻辑与运算，所有条件为真时结果才为真。 二元运算符 OR 逻辑或运算，只要有一个条件为真，结果就为真。 二元运算符 EQUAL 判断两个数值是否相等。 二元运算符 LESS 判断左侧数是否小于右侧数。 二元运算符 GREATER 判断左侧数是否大于右侧数。 二元运算符 LESS_EQUAL 判断左侧数是否小于等于右侧数。 二元运算符 GREATER_EQUAL 判断左侧数是否大于等于右侧数。 二元运算符 STREQUAL 判断两个字符串是否相等。 二元运算符 STRLESS 判断左侧字符串是否小于右侧字符串（字典序）。 二元运算符 STRGREATER 判断左侧字符串是否大于右侧字符串（字典序）。 二元运算符 MATCHES 判断字符串是否匹配指定的正则表达式。 二元运算符 VERSION_LESS 判断左侧版本号是否小于右侧版本号。 二元运算符 VERSION_EQUAL 判断两个版本号是否相等。 二元运算符 VERSION_GREATER 判断左侧版本号是否大于右侧版本号。 构建时评估的控制流：generator-expressions 生成器表达式（generator-expressions，简称为genex）是一种用于在构建生成阶段动态评估和控制行为的强大工具。generator-expression通常用于目标属性（例如编译选项、链接选项等），在项目的生成和构建阶段根据具体的构建配置（如 Debug 或 Release）动态调整行为。\ngenerator-expression基本语法\n$ # CONDITION 表示表达式类型，arg1, arg2, ... 是传递给条件的参数。 配置相关的generator-expression 表达式 说明 示例 $ 如果当前构建配置为 config，则返回真。 $：在 Debug 配置中为真。 $","wordCount":"1108","inLanguage":"en","image":"https://fordelkon.github.io/img/cmakeart.png","datePublished":"2025-08-24T17:30:00+09:00","dateModified":"2025-08-24T17:30:00+09:00","author":{"@type":"Person","name":"DL Kong"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fordelkon.github.io/posts/cmake_intro_2/"},"publisher":{"@type":"Organization","name":"DL Kong","logo":{"@type":"ImageObject","url":"https://fordelkon.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://fordelkon.github.io/ accesskey=h title="DL Kong (Alt + H)"><img src=https://fordelkon.github.io/logo_filled_outlined_6.png alt="Site icon in header" aria-label=logo height=35>DL Kong</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><button id=menu-trigger aria-haspopup=menu aria-label="Menu Button">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><ul class="menu hidden"><li><a href=https://fordelkon.github.io/about/ title=About><span>About</span></a></li><li><a href=https://fordelkon.github.io/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://fordelkon.github.io/teaching/ title=Teaching><span>Teaching</span></a></li><li><a href=https://fordelkon.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fordelkon.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fordelkon.github.io/posts/>Posts</a></div><h1 class=post-title>使用CMake的艺术2</h1><div class=post-meta><span title='2025-08-24 17:30:00 +0900 +0900'>August 8, 24000</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;DL Kong</div></header><div class="toc side left"><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#cmakeliststxt语法><code>CMakeLists.txt</code>语法</a><ul><li><a href=#本地变量缓存变量环境变量变量>本地变量、缓存变量、环境变量（变量）</a></li><li><a href=#cmake运行其他的程序>CMake运行其他的程序</a><ul><li><a href=#find_package><code>find_package()</code></a></li><li><a href=#配置时运行execute_process>配置时运行：<code>execute_process()</code></a></li></ul></li><li><a href=#构建时运行add_custom_command了解一下不常用>构建时运行<code>add_custom_command()</code>（了解一下，不常用）</a></li><li><a href=#控制流>控制流</a><ul><li><a href=#配置时评估的控制流if语句>配置时评估的控制流：<code>if()</code>语句</a></li><li><a href=#构建时评估的控制流generator-expressions>构建时评估的控制流：<code>generator-expressions</code></a></li></ul></li><li><a href=#cmake配置文件confighin>CMake配置文件：<code>config.h.in</code></a></li></ul></li><li><a href=#整体性示例c代码迁移python>整体性示例：<code>C++代码迁移Python</code></a><ul><li><a href=#everything-is-a-target><code>Everything is a target</code></a><ul><li><a href=#目标类型>目标类型</a></li><li><a href=#目标依赖关系>目标依赖关系</a></li><li><a href=#目标属性>目标属性</a></li></ul></li></ul></li></ul></nav></div></details></div><div class=post-content><p>上面我们实现了CMake的一套简要搭建流程，基本上简单的编译配置就靠上面的几个CMake命令就可以完成了。但一些大型项目的cmake的配置光靠上面的几个CMake命令是远远不够的，简单来说如何导入第三方库，嗯这就属于CMake进阶的内容了&mldr;</p><h2 id=cmakeliststxt语法><code>CMakeLists.txt</code>语法<a hidden class=anchor aria-hidden=true href=#cmakeliststxt语法>#</a></h2><h3 id=本地变量缓存变量环境变量变量>本地变量、缓存变量、环境变量（变量）<a hidden class=anchor aria-hidden=true href=#本地变量缓存变量环境变量变量>#</a></h3><p>变量通常通过<code>set()</code>来进行声明，<code>set()</code>命令语法如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=c># 声明本地变量
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>set</span><span class=p>(</span><span class=s>&lt;variable&gt;</span> <span class=s>&lt;values&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>参数：
</span></span></span><span class=line><span class=cl><span class=err>&lt;variable&gt;</span> <span class=err>：要设置的本地变量名称。
</span></span></span><span class=line><span class=cl><span class=err>&lt;values&gt;</span> <span class=err>：变量的值（单个或多个），多个值时它们使用`;`拼接成一个字符串。
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 声明缓存变量
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>set</span><span class=p>(</span><span class=s>&lt;variable&gt;</span> <span class=s>&lt;value&gt;</span> <span class=s>CACHE</span> <span class=s>&lt;STRING|BOOL|PATH|FILEPATH&gt;</span> <span class=s>&lt;description&gt;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>参数：
</span></span></span><span class=line><span class=cl><span class=err>&lt;variable&gt;</span> <span class=err>：要设置的缓存变量名称。
</span></span></span><span class=line><span class=cl><span class=err>&lt;value&gt;</span> <span class=err>：缓存变量的值（值的具体含义由后边的选择参数决定）。
</span></span></span><span class=line><span class=cl><span class=err>&lt;STRING|BOOL|PATH|FILEPATH&gt;</span> <span class=err>：
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=err>-</span> <span class=err>STRING</span> <span class=err>：普通字符串变量。
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=err>-</span> <span class=err>BOOL</span> <span class=err>：布尔类型变量，取值可以是</span> <span class=err>ON、OFF。
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=err>-</span> <span class=err>PATH</span> <span class=err>：路径变量，用于存储目录路径。
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=err>-</span> <span class=err>FILEPATH</span> <span class=err>：文件路径变量，用于存储文件的完整路径。
</span></span></span><span class=line><span class=cl><span class=err>&lt;description&gt;</span> <span class=err>：该缓存变量的字符串描述。
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 声明环境变量
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>set</span><span class=p>(</span><span class=s>ENV{variable}</span> <span class=s>value</span><span class=p>)</span> <span class=c># 最好不要乱设置
</span></span></span></code></pre></div><p>该测试对应的源代码所在目录详见<a href=https://github.com/fordelkon/cmake_tutorial/tree/main/advanced_process/cmake_var>https://github.com/fordelkon/cmake_tutorial/tree/main/advanced_process/cmake_var</a>。测试的<code>CMakeLists.txt</code>内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=c># 指定最小Cmake的版本要求
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>cmake_minimum_required</span><span class=p>(</span><span class=s>VERSION</span> <span class=s>3.9</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 设置项目名称
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>project</span><span class=p>(</span><span class=s>CMAKE_VARIABLES</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 本地变量
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>set</span><span class=p>(</span><span class=s>LOCAL_VAR</span> <span class=s2>&#34;value&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>set</span><span class=p>(</span><span class=s>LOCAL_LIST</span> <span class=s2>&#34;value1&#34;</span> <span class=s2>&#34;value2&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>message</span><span class=p>(</span><span class=s2>&#34;LOCAL_VAR is ${LOCAL_VAR}, LOCAL_LIST is ${LOCAL_LIST}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 缓存变量
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>set</span><span class=p>(</span><span class=s>CACHE_VAR_BOOL</span> <span class=s>ON</span> <span class=s>CACHE</span> <span class=s>BOOL</span> <span class=s2>&#34;this is a bool cache variable&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>set</span><span class=p>(</span><span class=s>CACHE_VAR_STRING</span> <span class=s2>&#34;cache value&#34;</span> <span class=s>CACHE</span> <span class=s>STRING</span> <span class=s2>&#34;this is a string variable&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>message</span><span class=p>(</span><span class=s2>&#34;CACHE_VAR_BOOL is ${CACHE_VAR_BOOL}, CACHE_VAR_STRING is ${CACHE_VAR_STRING}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 环境变量
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>message</span><span class=p>(</span><span class=s2>&#34;My PC shell is $ENV{SHELL}&#34;</span><span class=p>)</span><span class=err>
</span></span></span></code></pre></div><p>在<code>CMakeLists.txt</code>所在的目录下运行<code>cmake -B build</code>得到</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>-- The C compiler identification is AppleClang 16.0.0.16000026
</span></span><span class=line><span class=cl>-- The CXX compiler identification is AppleClang 16.0.0.16000026
</span></span><span class=line><span class=cl>-- Detecting C compiler ABI info
</span></span><span class=line><span class=cl>-- Detecting C compiler ABI info - done
</span></span><span class=line><span class=cl>-- Check for working C compiler: /Library/Developer/CommandLineTools/usr/bin/cc - skipped
</span></span><span class=line><span class=cl>-- Detecting C compile features
</span></span><span class=line><span class=cl>-- Detecting C compile features - done
</span></span><span class=line><span class=cl>-- Detecting CXX compiler ABI info
</span></span><span class=line><span class=cl>-- Detecting CXX compiler ABI info - done
</span></span><span class=line><span class=cl>-- Check for working CXX compiler: /Library/Developer/CommandLineTools/usr/bin/c++ - skipped
</span></span><span class=line><span class=cl>-- Detecting CXX compile features
</span></span><span class=line><span class=cl>-- Detecting CXX compile features - done
</span></span><span class=line><span class=cl>LOCAL_VAR is value, LOCAL_LIST is value1;value2
</span></span><span class=line><span class=cl>CACHE_VAR_BOOL is ON, CACHE_VAR_STRING is cache value
</span></span><span class=line><span class=cl>My PC shell is /bin/zsh
</span></span><span class=line><span class=cl>-- Configuring done (0.4s)
</span></span><span class=line><span class=cl>-- Generating done (0.0s)
</span></span><span class=line><span class=cl>-- Build files have been written to: /Users/delkon/Desktop/UniversityWork/Year4/CMake_Art/advanced_process/cmake_var/build
</span></span></code></pre></div><p>修改<code>LOCAL_VAR</code>为<code>changes value</code>，<code>CACHE_VAR_BOOL</code>为<code>OFF</code>，再次运行<code>cmake -B build</code>得到</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>LOCAL_VAR is changes value, LOCAL_LIST is value1;value2
</span></span><span class=line><span class=cl>CACHE_VAR_BOOL is ON, CACHE_VAR_STRING is cache value
</span></span><span class=line><span class=cl>My PC shell is /bin/zsh
</span></span><span class=line><span class=cl>-- Configuring done (0.0s)
</span></span><span class=line><span class=cl>-- Generating done (0.0s)
</span></span><span class=line><span class=cl>-- Build files have been written to: /Users/delkon/Desktop/UniversityWork/Year4/CMake_Art/advanced_process/cmake_var/build
</span></span></code></pre></div><p>可以看到<code>LOCAL_VAR</code>被改变了，但是<code>CACHE_VAR_BOOL</code>由于在<code>./build/CMakeCache.txt</code>被缓存所以没有发生改变。</p><h3 id=cmake运行其他的程序>CMake运行其他的程序<a hidden class=anchor aria-hidden=true href=#cmake运行其他的程序>#</a></h3><h4 id=find_package><code>find_package()</code><a hidden class=anchor aria-hidden=true href=#find_package>#</a></h4><p><code>find_package()</code>是 CMake 中用于查找外部库或包的命令，有两种查找外部库或包的模式：</p><ul><li><strong>Config 模式</strong>：通过包自带的配置文件（如 &lt;package_name>Config.cmake 或 &lt;package_name>-config.cmake）查找库。现代 CMake 项目通常提供这些配置文件。</li><li><strong>Module 模式</strong>：通过 CMake 自带的查找模块（如 Find&lt;package_name>.cmake）来查找库。早期的 CMake 使用这种方式查找库。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=nb>find_package</span><span class=p>(</span><span class=s>&lt;package_name&gt;</span> <span class=s>[version]</span> <span class=s>[REQUIRED]</span> <span class=s>[QUIET]</span> <span class=s>[COMPONENTS</span> <span class=s>components]</span> <span class=s>[OPTIONAL_COMPONENTS</span> <span class=s>components]</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>参数：
</span></span></span><span class=line><span class=cl><span class=err>&lt;package_name&gt;</span> <span class=err>：要查找包的名称。
</span></span></span><span class=line><span class=cl><span class=err>[version]</span> <span class=err>：指定包的最低版本号（可选）。如果不指定版本号，将查找任意版本的包。
</span></span></span><span class=line><span class=cl><span class=err>[REQUIRED]</span> <span class=err>：如果包未找到，则立即停止并给出错误。如果不加</span> <span class=err>REQUIRED，则会继续执行脚本，即使找不到该包。
</span></span></span><span class=line><span class=cl><span class=err>[QUIET]</span> <span class=err>：抑制输出，即使找不到包也不显示消息。
</span></span></span><span class=line><span class=cl><span class=err>[COMPONENTS</span> <span class=err>components]</span> <span class=err>：指定包的特定组件，只有这些组件会被查找。用于包含多个模块的包。
</span></span></span><span class=line><span class=cl><span class=err>[OPTIONAL_COMPONENTS</span> <span class=err>components]</span> <span class=err>：指定一些可选的组件，如果没有找到这些组件，不会影响主要构建过程。
</span></span></span><span class=line><span class=cl><span class=err>--------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=err>查找结果：
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>&lt;package_name&gt;_FOUND：是否找到包。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>&lt;package_name&gt;_INCLUDE_DIRS：包的头文件路径。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>&lt;package_name&gt;_LIBRARIES：包的库文件路径。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>&lt;package_name&gt;_VERSION：找到的包的版本号。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>&lt;package_name&gt;_EXECUTABLE</span> <span class=err>：可执行文件的路径。
</span></span></span></code></pre></div><p>有时自己的笔记本上有好几个命名相同但版本不同的包，<code>find_package()</code>找到的包和自己预期的路径不太一样，这是我们可以显式地指定<code>&lt;package_name>_EXECUTABLE</code>内容，这样就可以索引到我们想要的包啦。</p><p>该测试对应的源代码所在目录详见<a href=https://github.com/fordelkon/cmake_tutorial/tree/main/advanced_process/third_package>https://github.com/fordelkon/cmake_tutorial/tree/main/advanced_process/third_package</a>。相关的测试<code>CMakeLists.txt</code>文件如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=c># 指定最小Cmake的版本要求
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>cmake_minimum_required</span><span class=p>(</span><span class=s>VERSION</span> <span class=s>3.9</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 设置项目名称
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>project</span><span class=p>(</span><span class=s>THIRD_PACKAGE</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>set</span><span class=p>(</span><span class=s>FLAG</span> <span class=s>OFF</span><span class=p>)</span> <span class=c># or ON
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>FLAG</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>find_package</span><span class=p>(</span><span class=s>Python</span> <span class=s>REQUIRED</span> <span class=s>COMPONENTS</span> <span class=s>Interpreter</span> <span class=s>Development</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>Python_FOUND</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s2>&#34;Package include directory is ${Python_INCLUDE_DIRS}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s2>&#34;Package library is ${Python_LIBRARIES}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s2>&#34;Package version is ${Python_VERSION}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s2>&#34;Package executable file path is ${Python_EXECUTABLE}&#34;</span><span class=p>)</span>    <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>set</span><span class=p>(</span><span class=s>Python_EXECUTABLE</span> <span class=s2>&#34;$ENV{CONDA_PYTHON_EXE}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>find_package</span><span class=p>(</span><span class=s>Python</span> <span class=s>REQUIRED</span> <span class=s>COMPONENTS</span> <span class=s>Interpreter</span> <span class=s>Development</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>Python_FOUND</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s2>&#34;Package include directory is ${Python_INCLUDE_DIRS}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s2>&#34;Package library is ${Python_LIBRARIES}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s2>&#34;Package version is ${Python_VERSION}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s2>&#34;Package executable file path is ${Python_EXECUTABLE}&#34;</span><span class=p>)</span>    <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span></code></pre></div><p>当<code>FLAG</code>为<code>ON</code>时，得到</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>....................................前面省略......................................
</span></span><span class=line><span class=cl>-- Found Python: /opt/homebrew/Frameworks/Python.framework/Versions/3.13/bin/python3.13 (found version &#34;3.13.0&#34;) found components: Interpreter Development Development.Module Development.Embed
</span></span><span class=line><span class=cl>Package include directory is /opt/homebrew/opt/python@3.13/Frameworks/Python.framework/Versions/3.13/include/python3.13
</span></span><span class=line><span class=cl>Package library is /opt/homebrew/opt/python@3.13/Frameworks/Python.framework/Versions/3.13/lib/libpython3.13.dylib
</span></span><span class=line><span class=cl>Package version is 3.13.0
</span></span><span class=line><span class=cl>Package executable file path is /opt/homebrew/Frameworks/Python.framework/Versions/3.13/bin/python3.13
</span></span><span class=line><span class=cl>....................................后面省略......................................
</span></span></code></pre></div><p>这并不是我们想要的包的路径，通过设定<code>FLAG</code>为<code>OFF</code>，显式地指定<code>&lt;package_name>_EXECUTABLE</code>为我们所要的包的可执行文件的内容，运行结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>....................................前面省略......................................
</span></span><span class=line><span class=cl>-- Found Python: /Users/delkon/miniconda3/bin/python (found version &#34;3.10.13&#34;) found components: Interpreter Development Development.Module Development.Embed
</span></span><span class=line><span class=cl>Package include directory is /Users/delkon/miniconda3/include/python3.10
</span></span><span class=line><span class=cl>Package library is /Users/delkon/miniconda3/lib/libpython3.10.dylib
</span></span><span class=line><span class=cl>Package version is 3.10.13
</span></span><span class=line><span class=cl>Package executable file path is /Users/delkon/miniconda3/bin/python
</span></span><span class=line><span class=cl>....................................后面省略......................................
</span></span></code></pre></div><p>达到了我们的目的。</p><h4 id=配置时运行execute_process>配置时运行：<code>execute_process()</code><a hidden class=anchor aria-hidden=true href=#配置时运行execute_process>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=nb>execute_process</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>COMMAND</span> <span class=s>&lt;cmd&gt;</span> <span class=s>[args...]</span>
</span></span><span class=line><span class=cl>    <span class=s>[WORKING_DIRECTORY</span> <span class=s>&lt;dir&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=s>[TIMEOUT</span> <span class=s>&lt;seconds&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=s>[RESULT_VARIABLE</span> <span class=s>&lt;var&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=s>[OUTPUT_VARIABLE</span> <span class=s>&lt;var&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=s>[ERROR_VARIABLE</span> <span class=s>&lt;var&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=s>[INPUT_FILE</span> <span class=s>&lt;file&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=s>[OUTPUT_FILE</span> <span class=s>&lt;file&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=s>[ERROR_FILE</span> <span class=s>&lt;file&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=s>[INPUT_FILE</span> <span class=s>&lt;file&gt;]</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>参数：
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>COMMAND</span> <span class=err>&lt;cmd&gt;</span> <span class=err>[args...]</span> <span class=err>：指定要执行的命令及其参数。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>WORKING_DIRECTORY</span> <span class=err>&lt;dir&gt;</span> <span class=err>：设置命令执行时的工作目录。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>TIMEOUT</span> <span class=err>&lt;seconds&gt;</span> <span class=err>：设置命令执行的超时时间（秒）。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>RESULT_VARIABLE</span> <span class=err>&lt;var&gt;</span> <span class=err>：命令执行后的返回值会被存储在</span> <span class=err>&lt;var&gt;</span> <span class=err>变量中。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>OUTPUT_VARIABLE</span> <span class=err>&lt;var&gt;</span> <span class=err>：命令标准输出的内容会被存储在</span> <span class=err>&lt;var&gt;</span> <span class=err>变量中。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>ERROR_VARIABLE</span> <span class=err>&lt;var&gt;</span> <span class=err>：命令标准错误的内容会被存储在</span> <span class=err>&lt;var&gt;</span> <span class=err>变量中。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>INPUT_FILE</span> <span class=err>&lt;file&gt;：将文件的内容作为输入传递给命令。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>OUTPUT_FILE</span> <span class=err>&lt;file&gt;：将命令的输出保存到指定的文件中。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>ERROR_FILE</span> <span class=err>&lt;file&gt;：将命令的错误信息保存到指定的文件中。
</span></span></span></code></pre></div><p><code>execute_process()</code>是 CMake 中的一个命令，通常用于在 CMake 配置期间调用外部程序或脚本。该测试对应的源代码所在目录详见<a href=https://github.com/fordelkon/cmake_tutorial/tree/main/advanced_process/run_cmd>https://github.com/fordelkon/cmake_tutorial/tree/main/advanced_process/run_cmd</a>。其<code>CMakeLists.txt</code>测试文件如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=c># 指定最小Cmake的版本要求
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>cmake_minimum_required</span><span class=p>(</span><span class=s>VERSION</span> <span class=s>3.9</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 设置项目名称
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>project</span><span class=p>(</span><span class=s>THIRD_PACKAGE</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>execute_process</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>COMMAND</span> <span class=s>ls</span>
</span></span><span class=line><span class=cl>    <span class=s>WORKING_DIRECTORY</span> <span class=o>${</span><span class=nv>CMAKE_SOURCE_DIR</span><span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=s>OUTPUT_VARIABLE</span> <span class=s>ls_output</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>message</span><span class=p>(</span><span class=s2>&#34;Directory ${CMAKE_SOURCE_DIR} listing: ${ls_output}&#34;</span><span class=p>)</span><span class=err>
</span></span></span></code></pre></div><p>运行结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>....................................前面省略......................................
</span></span><span class=line><span class=cl>Directory /Users/delkon/Desktop/UniversityWork/Year4/CMake_Art/advanced_process/run_cmd listing: CMakeLists.txt
</span></span><span class=line><span class=cl>build
</span></span><span class=line><span class=cl>....................................后面省略......................................
</span></span></code></pre></div><h3 id=构建时运行add_custom_command了解一下不常用>构建时运行<code>add_custom_command()</code>（了解一下，不常用）<a hidden class=anchor aria-hidden=true href=#构建时运行add_custom_command了解一下不常用>#</a></h3><p>在构建时运行一条命令有点难。主要是目标系统（target system）使这变的很难，因此这条命令并不常用，所以我们了解该命令一下就可以了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=nb>add_custom_command</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>OUTPUT</span> <span class=s>&lt;out1&gt;</span> <span class=s>[&lt;out2&gt;</span> <span class=s>...]</span>
</span></span><span class=line><span class=cl>    <span class=s>COMMAND</span> <span class=s>&lt;cmd&gt;</span> <span class=s>[args...]</span>
</span></span><span class=line><span class=cl>    <span class=s>[MAIN_DEPENDENCY</span> <span class=s>&lt;main_dep&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=s>[DEPENDS</span> <span class=s>[&lt;dep&gt;</span> <span class=s>...]]</span>
</span></span><span class=line><span class=cl>    <span class=s>[BYPRODUCTS</span> <span class=s>&lt;bypro1&gt;</span> <span class=s>[&lt;bypro2&gt;</span> <span class=s>...]]</span>
</span></span><span class=line><span class=cl>    <span class=s>[IMPLICIT_DEPENDS</span> <span class=s>&lt;lang1&gt;</span> <span class=s>&lt;src1&gt;</span> <span class=s>...]</span>
</span></span><span class=line><span class=cl>    <span class=s>[WORKING_DIRECTORY</span> <span class=s>&lt;dir&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=s>[COMMENT</span> <span class=s>&lt;comment&gt;]</span>
</span></span><span class=line><span class=cl>    <span class=s>[VERBATIM]</span> 
</span></span><span class=line><span class=cl>    <span class=s>[APPEND]</span>
</span></span><span class=line><span class=cl>    <span class=s>[USES_TERMINAL]</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>参数：
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>OUTPUT</span> <span class=err>&lt;out1&gt;</span> <span class=err>[&lt;out2&gt;</span> <span class=err>...]</span> <span class=err>：指定自定义命令生成的文件或目标。这些文件将被</span> <span class=err>CMake</span> <span class=err>视为构建过程的输出，并且可以作为其他目标或命令的输入。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>COMMAND</span> <span class=err>&lt;cmd&gt;</span> <span class=err>[args...]</span> <span class=err>：指定执行的命令及其参数。在构建过程中，CMake</span> <span class=err>将执行此命令。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>[MAIN_DEPENDENCY</span> <span class=err>&lt;main_dep&gt;]</span> <span class=err>：定义该命令的主要依赖文件，通常是触发自定义命令的源文件。如果这个文件发生变化，CMake</span> <span class=err>将重新执行命令。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>[DEPENDS</span> <span class=err>[&lt;dep&gt;</span> <span class=err>...]]</span> <span class=err>： 列出该命令依赖的文件或目标。如果依赖项发生变化，CMake</span> <span class=err>会重新执行此命令。可以依赖于文件、库或其他目标。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>[BYPRODUCTS</span> <span class=err>&lt;bypro1&gt;</span> <span class=err>[&lt;bypro2&gt;</span> <span class=err>...]]</span> <span class=err>：指定该命令执行后生成的副产品文件，帮助</span> <span class=err>CMake</span> <span class=err>跟踪这些额外产生的文件。这些文件在命令执行过程中创建，但不会作为主要输出。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>[IMPLICIT_DEPENDS</span> <span class=err>&lt;lang1&gt;</span> <span class=err>&lt;src1&gt;</span> <span class=err>...]</span> <span class=err>：指定命令的隐式依赖关系，通常是源文件的语言和路径，CMake</span> <span class=err>可以自动追踪这些文件的依赖关系。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>[WORKING_DIRECTORY</span> <span class=err>&lt;dir&gt;]</span> <span class=err>：指定命令执行时的工作目录。命令在这个目录中运行，适用于需要在特定目录下执行的命令。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>[COMMENT</span> <span class=err>&lt;comment&gt;]</span> <span class=err>：在构建时，显示在命令执行之前的注释。可以用于提示用户正在执行的操作。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>[VERBATIM]</span> <span class=err>：确保命令的参数在生成的构建文件中被精确传递，而不会因为转义字符或特殊符号发生不必要的修改。通常推荐使用这个选项。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>[APPEND]</span> <span class=err>：将命令追加到已有的自定义命令中，而不是覆盖它。多个自定义命令可以依次执行。
</span></span></span><span class=line><span class=cl><span class=err>-</span> <span class=err>[USES_TERMINAL]</span> <span class=err>：指定命令需要在终端中执行。对于交互式命令（例如，需要用户输入的命令），这个选项很有用。
</span></span></span></code></pre></div><h3 id=控制流>控制流<a hidden class=anchor aria-hidden=true href=#控制流>#</a></h3><h4 id=配置时评估的控制流if语句>配置时评估的控制流：<code>if()</code>语句<a hidden class=anchor aria-hidden=true href=#配置时评估的控制流if语句>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=nb>if</span><span class=p>(</span><span class=s>variable</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=c># 如果variable是`ON`, `YES`, `TRUE`, `Y`或者任意非零值
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=c># 如果variable是`0`, `OFF`, `NO`, `FALSE`, `N`, `IGNORE`, `NOTFOUND`, `&#34;&#34;`或者以`-NOTFOUND`结尾
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 如果variable没有扩展为上述之一，CMake 将扩展它，然后再次尝试。
</span></span></span></code></pre></div><p>这里可以设置一些关键字：</p><table><thead><tr><th><strong>分组</strong></th><th><strong>关键字</strong></th><th><strong>功能</strong></th></tr></thead><tbody><tr><td><strong>一元运算符</strong></td><td>NOT</td><td>取反运算，条件为假时返回真。</td></tr><tr><td><strong>一元运算符</strong></td><td>DEFINED</td><td>检查变量是否已经定义。</td></tr><tr><td><strong>一元运算符</strong></td><td>DEFINED</td><td>判断文件或目录是否存在。</td></tr><tr><td><strong>一元运算符</strong></td><td>COMMAND</td><td>判断命令是否存在。</td></tr><tr><td><strong>一元运算符</strong></td><td>POLICY</td><td>判断 CMake 策略是否定义。</td></tr><tr><td><strong>一元运算符</strong></td><td>TARGET</td><td>判断指定的目标是否存在。</td></tr><tr><td><strong>二元运算符</strong></td><td>AND                    </td><td>逻辑与运算，所有条件为真时结果才为真。</td></tr><tr><td><strong>二元运算符</strong></td><td>OR</td><td>逻辑或运算，只要有一个条件为真，结果就为真。</td></tr><tr><td><strong>二元运算符</strong></td><td>EQUAL</td><td>判断两个数值是否相等。</td></tr><tr><td><strong>二元运算符</strong></td><td>LESS</td><td>判断左侧数是否小于右侧数。</td></tr><tr><td><strong>二元运算符</strong></td><td>GREATER</td><td>判断左侧数是否大于右侧数。</td></tr><tr><td><strong>二元运算符</strong></td><td>LESS_EQUAL</td><td>判断左侧数是否小于等于右侧数。</td></tr><tr><td><strong>二元运算符</strong></td><td>GREATER_EQUAL</td><td>判断左侧数是否大于等于右侧数。</td></tr><tr><td><strong>二元运算符</strong></td><td>STREQUAL</td><td>判断两个字符串是否相等。</td></tr><tr><td><strong>二元运算符</strong></td><td>STRLESS</td><td>判断左侧字符串是否小于右侧字符串（字典序）。</td></tr><tr><td><strong>二元运算符</strong></td><td>STRGREATER</td><td>判断左侧字符串是否大于右侧字符串（字典序）。</td></tr><tr><td><strong>二元运算符</strong></td><td>MATCHES</td><td>判断字符串是否匹配指定的正则表达式。</td></tr><tr><td><strong>二元运算符</strong></td><td>VERSION_LESS</td><td>判断左侧版本号是否小于右侧版本号。</td></tr><tr><td><strong>二元运算符</strong></td><td>VERSION_EQUAL</td><td>判断两个版本号是否相等。</td></tr><tr><td><strong>二元运算符</strong></td><td>VERSION_GREATER</td><td>判断左侧版本号是否大于右侧版本号。</td></tr></tbody></table><h4 id=构建时评估的控制流generator-expressions>构建时评估的控制流：<code>generator-expressions</code><a hidden class=anchor aria-hidden=true href=#构建时评估的控制流generator-expressions>#</a></h4><p><strong>生成器表达式</strong>（<code>generator-expressions</code>，简称为<code>genex</code>）是一种用于在构建生成阶段动态评估和控制行为的强大工具。<code>generator-expression</code>通常用于目标属性（例如编译选项、链接选项等），在项目的生成和构建阶段根据具体的构建配置（如 Debug 或 Release）动态调整行为。</p><p><code>generator-expression</code>基本语法</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=err>$&lt;CONDITION:arg1,arg2,...&gt;
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># CONDITION 表示表达式类型，arg1, arg2, ... 是传递给条件的参数。
</span></span></span></code></pre></div><ul><li>配置相关的<code>generator-expression</code></li></ul><table><thead><tr><th><strong>表达式</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><code>$&lt;CONFIG:config></code></td><td>如果当前构建配置为 config，则返回真。</td><td><code>$&lt;CONFIG:Debug></code>：在 Debug 配置中为真。</td></tr><tr><td><code>$&lt;NOT:$&lt;CONFIG:config>></code></td><td>如果当前构建配置不是 config，则返回真。</td><td><code>$&lt;NOT:$&lt;CONFIG:Release>></code>：在 Release 配置中为假，其他配置为真。</td></tr><tr><td><code>$&lt;CONFIGURATION></code></td><td>返回当前的构建配置（Debug、Release、RelWithDebInfo 等）。</td><td>target_link_libraries(my_target PRIVATE <code>$&lt;CONFIGURATION></code>)</td></tr></tbody></table><ul><li>逻辑相关的<code>generator-expression</code></li></ul><table><thead><tr><th><strong>表达式</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><code>$&lt;AND:condition1,condition2></code></td><td>如果 condition1 和 condition2 都为真，则返回真。</td><td><code>$&lt;AND:$&lt;CONFIG:Debug>,$&lt;STREQUAL:WIN32>></code>：同时为 Debug 配置和 Windows 平台时为真。</td></tr><tr><td><code>$&lt;OR:condition1,condition2></code></td><td>如果 condition1 或 condition2 为真，则返回真。</td><td><code>$&lt;OR:$&lt;CONFIG:Debug>,$&lt;STREQUAL:WIN32>></code>：是 Debug 或 Windows 时为真。</td></tr><tr><td><code>$&lt;NOT:condition></code></td><td>如果 condition 为假，则返回真。</td><td><code>$&lt;NOT:$&lt;CONFIG:Release>></code>：如果不是 Release 配置则为真。</td></tr><tr><td><code>$&lt;BOOL:expression></code></td><td>将表达式 expression 转换为布尔值，0 为假，其他为真。</td><td><code>$&lt;BOOL:1></code>：返回真。</td></tr></tbody></table><ul><li>平台和编译器相关的<code>generator-expression</code></li></ul><table><thead><tr><th><strong>表达式</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><code>$&lt;PLATFORM_ID:platform></code></td><td>如果当前平台是 platform，则返回真。</td><td><code>$&lt;PLATFORM_ID:Windows></code>：当前平台为 Windows 时为真。</td></tr><tr><td><code>$&lt;STREQUAL:string1,string2></code></td><td>如果 string1 和 string2 相等，则返回真。</td><td><code>$&lt;STREQUAL:APPLE,$&lt;PLATFORM_ID:Darwin>></code>：苹果平台为真。</td></tr></tbody></table><ul><li>目标生成相关的<code>generator-expression</code></li></ul><table><thead><tr><th><strong>表达式</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><code>$&lt;TARGET_EXISTS:tgt></code></td><td>如果目标 tgt 存在，返回真。</td><td><code>$&lt;TARGET_EXISTS:my_target></code>：目标 my_target 存在时返回真。</td></tr><tr><td><code>$&lt;TARGET_PROPERTY:tgt,prop></code></td><td>返回目标 tgt 的属性 prop 的值。</td><td><code>$&lt;TARGET_PROPERTY:my_target,INTERFACE_INCLUDE_DIRECTORIES></code>返回目标my_target的属性INTERFACE_INCLUDE_DIRECTORIES 的值。</td></tr></tbody></table><ul><li>版本相关的<code>generator-expression</code></li></ul><table><thead><tr><th><strong>表达式</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><code>$&lt;VERSION_GREATER:v1,v2></code></td><td>如果版本 v1 大于 v2，则返回真。</td><td><code>$&lt;VERSION_GREATER:3.20,3.10></code>：返回真，因为 3.20 > 3.10。</td></tr><tr><td><code>$&lt;VERSION_EQUAL:v1,v2></code></td><td>如果版本 v1 和 v2 相等，则返回真。</td><td><code>$&lt;VERSION_EQUAL:3.10,3.10></code>：返回真。</td></tr></tbody></table><ul><li>文件和路径操作<code>generator-expression</code></li></ul><table><thead><tr><th><strong>表达式</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><code>$&lt;TARGET_FILE:tgt></code></td><td>返回目标 tgt 的生成文件完整路径。</td><td><code>$&lt;TARGET_FILE:my_target></code>：获取 my_target 目标的生成文件路径。</td></tr><tr><td><code>$&lt;TARGET_LINKER_FILE:tgt></code></td><td>返回目标 tgt 的链接器文件路径（通常是 .lib 或 .dll 文件）。</td><td><code>$&lt;TARGET_LINKER_FILE:my_target></code>：获取 my_target 目标的链接文件。</td></tr></tbody></table><h3 id=cmake配置文件confighin>CMake配置文件：<code>config.h.in</code><a hidden class=anchor aria-hidden=true href=#cmake配置文件confighin>#</a></h3><ul><li>生成供源文件读取的.h头文件：<code>configure_file()</code></li><li>从源文件中读取一些变量：<code>file()</code></li></ul><h2 id=整体性示例c代码迁移python>整体性示例：<code>C++代码迁移Python</code><a hidden class=anchor aria-hidden=true href=#整体性示例c代码迁移python>#</a></h2><p>该项目对应的源代码所在目录详见<a href=https://github.com/fordelkon/cmake_tutorial/tree/main/advanced_process/cxx_python>https://github.com/fordelkon/cmake_tutorial/tree/main/advanced_process/cxx_python</a>。该项目的<code>CMakeLists.txt</code>内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=nb>cmake_minimum_required</span><span class=p>(</span><span class=s>VERSION</span> <span class=s>3.9</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>project</span><span class=p>(</span><span class=s>CPy</span> <span class=s>VERSION</span> <span class=s>0.1</span> <span class=s>DESCRIPTION</span> <span class=s2>&#34;Little C to Python Program&#34;</span> <span class=s>LANGUAGES</span> <span class=s>CXX</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 自定义我想要的包的路径：位于Conda环境下的Python可执行文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>set</span><span class=p>(</span><span class=s>Python_EXECUTABLE</span> <span class=s2>&#34;$ENV{CONDA_PYTHON_EXE}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 查找Python解释器以及调试工具组件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>find_package</span><span class=p>(</span><span class=s>Python</span> <span class=s>REQUIRED</span> <span class=s>COMPONENTS</span> <span class=s>Interpreter</span> <span class=s>Development</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>Python_FOUND</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>message</span><span class=p>(</span><span class=s2>&#34;Python Found at ${Python_INCLUDE_DIRS}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=c># 从Conda环境下的Python查找pybind11路径
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nb>execute_process</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s>COMMAND</span> <span class=s2>&#34;${Python_EXECUTABLE}&#34;</span> <span class=s>-m</span> <span class=s>pybind11</span> <span class=s>--cmakedir</span> 
</span></span><span class=line><span class=cl>        <span class=s>RESULT_VARIABLE</span> <span class=s>__pybind_exit_code</span> 
</span></span><span class=line><span class=cl>        <span class=s>OUTPUT_VARIABLE</span> <span class=s>__pybind_path</span> 
</span></span><span class=line><span class=cl>        <span class=s>OUTPUT_STRIP_TRAILING_WHITESPACE</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>__pybind_exit_code</span> <span class=s>EQUAL</span> <span class=s>0</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>set</span><span class=p>(</span><span class=s>pybind11_DIR</span> <span class=o>${</span><span class=nv>__pybind_path</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>find_package</span><span class=p>(</span><span class=s>pybind11</span> <span class=s>REQUIRED</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s2>&#34;pybind11 Found at ${pybind11_INCLUDE_DIRS}&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=c># 创建编译选项接口库
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=nb>add_library</span><span class=p>(</span><span class=s>compiler_flags</span> <span class=s>INTERFACE</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_compile_features</span><span class=p>(</span><span class=s>compiler_flags</span> <span class=s>INTERFACE</span> <span class=s>cxx_std_11</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=c># 添加优化选项
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=nb>if</span><span class=p>(</span><span class=s>NOT</span> <span class=s>MSVC</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=nb>target_compile_options</span><span class=p>(</span><span class=s>compiler_flags</span> <span class=s>INTERFACE</span> 
</span></span><span class=line><span class=cl>                <span class=s>-O2</span> 
</span></span><span class=line><span class=cl>                <span class=s>-march=native</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=nb>target_compile_options</span><span class=p>(</span><span class=s>compiler_flags</span> <span class=s>INTERFACE</span> 
</span></span><span class=line><span class=cl>                <span class=s>/O2</span>
</span></span><span class=line><span class=cl>                <span class=s>/arch:AVX2</span>  <span class=c># 对应于 -march=native
</span></span></span><span class=line><span class=cl><span class=c></span>            <span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=c>##################
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=c>#######CPU########
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=c>##################
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=nb>add_library</span><span class=p>(</span><span class=s>ndarray_backend_cpu</span> <span class=s>MODULE</span> <span class=s>src/ndarray_backend_cpu.cc</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_include_directories</span><span class=p>(</span><span class=s>ndarray_backend_cpu</span> 
</span></span><span class=line><span class=cl>            <span class=s>PRIVATE</span> 
</span></span><span class=line><span class=cl>                <span class=o>${</span><span class=nv>Python_INCLUDE_DIRS</span><span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>${</span><span class=nv>pybind11_INCLUDE_DIRS</span><span class=o>}</span> 
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>target_link_libraries</span><span class=p>(</span><span class=s>ndarray_backend_cpu</span> 
</span></span><span class=line><span class=cl>            <span class=s>PUBLIC</span> 
</span></span><span class=line><span class=cl>                <span class=o>${</span><span class=nv>pybind11_LIBRARIES</span><span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=s>compiler_flags</span>  <span class=c># 链接编译选项接口库
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>pybind11_extension</span><span class=p>(</span><span class=s>ndarray_backend_cpu</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>pybind11_strip</span><span class=p>(</span><span class=s>ndarray_backend_cpu</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=c># 输出编译文件
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=nb>set_target_properties</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s>ndarray_backend_cpu</span>
</span></span><span class=line><span class=cl>            <span class=s>PROPERTIES</span> 
</span></span><span class=line><span class=cl>                <span class=s>LIBRARY_OUTPUT_DIRECTORY</span> <span class=o>${</span><span class=nv>CMAKE_CURRENT_SOURCE_DIR</span><span class=o>}</span><span class=s>/needle/backend_ndarray</span>
</span></span><span class=line><span class=cl>                <span class=s>CXX_VISIBILITY_PRESET</span> <span class=s2>&#34;hidden&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>if</span><span class=p>(</span><span class=o>${</span><span class=nv>CMAKE_SYSTEM_NAME</span><span class=o>}</span> <span class=s>MATCHES</span> <span class=s2>&#34;Darwin&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=nb>set_property</span><span class=p>(</span><span class=s>TARGET</span> <span class=s>ndarray_backend_cpu</span> <span class=s>PROPERTY</span> <span class=s>LINK_OPTIONS</span> <span class=s>-undefined</span> <span class=s>dynamic_lookup</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>message</span><span class=p>(</span><span class=s>FATAL_ERROR</span> <span class=s2>&#34;Could not find pybind11 in the Python environment!!!&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>else</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>message</span><span class=p>(</span><span class=s>FATAL_ERROR</span> <span class=s2>&#34;Could not find Python from Miniconda!!!&#34;</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span></code></pre></div><p>我们可以看到CMakeLists.txt中的基本上与构建过程相关的任务皆为目标（<code>Everything is a target</code>)，接口库<code>compiler_flags</code>是目标（该目标被要求使用 <strong>C++11 标准</strong>，后面又为其设定了编译选项），编译<code>src/ndarray_backend_cpu.cc</code>而形成的库文件<code>ndarray_backend_cpu</code>也是目标，而这些变量都与构建过程高度相关。</p><h3 id=everything-is-a-target><code>Everything is a target</code><a hidden class=anchor aria-hidden=true href=#everything-is-a-target>#</a></h3><h4 id=目标类型>目标类型<a hidden class=anchor aria-hidden=true href=#目标类型>#</a></h4><ul><li><strong>可执行文件</strong>：通常使用 add_executable 来创建。</li><li><strong>库文件</strong>：通常使用 add_library 来创建，也可以从已有package中查找。</li><li><strong>自定义命令</strong>：使用 add_custom_target 或 add_custom_command 创建。</li></ul><h4 id=目标依赖关系>目标依赖关系<a hidden class=anchor aria-hidden=true href=#目标依赖关系>#</a></h4><ul><li><strong>指定依赖关系</strong>：使用target_link_library来制定依赖关系。</li></ul><h4 id=目标属性>目标属性<a hidden class=anchor aria-hidden=true href=#目标属性>#</a></h4><ul><li><strong>设定目标属性</strong>：target_* 系列命令来为目标设置一系列的属性。常用的有target_compile_features，target_include_directories，target_compile_options&mldr;</li></ul><p>我们也可以配置Makefile文件来使得先<code>cmake -B build</code>生成构建系统文件然后再运行<code>cmake --build build</code>来执行构建操作（编译）使用<code>make</code>命令一步完成。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>lib</span><span class=p>,</span> <span class=n>pybind</span><span class=p>,</span> <span class=n>clean</span><span class=p>,</span> <span class=n>format</span><span class=p>,</span> <span class=n>all</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=n>lib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>lib</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	cmake -B build
</span></span><span class=line><span class=cl>	cmake --build build
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>format</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	python3 -m black .
</span></span><span class=line><span class=cl>	clang-format -i src/*.cc src/*.cu
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	rm -rf build needle/backend_ndarray/ndarray_backend*.so
</span></span></code></pre></div><ul><li><code>.PHONY</code>是 Makefile 中的一个特殊目标，用来声明目标不生成与其名字相同的文件。</li><li><code>all</code>目标表示一次性执行多个任务。在该文件中执行<code>make all (make)</code>和<code>make lib</code>等效</li><li><code>format</code>目标目的是格式化代码。</li><li><code>clean</code>目标用于清理构建生成的文件。</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://fordelkon.github.io/tags/c-plus-plus/>C-Plus-Plus</a></li><li><a href=https://fordelkon.github.io/tags/cmake/>CMake</a></li></ul><nav class=paginav><a class=prev href=https://fordelkon.github.io/teaching/probdis/><span class=title>« Prev</span><br><span>深度学习中常用的概率分布总结</span>
</a><a class=next href=https://fordelkon.github.io/posts/cmake_intro_1/><span class=title>Next »</span><br><span>使用CMake的艺术1</span></a></nav></footer><div class=giscus_comments><script src=https://giscus.app/client.js data-repo=jesse-wei/jessewei.dev-PaperMod data-repo-id=R_kgDOJhJgPg data-category=Comments data-category-id=DIC_kwDOJhJgPs4CWei3 data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div><script async>document.querySelector("div.giscus_comments > script").setAttribute("data-theme",localStorage.getItem("pref-theme")?localStorage.getItem("pref-theme"):window.matchMedia("(prefers-color-scheme: dark)").matches?"transparent_dark":"light"),document.querySelector("#theme-toggle").addEventListener("click",()=>{let e=document.querySelector("iframe.giscus-frame");e&&e.contentWindow.postMessage({giscus:{setConfig:{theme:localStorage.getItem("pref-theme")?localStorage.getItem("pref-theme")==="dark"?"light":"transparent_dark":document.body.className.includes("dark")?"light":"transparent_dark"}}},"https://giscus.app")})</script></article></main><footer class=footer style=padding-top:18px;padding-bottom:18px><div class=social-icons style=padding-bottom:0><a style=border-bottom:none href=https://github.com/fordelkon rel=me title=Github><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a style=border-bottom:none href=https://x.com/fordelkon rel=me title=Twitter><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg>
</a><a style=border-bottom:none href=mailto:dlkong201893@gmail.com rel=me title=Email><svg viewBox="0 0 24 21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div><span>&copy; 2025 <a href=https://fordelkon.github.io/>DL Kong</a></span>
<span>•
Powered by
<a href=https://gohugo.io/>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/>PaperMod</a>
</span><span>•
<a href=/privacy>Privacy Policy</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let b=document.querySelector("#menu-trigger"),m=document.querySelector(".menu");b.addEventListener("click",function(){m.classList.toggle("hidden")}),document.body.addEventListener("click",function(e){b.contains(e.target)||m.classList.add("hidden")})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>