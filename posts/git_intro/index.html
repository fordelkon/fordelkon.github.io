<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Gitè¯¦è§£ | DL Kong</title><meta name=keywords content="Git,Python"><meta name=description content='è¿™ç¯‡åšå®¢ä¸»è¦è‡ªåº•å‘ä¸Šåœ°ä»‹ç»Gitå‘½ä»¤è¡Œï¼Œæœ‰æ—¶ç”šè‡³ä¼šä½¿ç”¨ä¸€äº›pythonä»£ç æ¥å¯¹ä¸€äº›Gitçš„åŠŸèƒ½è¿›è¡Œæ›´åŠ è¯¦ç»†çš„åˆ†æã€‚æˆ‘ä¸€ç›´è®¤ä¸ºåŸºç¡€ä¸€æ—¦æ‰“å¥½ï¼Œé‚£ä¹ˆä¸€äº›æ›´é«˜çº§çš„ç”¨æ³•ä¹Ÿå¯ä»¥å¾ªåºæ¸è¿›åœ°äº†è§£ï¼Œè€Œä¸”æ˜¯æ›´åŠ é€å½»çš„äº†è§£ã€‚ä¸æ˜¯åƒåšä¸»ä¸€å¼€å§‹é‚£æ ·ä»¥ä¸ºåªè¦æ­»è®°ç¡¬èƒŒgit addï¼Œgit commit,git pullï¼Œgit cloneç­‰å¸¸è§å‘½ä»¤çš„ä¸€äº›ç”¨æ³•å°±å¯ä»¥äº†ğŸ˜­ï¼ˆå®é™…ä¸Šç½‘ä¸Šå¤§å¤šæ•°æ•™ç¨‹å°±æ˜¯è¿™æ ·æ•™çš„&mldr;ï¼‰ï¼Œåœ¨è¿™ä¸Šé¢èµ°äº†ä¸å°‘å¼¯è·¯ï¼Œæ‰€ä»¥ä»å¤´å¼€å§‹æ‰“åœ°åŸºå†™ä½œæ­¤æ–‡ç•™ä»¥è­¦ç¤ºâš ï¸ã€‚

Gitä»“åº“ï¼ˆGit Repositoryï¼‰
è¦å­¦ä¹ Gitï¼Œé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“æˆ‘ä»¬è¿è¡ŒGitå‘½ä»¤æ˜¯å¯¹ä»€ä¹ˆå¯¹è±¡è¿›è¡Œæ“ä½œçš„ï¼Œåœ¨Gitçš„ç›¸å…³æœ¯è¯­ä¸­ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå¯¹è±¡å«åšGitä»“åº“ï¼ˆGit Repositoryï¼‰ï¼ŒGitä»“åº“å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œæˆ‘ä»¬é€šè¿‡.gitæ–‡ä»¶å¤¹ï¼ˆéšè—æ–‡ä»¶å¤¹ï¼‰å¯¹Gitä»“åº“ä¸­çš„å·¥ä½œåŒºä¸­çš„æ–‡ä»¶ï¼ˆééšè—æ–‡ä»¶å¤¹ï¼‰å†…å®¹çš„æ”¹å˜è¿›è¡Œè®°å½•ï¼Œå½“ç„¶å¹¶ä¸æ˜¯æ‰€æœ‰ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶çš„æ”¹å˜éƒ½ä¼šè¢«è®°å½•ï¼Œè¢«.gitingoreæ–‡ä»¶æ‰€æ ‡è¯†çš„æ–‡ä»¶è¢«æ”¹å˜å.gitæ–‡ä»¶å¤¹ä¸ä¼šå¯¹å…¶è¿›è¡Œè®°å½•ã€‚æ ¹æ®æˆ‘ä¸Šé¢æ‰€è¯´ï¼ŒGitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ã€‚
æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸‹ç®€ç•¥çš„å…¬å¼ï¼š

$$\mathrm{Git}\ \mathrm{Repository} = \mathrm{.git}\ \mathrm{folder} + \mathrm{worktree}\ \mathrm{folder}\tag{1}$$

æ›´åŠ è¯¦å°½çš„æ¥è¯´ä»¥pythonæ¥æ„å»ºGitä»“åº“ç±»ï¼š
class GitRepository (object):
    """A git repository"""

    worktree = None
    gitdir = None

    def __init__(self, path):
        self.worktree = path
        self.gitdir = os.path.join(path, ".git")
.gitæ–‡ä»¶å¤¹å†…éƒ¨ç»“æ„æ¢ç©¶
å‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“äº†Gitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ï¼Œé‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¯¹æ­¤è¿›è¡Œè„±è´«æ”»åšäº†ã€‚ç”±äº.gitæ˜¯éšè—æ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå¯¹.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒæœ‰ä¸€å®šçš„äº†è§£ï¼Œgit initåˆå§‹åŒ–åçš„.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒå¦‚å›¾1æ‰€ç¤ºï¼Œæ­¤æ—¶Gitä»“åº“å†…é™¤äº†.gitæ–‡ä»¶å¤¹ä¹‹å¤–ä¸€ç‰‡è’èŠœã€‚

  


å›¾1ï¼šè¿è¡Œgit initä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„

ç„¶åæˆ‘ä»¬å†æœ¬åœ°Gitä»“åº“ä¸­æ·»åŠ å¯è§æ–‡ä»¶ï¼Œæ·»åŠ åçš„ç»“æœå¦‚å›¾2æ‰€ç¤ºã€‚

  


å›¾2ï¼šGitä»“åº“æ·»åŠ æ–‡ä»¶åçš„æ–‡ä»¶åˆ†å¸ƒ

å°†ä¸Šè¿°æ‰€æœ‰æ–‡ä»¶è¿è¡Œgit addä¹‹ååœ¨è¿›è¡Œgit commitè§‚å¯Ÿ.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒï¼Œå¦‚å›¾3æ‰€ç¤ºã€‚å¯ä»¥çœ‹åˆ°ç›¸è¾ƒäºæœ€åˆçš„.gitæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨git addå’Œgit commitä¹‹åæ–‡ä»¶å¤¹ä¸­å¤šå‡ºäº†indexæ–‡ä»¶ï¼Œlogæ–‡ä»¶å¤¹ï¼Œobjectsæ–‡ä»¶å¤¹ä¸­çš„8ä¸ªæ–‡ä»¶ä»¥åŠrefs/headsä¸‹çš„mainæ–‡ä»¶ï¼Œå…¶ä»–çš„ä¸€äº›å˜åŒ–æˆ‘ä»¬ä¸åšè€ƒè™‘ã€‚æœ‰æœå¯¼å› æˆ‘ä»¬å¯ä»¥çŸ¥é“.gitæ–‡ä»¶å¤¹å†…éƒ¨çš„è¿™äº›å˜åŒ–ä¸­æœ‰å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹æ–‡ä»¶ä¿®æ”¹çš„è®°å½•ã€‚

  


å›¾3ï¼šè¿è¡Œgit addå’Œgit commitä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„

Gitå¯¹è±¡ï¼ˆGit Objectï¼‰
ä¸Šé¢çš„å˜åŒ–ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿè¦çŸ¥é“Gitä¸­çš„å‡ ä¹ä¸€åˆ‡éƒ½è¢«å­˜å‚¨ä¸ºGitå¯¹è±¡ï¼ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡Gitå¯¹è±¡è¿›è¡Œæ“ä½œæ¥å®Œæˆä¸Šé¢çš„å˜åŒ–ã€‚è¯´äº†è¿™ä¹ˆå¤šï¼Œè®©æˆ‘ä»¬æ¥ä¸ºGitå¯¹è±¡ä¸‹ä¸€ä¸ªæ¯”è¾ƒå®˜æ–¹çš„å®šä¹‰ï¼šGitå¯¹è±¡å°±æ˜¯åœ¨ Git ä»“åº“ä¸­çš„æ–‡ä»¶ï¼Œå®ƒä»¬çš„è·¯å¾„ç”±å®ƒä»¬çš„å†…å®¹å†³å®šã€‚
Gitå¯¹è±¡èŒƒæ€§å¯ä»¥å€Ÿç”±pythonæ¥å®ç°ï¼š
class GitObject (object):

    def __init__(self, data=None):
        if data != None:
            self.deserialize(data)
        else:
            self.init()

    def serialize(self):
	"""å°†å¯¹è±¡è½¬å˜ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼"""
        raise Exception("Unimplemented!")

    def deserialize(self, data):
	"""dataé€šå¸¸ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼ï¼Œæ ¹æ®ç±»å‹è§£ç """
        raise Exception("Unimplemented!")

    def init(self):
        pass # Just do nothing. This is a reasonable default!
Gitå¯¹è±¡åˆç»†åˆ†ä¸ºä»¥ä¸‹å››ç§ç±»å‹ï¼šGitBlobï¼ˆBinary Large Objectï¼‰å¯¹è±¡ï¼Œ GitCommitå¯¹è±¡ï¼Œ GitTreeå¯¹è±¡ï¼Œ GitTagå¯¹è±¡ï¼Œä»¥ä¸‹åˆ†åˆ«è¿›è¡Œä»‹ç»ã€‚'><meta name=author content="DL Kong"><link rel=canonical href=https://fordelkon.github.io/posts/git_intro/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.c7a0847263ef81d155d535eb3508757a49b1a3680807f60ed1f64e9d4a686070.css integrity="sha256-x6CEcmPvgdFV1TXrNQh1ekmxo2gIB/YO0fZOnUpoYHA=" rel="preload stylesheet" as=style><link rel=icon href=https://fordelkon.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fordelkon.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fordelkon.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fordelkon.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fordelkon.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://fordelkon.github.io/posts/git_intro/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><style>@media screen and (min-width:769px){.post-content input[type=checkbox]:checked~label>img{transform:scale(1.6);cursor:zoom-out;position:relative;z-index:999}.post-content img.zoomCheck{transition:transform .15s ease;z-index:999;cursor:zoom-in}}</style><link rel=stylesheet href=/css/extended/xcode.css media="(prefers-color-scheme: light)"><link rel=stylesheet href=/css/extended/monokai.css media="(prefers-color-scheme: dark)"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Q603T56FWT"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Q603T56FWT")}</script><meta property="og:url" content="https://fordelkon.github.io/posts/git_intro/"><meta property="og:site_name" content="DL Kong"><meta property="og:title" content="Gitè¯¦è§£"><meta property="og:description" content='è¿™ç¯‡åšå®¢ä¸»è¦è‡ªåº•å‘ä¸Šåœ°ä»‹ç»Gitå‘½ä»¤è¡Œï¼Œæœ‰æ—¶ç”šè‡³ä¼šä½¿ç”¨ä¸€äº›pythonä»£ç æ¥å¯¹ä¸€äº›Gitçš„åŠŸèƒ½è¿›è¡Œæ›´åŠ è¯¦ç»†çš„åˆ†æã€‚æˆ‘ä¸€ç›´è®¤ä¸ºåŸºç¡€ä¸€æ—¦æ‰“å¥½ï¼Œé‚£ä¹ˆä¸€äº›æ›´é«˜çº§çš„ç”¨æ³•ä¹Ÿå¯ä»¥å¾ªåºæ¸è¿›åœ°äº†è§£ï¼Œè€Œä¸”æ˜¯æ›´åŠ é€å½»çš„äº†è§£ã€‚ä¸æ˜¯åƒåšä¸»ä¸€å¼€å§‹é‚£æ ·ä»¥ä¸ºåªè¦æ­»è®°ç¡¬èƒŒgit addï¼Œgit commit,git pullï¼Œgit cloneç­‰å¸¸è§å‘½ä»¤çš„ä¸€äº›ç”¨æ³•å°±å¯ä»¥äº†ğŸ˜­ï¼ˆå®é™…ä¸Šç½‘ä¸Šå¤§å¤šæ•°æ•™ç¨‹å°±æ˜¯è¿™æ ·æ•™çš„â€¦ï¼‰ï¼Œåœ¨è¿™ä¸Šé¢èµ°äº†ä¸å°‘å¼¯è·¯ï¼Œæ‰€ä»¥ä»å¤´å¼€å§‹æ‰“åœ°åŸºå†™ä½œæ­¤æ–‡ç•™ä»¥è­¦ç¤ºâš ï¸ã€‚
Gitä»“åº“ï¼ˆGit Repositoryï¼‰ è¦å­¦ä¹ Gitï¼Œé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“æˆ‘ä»¬è¿è¡ŒGitå‘½ä»¤æ˜¯å¯¹ä»€ä¹ˆå¯¹è±¡è¿›è¡Œæ“ä½œçš„ï¼Œåœ¨Gitçš„ç›¸å…³æœ¯è¯­ä¸­ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå¯¹è±¡å«åšGitä»“åº“ï¼ˆGit Repositoryï¼‰ï¼ŒGitä»“åº“å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œæˆ‘ä»¬é€šè¿‡.gitæ–‡ä»¶å¤¹ï¼ˆéšè—æ–‡ä»¶å¤¹ï¼‰å¯¹Gitä»“åº“ä¸­çš„å·¥ä½œåŒºä¸­çš„æ–‡ä»¶ï¼ˆééšè—æ–‡ä»¶å¤¹ï¼‰å†…å®¹çš„æ”¹å˜è¿›è¡Œè®°å½•ï¼Œå½“ç„¶å¹¶ä¸æ˜¯æ‰€æœ‰ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶çš„æ”¹å˜éƒ½ä¼šè¢«è®°å½•ï¼Œè¢«.gitingoreæ–‡ä»¶æ‰€æ ‡è¯†çš„æ–‡ä»¶è¢«æ”¹å˜å.gitæ–‡ä»¶å¤¹ä¸ä¼šå¯¹å…¶è¿›è¡Œè®°å½•ã€‚æ ¹æ®æˆ‘ä¸Šé¢æ‰€è¯´ï¼ŒGitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ã€‚
æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸‹ç®€ç•¥çš„å…¬å¼ï¼š
$$\mathrm{Git}\ \mathrm{Repository} = \mathrm{.git}\ \mathrm{folder} + \mathrm{worktree}\ \mathrm{folder}\tag{1}$$ æ›´åŠ è¯¦å°½çš„æ¥è¯´ä»¥pythonæ¥æ„å»ºGitä»“åº“ç±»ï¼š
class GitRepository (object): """A git repository""" worktree = None gitdir = None def __init__(self, path): self.worktree = path self.gitdir = os.path.join(path, ".git") .gitæ–‡ä»¶å¤¹å†…éƒ¨ç»“æ„æ¢ç©¶ å‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“äº†Gitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ï¼Œé‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¯¹æ­¤è¿›è¡Œè„±è´«æ”»åšäº†ã€‚ç”±äº.gitæ˜¯éšè—æ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå¯¹.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒæœ‰ä¸€å®šçš„äº†è§£ï¼Œgit initåˆå§‹åŒ–åçš„.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒå¦‚å›¾1æ‰€ç¤ºï¼Œæ­¤æ—¶Gitä»“åº“å†…é™¤äº†.gitæ–‡ä»¶å¤¹ä¹‹å¤–ä¸€ç‰‡è’èŠœã€‚
å›¾1ï¼šè¿è¡Œgit initä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„ ç„¶åæˆ‘ä»¬å†æœ¬åœ°Gitä»“åº“ä¸­æ·»åŠ å¯è§æ–‡ä»¶ï¼Œæ·»åŠ åçš„ç»“æœå¦‚å›¾2æ‰€ç¤ºã€‚
å›¾2ï¼šGitä»“åº“æ·»åŠ æ–‡ä»¶åçš„æ–‡ä»¶åˆ†å¸ƒ å°†ä¸Šè¿°æ‰€æœ‰æ–‡ä»¶è¿è¡Œgit addä¹‹ååœ¨è¿›è¡Œgit commitè§‚å¯Ÿ.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒï¼Œå¦‚å›¾3æ‰€ç¤ºã€‚å¯ä»¥çœ‹åˆ°ç›¸è¾ƒäºæœ€åˆçš„.gitæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨git addå’Œgit commitä¹‹åæ–‡ä»¶å¤¹ä¸­å¤šå‡ºäº†indexæ–‡ä»¶ï¼Œlogæ–‡ä»¶å¤¹ï¼Œobjectsæ–‡ä»¶å¤¹ä¸­çš„8ä¸ªæ–‡ä»¶ä»¥åŠrefs/headsä¸‹çš„mainæ–‡ä»¶ï¼Œå…¶ä»–çš„ä¸€äº›å˜åŒ–æˆ‘ä»¬ä¸åšè€ƒè™‘ã€‚æœ‰æœå¯¼å› æˆ‘ä»¬å¯ä»¥çŸ¥é“.gitæ–‡ä»¶å¤¹å†…éƒ¨çš„è¿™äº›å˜åŒ–ä¸­æœ‰å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹æ–‡ä»¶ä¿®æ”¹çš„è®°å½•ã€‚
å›¾3ï¼šè¿è¡Œgit addå’Œgit commitä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„ Gitå¯¹è±¡ï¼ˆGit Objectï¼‰ ä¸Šé¢çš„å˜åŒ–ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿè¦çŸ¥é“Gitä¸­çš„å‡ ä¹ä¸€åˆ‡éƒ½è¢«å­˜å‚¨ä¸ºGitå¯¹è±¡ï¼ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡Gitå¯¹è±¡è¿›è¡Œæ“ä½œæ¥å®Œæˆä¸Šé¢çš„å˜åŒ–ã€‚è¯´äº†è¿™ä¹ˆå¤šï¼Œè®©æˆ‘ä»¬æ¥ä¸ºGitå¯¹è±¡ä¸‹ä¸€ä¸ªæ¯”è¾ƒå®˜æ–¹çš„å®šä¹‰ï¼šGitå¯¹è±¡å°±æ˜¯åœ¨ Git ä»“åº“ä¸­çš„æ–‡ä»¶ï¼Œå®ƒä»¬çš„è·¯å¾„ç”±å®ƒä»¬çš„å†…å®¹å†³å®šã€‚
Gitå¯¹è±¡èŒƒæ€§å¯ä»¥å€Ÿç”±pythonæ¥å®ç°ï¼š
class GitObject (object): def __init__(self, data=None): if data != None: self.deserialize(data) else: self.init() def serialize(self): """å°†å¯¹è±¡è½¬å˜ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼""" raise Exception("Unimplemented!") def deserialize(self, data): """dataé€šå¸¸ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼ï¼Œæ ¹æ®ç±»å‹è§£ç """ raise Exception("Unimplemented!") def init(self): pass # Just do nothing. This is a reasonable default! Gitå¯¹è±¡åˆç»†åˆ†ä¸ºä»¥ä¸‹å››ç§ç±»å‹ï¼šGitBlobï¼ˆBinary Large Objectï¼‰å¯¹è±¡ï¼Œ GitCommitå¯¹è±¡ï¼Œ GitTreeå¯¹è±¡ï¼Œ GitTagå¯¹è±¡ï¼Œä»¥ä¸‹åˆ†åˆ«è¿›è¡Œä»‹ç»ã€‚'><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-24T23:09:00+09:00"><meta property="article:modified_time" content="2025-08-24T23:09:00+09:00"><meta property="article:tag" content="Git"><meta property="article:tag" content="Python"><meta property="og:image" content="https://fordelkon.github.io/img/git_intro_summary.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fordelkon.github.io/img/git_intro_summary.png"><meta name=twitter:title content="Gitè¯¦è§£"><meta name=twitter:description content='è¿™ç¯‡åšå®¢ä¸»è¦è‡ªåº•å‘ä¸Šåœ°ä»‹ç»Gitå‘½ä»¤è¡Œï¼Œæœ‰æ—¶ç”šè‡³ä¼šä½¿ç”¨ä¸€äº›pythonä»£ç æ¥å¯¹ä¸€äº›Gitçš„åŠŸèƒ½è¿›è¡Œæ›´åŠ è¯¦ç»†çš„åˆ†æã€‚æˆ‘ä¸€ç›´è®¤ä¸ºåŸºç¡€ä¸€æ—¦æ‰“å¥½ï¼Œé‚£ä¹ˆä¸€äº›æ›´é«˜çº§çš„ç”¨æ³•ä¹Ÿå¯ä»¥å¾ªåºæ¸è¿›åœ°äº†è§£ï¼Œè€Œä¸”æ˜¯æ›´åŠ é€å½»çš„äº†è§£ã€‚ä¸æ˜¯åƒåšä¸»ä¸€å¼€å§‹é‚£æ ·ä»¥ä¸ºåªè¦æ­»è®°ç¡¬èƒŒgit addï¼Œgit commit,git pullï¼Œgit cloneç­‰å¸¸è§å‘½ä»¤çš„ä¸€äº›ç”¨æ³•å°±å¯ä»¥äº†ğŸ˜­ï¼ˆå®é™…ä¸Šç½‘ä¸Šå¤§å¤šæ•°æ•™ç¨‹å°±æ˜¯è¿™æ ·æ•™çš„&mldr;ï¼‰ï¼Œåœ¨è¿™ä¸Šé¢èµ°äº†ä¸å°‘å¼¯è·¯ï¼Œæ‰€ä»¥ä»å¤´å¼€å§‹æ‰“åœ°åŸºå†™ä½œæ­¤æ–‡ç•™ä»¥è­¦ç¤ºâš ï¸ã€‚

Gitä»“åº“ï¼ˆGit Repositoryï¼‰
è¦å­¦ä¹ Gitï¼Œé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“æˆ‘ä»¬è¿è¡ŒGitå‘½ä»¤æ˜¯å¯¹ä»€ä¹ˆå¯¹è±¡è¿›è¡Œæ“ä½œçš„ï¼Œåœ¨Gitçš„ç›¸å…³æœ¯è¯­ä¸­ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå¯¹è±¡å«åšGitä»“åº“ï¼ˆGit Repositoryï¼‰ï¼ŒGitä»“åº“å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œæˆ‘ä»¬é€šè¿‡.gitæ–‡ä»¶å¤¹ï¼ˆéšè—æ–‡ä»¶å¤¹ï¼‰å¯¹Gitä»“åº“ä¸­çš„å·¥ä½œåŒºä¸­çš„æ–‡ä»¶ï¼ˆééšè—æ–‡ä»¶å¤¹ï¼‰å†…å®¹çš„æ”¹å˜è¿›è¡Œè®°å½•ï¼Œå½“ç„¶å¹¶ä¸æ˜¯æ‰€æœ‰ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶çš„æ”¹å˜éƒ½ä¼šè¢«è®°å½•ï¼Œè¢«.gitingoreæ–‡ä»¶æ‰€æ ‡è¯†çš„æ–‡ä»¶è¢«æ”¹å˜å.gitæ–‡ä»¶å¤¹ä¸ä¼šå¯¹å…¶è¿›è¡Œè®°å½•ã€‚æ ¹æ®æˆ‘ä¸Šé¢æ‰€è¯´ï¼ŒGitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ã€‚
æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸‹ç®€ç•¥çš„å…¬å¼ï¼š

$$\mathrm{Git}\ \mathrm{Repository} = \mathrm{.git}\ \mathrm{folder} + \mathrm{worktree}\ \mathrm{folder}\tag{1}$$

æ›´åŠ è¯¦å°½çš„æ¥è¯´ä»¥pythonæ¥æ„å»ºGitä»“åº“ç±»ï¼š
class GitRepository (object):
    """A git repository"""

    worktree = None
    gitdir = None

    def __init__(self, path):
        self.worktree = path
        self.gitdir = os.path.join(path, ".git")
.gitæ–‡ä»¶å¤¹å†…éƒ¨ç»“æ„æ¢ç©¶
å‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“äº†Gitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ï¼Œé‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¯¹æ­¤è¿›è¡Œè„±è´«æ”»åšäº†ã€‚ç”±äº.gitæ˜¯éšè—æ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå¯¹.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒæœ‰ä¸€å®šçš„äº†è§£ï¼Œgit initåˆå§‹åŒ–åçš„.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒå¦‚å›¾1æ‰€ç¤ºï¼Œæ­¤æ—¶Gitä»“åº“å†…é™¤äº†.gitæ–‡ä»¶å¤¹ä¹‹å¤–ä¸€ç‰‡è’èŠœã€‚

  


å›¾1ï¼šè¿è¡Œgit initä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„

ç„¶åæˆ‘ä»¬å†æœ¬åœ°Gitä»“åº“ä¸­æ·»åŠ å¯è§æ–‡ä»¶ï¼Œæ·»åŠ åçš„ç»“æœå¦‚å›¾2æ‰€ç¤ºã€‚

  


å›¾2ï¼šGitä»“åº“æ·»åŠ æ–‡ä»¶åçš„æ–‡ä»¶åˆ†å¸ƒ

å°†ä¸Šè¿°æ‰€æœ‰æ–‡ä»¶è¿è¡Œgit addä¹‹ååœ¨è¿›è¡Œgit commitè§‚å¯Ÿ.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒï¼Œå¦‚å›¾3æ‰€ç¤ºã€‚å¯ä»¥çœ‹åˆ°ç›¸è¾ƒäºæœ€åˆçš„.gitæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨git addå’Œgit commitä¹‹åæ–‡ä»¶å¤¹ä¸­å¤šå‡ºäº†indexæ–‡ä»¶ï¼Œlogæ–‡ä»¶å¤¹ï¼Œobjectsæ–‡ä»¶å¤¹ä¸­çš„8ä¸ªæ–‡ä»¶ä»¥åŠrefs/headsä¸‹çš„mainæ–‡ä»¶ï¼Œå…¶ä»–çš„ä¸€äº›å˜åŒ–æˆ‘ä»¬ä¸åšè€ƒè™‘ã€‚æœ‰æœå¯¼å› æˆ‘ä»¬å¯ä»¥çŸ¥é“.gitæ–‡ä»¶å¤¹å†…éƒ¨çš„è¿™äº›å˜åŒ–ä¸­æœ‰å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹æ–‡ä»¶ä¿®æ”¹çš„è®°å½•ã€‚

  


å›¾3ï¼šè¿è¡Œgit addå’Œgit commitä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„

Gitå¯¹è±¡ï¼ˆGit Objectï¼‰
ä¸Šé¢çš„å˜åŒ–ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿè¦çŸ¥é“Gitä¸­çš„å‡ ä¹ä¸€åˆ‡éƒ½è¢«å­˜å‚¨ä¸ºGitå¯¹è±¡ï¼ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡Gitå¯¹è±¡è¿›è¡Œæ“ä½œæ¥å®Œæˆä¸Šé¢çš„å˜åŒ–ã€‚è¯´äº†è¿™ä¹ˆå¤šï¼Œè®©æˆ‘ä»¬æ¥ä¸ºGitå¯¹è±¡ä¸‹ä¸€ä¸ªæ¯”è¾ƒå®˜æ–¹çš„å®šä¹‰ï¼šGitå¯¹è±¡å°±æ˜¯åœ¨ Git ä»“åº“ä¸­çš„æ–‡ä»¶ï¼Œå®ƒä»¬çš„è·¯å¾„ç”±å®ƒä»¬çš„å†…å®¹å†³å®šã€‚
Gitå¯¹è±¡èŒƒæ€§å¯ä»¥å€Ÿç”±pythonæ¥å®ç°ï¼š
class GitObject (object):

    def __init__(self, data=None):
        if data != None:
            self.deserialize(data)
        else:
            self.init()

    def serialize(self):
	"""å°†å¯¹è±¡è½¬å˜ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼"""
        raise Exception("Unimplemented!")

    def deserialize(self, data):
	"""dataé€šå¸¸ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼ï¼Œæ ¹æ®ç±»å‹è§£ç """
        raise Exception("Unimplemented!")

    def init(self):
        pass # Just do nothing. This is a reasonable default!
Gitå¯¹è±¡åˆç»†åˆ†ä¸ºä»¥ä¸‹å››ç§ç±»å‹ï¼šGitBlobï¼ˆBinary Large Objectï¼‰å¯¹è±¡ï¼Œ GitCommitå¯¹è±¡ï¼Œ GitTreeå¯¹è±¡ï¼Œ GitTagå¯¹è±¡ï¼Œä»¥ä¸‹åˆ†åˆ«è¿›è¡Œä»‹ç»ã€‚'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://fordelkon.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Gitè¯¦è§£","item":"https://fordelkon.github.io/posts/git_intro/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Gitè¯¦è§£","name":"Gitè¯¦è§£","description":"è¿™ç¯‡åšå®¢ä¸»è¦è‡ªåº•å‘ä¸Šåœ°ä»‹ç»Gitå‘½ä»¤è¡Œï¼Œæœ‰æ—¶ç”šè‡³ä¼šä½¿ç”¨ä¸€äº›pythonä»£ç æ¥å¯¹ä¸€äº›Gitçš„åŠŸèƒ½è¿›è¡Œæ›´åŠ è¯¦ç»†çš„åˆ†æã€‚æˆ‘ä¸€ç›´è®¤ä¸ºåŸºç¡€ä¸€æ—¦æ‰“å¥½ï¼Œé‚£ä¹ˆä¸€äº›æ›´é«˜çº§çš„ç”¨æ³•ä¹Ÿå¯ä»¥å¾ªåºæ¸è¿›åœ°äº†è§£ï¼Œè€Œä¸”æ˜¯æ›´åŠ é€å½»çš„äº†è§£ã€‚ä¸æ˜¯åƒåšä¸»ä¸€å¼€å§‹é‚£æ ·ä»¥ä¸ºåªè¦æ­»è®°ç¡¬èƒŒgit addï¼Œgit commit,git pullï¼Œgit cloneç­‰å¸¸è§å‘½ä»¤çš„ä¸€äº›ç”¨æ³•å°±å¯ä»¥äº†ğŸ˜­ï¼ˆå®é™…ä¸Šç½‘ä¸Šå¤§å¤šæ•°æ•™ç¨‹å°±æ˜¯è¿™æ ·æ•™çš„\u0026hellip;ï¼‰ï¼Œåœ¨è¿™ä¸Šé¢èµ°äº†ä¸å°‘å¼¯è·¯ï¼Œæ‰€ä»¥ä»å¤´å¼€å§‹æ‰“åœ°åŸºå†™ä½œæ­¤æ–‡ç•™ä»¥è­¦ç¤ºâš ï¸ã€‚\nGitä»“åº“ï¼ˆGit Repositoryï¼‰ è¦å­¦ä¹ Gitï¼Œé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“æˆ‘ä»¬è¿è¡ŒGitå‘½ä»¤æ˜¯å¯¹ä»€ä¹ˆå¯¹è±¡è¿›è¡Œæ“ä½œçš„ï¼Œåœ¨Gitçš„ç›¸å…³æœ¯è¯­ä¸­ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå¯¹è±¡å«åšGitä»“åº“ï¼ˆGit Repositoryï¼‰ï¼ŒGitä»“åº“å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œæˆ‘ä»¬é€šè¿‡.gitæ–‡ä»¶å¤¹ï¼ˆéšè—æ–‡ä»¶å¤¹ï¼‰å¯¹Gitä»“åº“ä¸­çš„å·¥ä½œåŒºä¸­çš„æ–‡ä»¶ï¼ˆééšè—æ–‡ä»¶å¤¹ï¼‰å†…å®¹çš„æ”¹å˜è¿›è¡Œè®°å½•ï¼Œå½“ç„¶å¹¶ä¸æ˜¯æ‰€æœ‰ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶çš„æ”¹å˜éƒ½ä¼šè¢«è®°å½•ï¼Œè¢«.gitingoreæ–‡ä»¶æ‰€æ ‡è¯†çš„æ–‡ä»¶è¢«æ”¹å˜å.gitæ–‡ä»¶å¤¹ä¸ä¼šå¯¹å…¶è¿›è¡Œè®°å½•ã€‚æ ¹æ®æˆ‘ä¸Šé¢æ‰€è¯´ï¼ŒGitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ã€‚\næ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸‹ç®€ç•¥çš„å…¬å¼ï¼š\n$$\\mathrm{Git}\\ \\mathrm{Repository} = \\mathrm{.git}\\ \\mathrm{folder} + \\mathrm{worktree}\\ \\mathrm{folder}\\tag{1}$$ æ›´åŠ è¯¦å°½çš„æ¥è¯´ä»¥pythonæ¥æ„å»ºGitä»“åº“ç±»ï¼š\nclass GitRepository (object): \u0026#34;\u0026#34;\u0026#34;A git repository\u0026#34;\u0026#34;\u0026#34; worktree = None gitdir = None def __init__(self, path): self.worktree = path self.gitdir = os.path.join(path, \u0026#34;.git\u0026#34;) .gitæ–‡ä»¶å¤¹å†…éƒ¨ç»“æ„æ¢ç©¶ å‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“äº†Gitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ï¼Œé‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¯¹æ­¤è¿›è¡Œè„±è´«æ”»åšäº†ã€‚ç”±äº.gitæ˜¯éšè—æ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå¯¹.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒæœ‰ä¸€å®šçš„äº†è§£ï¼Œgit initåˆå§‹åŒ–åçš„.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒå¦‚å›¾1æ‰€ç¤ºï¼Œæ­¤æ—¶Gitä»“åº“å†…é™¤äº†.gitæ–‡ä»¶å¤¹ä¹‹å¤–ä¸€ç‰‡è’èŠœã€‚\nå›¾1ï¼šè¿è¡Œgit initä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„ ç„¶åæˆ‘ä»¬å†æœ¬åœ°Gitä»“åº“ä¸­æ·»åŠ å¯è§æ–‡ä»¶ï¼Œæ·»åŠ åçš„ç»“æœå¦‚å›¾2æ‰€ç¤ºã€‚\nå›¾2ï¼šGitä»“åº“æ·»åŠ æ–‡ä»¶åçš„æ–‡ä»¶åˆ†å¸ƒ å°†ä¸Šè¿°æ‰€æœ‰æ–‡ä»¶è¿è¡Œgit addä¹‹ååœ¨è¿›è¡Œgit commitè§‚å¯Ÿ.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒï¼Œå¦‚å›¾3æ‰€ç¤ºã€‚å¯ä»¥çœ‹åˆ°ç›¸è¾ƒäºæœ€åˆçš„.gitæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨git addå’Œgit commitä¹‹åæ–‡ä»¶å¤¹ä¸­å¤šå‡ºäº†indexæ–‡ä»¶ï¼Œlogæ–‡ä»¶å¤¹ï¼Œobjectsæ–‡ä»¶å¤¹ä¸­çš„8ä¸ªæ–‡ä»¶ä»¥åŠrefs/headsä¸‹çš„mainæ–‡ä»¶ï¼Œå…¶ä»–çš„ä¸€äº›å˜åŒ–æˆ‘ä»¬ä¸åšè€ƒè™‘ã€‚æœ‰æœå¯¼å› æˆ‘ä»¬å¯ä»¥çŸ¥é“.gitæ–‡ä»¶å¤¹å†…éƒ¨çš„è¿™äº›å˜åŒ–ä¸­æœ‰å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹æ–‡ä»¶ä¿®æ”¹çš„è®°å½•ã€‚\nå›¾3ï¼šè¿è¡Œgit addå’Œgit commitä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„ Gitå¯¹è±¡ï¼ˆGit Objectï¼‰ ä¸Šé¢çš„å˜åŒ–ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿè¦çŸ¥é“Gitä¸­çš„å‡ ä¹ä¸€åˆ‡éƒ½è¢«å­˜å‚¨ä¸ºGitå¯¹è±¡ï¼ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡Gitå¯¹è±¡è¿›è¡Œæ“ä½œæ¥å®Œæˆä¸Šé¢çš„å˜åŒ–ã€‚è¯´äº†è¿™ä¹ˆå¤šï¼Œè®©æˆ‘ä»¬æ¥ä¸ºGitå¯¹è±¡ä¸‹ä¸€ä¸ªæ¯”è¾ƒå®˜æ–¹çš„å®šä¹‰ï¼šGitå¯¹è±¡å°±æ˜¯åœ¨ Git ä»“åº“ä¸­çš„æ–‡ä»¶ï¼Œå®ƒä»¬çš„è·¯å¾„ç”±å®ƒä»¬çš„å†…å®¹å†³å®šã€‚\nGitå¯¹è±¡èŒƒæ€§å¯ä»¥å€Ÿç”±pythonæ¥å®ç°ï¼š\nclass GitObject (object): def __init__(self, data=None): if data != None: self.deserialize(data) else: self.init() def serialize(self): \u0026#34;\u0026#34;\u0026#34;å°†å¯¹è±¡è½¬å˜ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼\u0026#34;\u0026#34;\u0026#34; raise Exception(\u0026#34;Unimplemented!\u0026#34;) def deserialize(self, data): \u0026#34;\u0026#34;\u0026#34;dataé€šå¸¸ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼ï¼Œæ ¹æ®ç±»å‹è§£ç \u0026#34;\u0026#34;\u0026#34; raise Exception(\u0026#34;Unimplemented!\u0026#34;) def init(self): pass # Just do nothing. This is a reasonable default! Gitå¯¹è±¡åˆç»†åˆ†ä¸ºä»¥ä¸‹å››ç§ç±»å‹ï¼šGitBlobï¼ˆBinary Large Objectï¼‰å¯¹è±¡ï¼Œ GitCommitå¯¹è±¡ï¼Œ GitTreeå¯¹è±¡ï¼Œ GitTagå¯¹è±¡ï¼Œä»¥ä¸‹åˆ†åˆ«è¿›è¡Œä»‹ç»ã€‚\n","keywords":["Git","Python"],"articleBody":"è¿™ç¯‡åšå®¢ä¸»è¦è‡ªåº•å‘ä¸Šåœ°ä»‹ç»Gitå‘½ä»¤è¡Œï¼Œæœ‰æ—¶ç”šè‡³ä¼šä½¿ç”¨ä¸€äº›pythonä»£ç æ¥å¯¹ä¸€äº›Gitçš„åŠŸèƒ½è¿›è¡Œæ›´åŠ è¯¦ç»†çš„åˆ†æã€‚æˆ‘ä¸€ç›´è®¤ä¸ºåŸºç¡€ä¸€æ—¦æ‰“å¥½ï¼Œé‚£ä¹ˆä¸€äº›æ›´é«˜çº§çš„ç”¨æ³•ä¹Ÿå¯ä»¥å¾ªåºæ¸è¿›åœ°äº†è§£ï¼Œè€Œä¸”æ˜¯æ›´åŠ é€å½»çš„äº†è§£ã€‚ä¸æ˜¯åƒåšä¸»ä¸€å¼€å§‹é‚£æ ·ä»¥ä¸ºåªè¦æ­»è®°ç¡¬èƒŒgit addï¼Œgit commit,git pullï¼Œgit cloneç­‰å¸¸è§å‘½ä»¤çš„ä¸€äº›ç”¨æ³•å°±å¯ä»¥äº†ğŸ˜­ï¼ˆå®é™…ä¸Šç½‘ä¸Šå¤§å¤šæ•°æ•™ç¨‹å°±æ˜¯è¿™æ ·æ•™çš„â€¦ï¼‰ï¼Œåœ¨è¿™ä¸Šé¢èµ°äº†ä¸å°‘å¼¯è·¯ï¼Œæ‰€ä»¥ä»å¤´å¼€å§‹æ‰“åœ°åŸºå†™ä½œæ­¤æ–‡ç•™ä»¥è­¦ç¤ºâš ï¸ã€‚\nGitä»“åº“ï¼ˆGit Repositoryï¼‰ è¦å­¦ä¹ Gitï¼Œé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“æˆ‘ä»¬è¿è¡ŒGitå‘½ä»¤æ˜¯å¯¹ä»€ä¹ˆå¯¹è±¡è¿›è¡Œæ“ä½œçš„ï¼Œåœ¨Gitçš„ç›¸å…³æœ¯è¯­ä¸­ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå¯¹è±¡å«åšGitä»“åº“ï¼ˆGit Repositoryï¼‰ï¼ŒGitä»“åº“å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œæˆ‘ä»¬é€šè¿‡.gitæ–‡ä»¶å¤¹ï¼ˆéšè—æ–‡ä»¶å¤¹ï¼‰å¯¹Gitä»“åº“ä¸­çš„å·¥ä½œåŒºä¸­çš„æ–‡ä»¶ï¼ˆééšè—æ–‡ä»¶å¤¹ï¼‰å†…å®¹çš„æ”¹å˜è¿›è¡Œè®°å½•ï¼Œå½“ç„¶å¹¶ä¸æ˜¯æ‰€æœ‰ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶çš„æ”¹å˜éƒ½ä¼šè¢«è®°å½•ï¼Œè¢«.gitingoreæ–‡ä»¶æ‰€æ ‡è¯†çš„æ–‡ä»¶è¢«æ”¹å˜å.gitæ–‡ä»¶å¤¹ä¸ä¼šå¯¹å…¶è¿›è¡Œè®°å½•ã€‚æ ¹æ®æˆ‘ä¸Šé¢æ‰€è¯´ï¼ŒGitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ã€‚\næ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸‹ç®€ç•¥çš„å…¬å¼ï¼š\n$$\\mathrm{Git}\\ \\mathrm{Repository} = \\mathrm{.git}\\ \\mathrm{folder} + \\mathrm{worktree}\\ \\mathrm{folder}\\tag{1}$$ æ›´åŠ è¯¦å°½çš„æ¥è¯´ä»¥pythonæ¥æ„å»ºGitä»“åº“ç±»ï¼š\nclass GitRepository (object): \"\"\"A git repository\"\"\" worktree = None gitdir = None def __init__(self, path): self.worktree = path self.gitdir = os.path.join(path, \".git\") .gitæ–‡ä»¶å¤¹å†…éƒ¨ç»“æ„æ¢ç©¶ å‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“äº†Gitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ï¼Œé‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¯¹æ­¤è¿›è¡Œè„±è´«æ”»åšäº†ã€‚ç”±äº.gitæ˜¯éšè—æ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå¯¹.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒæœ‰ä¸€å®šçš„äº†è§£ï¼Œgit initåˆå§‹åŒ–åçš„.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒå¦‚å›¾1æ‰€ç¤ºï¼Œæ­¤æ—¶Gitä»“åº“å†…é™¤äº†.gitæ–‡ä»¶å¤¹ä¹‹å¤–ä¸€ç‰‡è’èŠœã€‚\nå›¾1ï¼šè¿è¡Œgit initä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„ ç„¶åæˆ‘ä»¬å†æœ¬åœ°Gitä»“åº“ä¸­æ·»åŠ å¯è§æ–‡ä»¶ï¼Œæ·»åŠ åçš„ç»“æœå¦‚å›¾2æ‰€ç¤ºã€‚\nå›¾2ï¼šGitä»“åº“æ·»åŠ æ–‡ä»¶åçš„æ–‡ä»¶åˆ†å¸ƒ å°†ä¸Šè¿°æ‰€æœ‰æ–‡ä»¶è¿è¡Œgit addä¹‹ååœ¨è¿›è¡Œgit commitè§‚å¯Ÿ.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒï¼Œå¦‚å›¾3æ‰€ç¤ºã€‚å¯ä»¥çœ‹åˆ°ç›¸è¾ƒäºæœ€åˆçš„.gitæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨git addå’Œgit commitä¹‹åæ–‡ä»¶å¤¹ä¸­å¤šå‡ºäº†indexæ–‡ä»¶ï¼Œlogæ–‡ä»¶å¤¹ï¼Œobjectsæ–‡ä»¶å¤¹ä¸­çš„8ä¸ªæ–‡ä»¶ä»¥åŠrefs/headsä¸‹çš„mainæ–‡ä»¶ï¼Œå…¶ä»–çš„ä¸€äº›å˜åŒ–æˆ‘ä»¬ä¸åšè€ƒè™‘ã€‚æœ‰æœå¯¼å› æˆ‘ä»¬å¯ä»¥çŸ¥é“.gitæ–‡ä»¶å¤¹å†…éƒ¨çš„è¿™äº›å˜åŒ–ä¸­æœ‰å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹æ–‡ä»¶ä¿®æ”¹çš„è®°å½•ã€‚\nå›¾3ï¼šè¿è¡Œgit addå’Œgit commitä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„ Gitå¯¹è±¡ï¼ˆGit Objectï¼‰ ä¸Šé¢çš„å˜åŒ–ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿè¦çŸ¥é“Gitä¸­çš„å‡ ä¹ä¸€åˆ‡éƒ½è¢«å­˜å‚¨ä¸ºGitå¯¹è±¡ï¼ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡Gitå¯¹è±¡è¿›è¡Œæ“ä½œæ¥å®Œæˆä¸Šé¢çš„å˜åŒ–ã€‚è¯´äº†è¿™ä¹ˆå¤šï¼Œè®©æˆ‘ä»¬æ¥ä¸ºGitå¯¹è±¡ä¸‹ä¸€ä¸ªæ¯”è¾ƒå®˜æ–¹çš„å®šä¹‰ï¼šGitå¯¹è±¡å°±æ˜¯åœ¨ Git ä»“åº“ä¸­çš„æ–‡ä»¶ï¼Œå®ƒä»¬çš„è·¯å¾„ç”±å®ƒä»¬çš„å†…å®¹å†³å®šã€‚\nGitå¯¹è±¡èŒƒæ€§å¯ä»¥å€Ÿç”±pythonæ¥å®ç°ï¼š\nclass GitObject (object): def __init__(self, data=None): if data != None: self.deserialize(data) else: self.init() def serialize(self): \"\"\"å°†å¯¹è±¡è½¬å˜ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼\"\"\" raise Exception(\"Unimplemented!\") def deserialize(self, data): \"\"\"dataé€šå¸¸ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼ï¼Œæ ¹æ®ç±»å‹è§£ç \"\"\" raise Exception(\"Unimplemented!\") def init(self): pass # Just do nothing. This is a reasonable default! Gitå¯¹è±¡åˆç»†åˆ†ä¸ºä»¥ä¸‹å››ç§ç±»å‹ï¼šGitBlobï¼ˆBinary Large Objectï¼‰å¯¹è±¡ï¼Œ GitCommitå¯¹è±¡ï¼Œ GitTreeå¯¹è±¡ï¼Œ GitTagå¯¹è±¡ï¼Œä»¥ä¸‹åˆ†åˆ«è¿›è¡Œä»‹ç»ã€‚\nGitBlobå¯¹è±¡ æˆ‘ä»¬å…ˆæœ€ç›´è§‚çš„çœ‹çœ‹Gitä¸­å¯¹äºBlobå†…å®¹çš„å±•ç¤ºï¼Œå¦‚å›¾4æ‰€ç¤ºï¼š\nå›¾4ï¼šè¿è¡Œgit cat-fileä¹‹åå¯¹a.txtæ‰€å¯¹åº”çš„ç±»å‹å’Œç±»å‹å†…å®¹çš„å±•ç¤º Blobs æ˜¯ç”¨æˆ·æ•°æ®ï¼šä½ æ”¾å…¥ Git ä¸­çš„æ¯ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼ˆå¦‚a.txtã€b.txtã€src/c.txtã€src/d.txtä¸­çš„å†…å®¹ï¼‰çš„å­—èŠ‚å½¢å¼éƒ½è¢«å­˜å‚¨ä¸ºä¸€ä¸ª blobã€‚è¿™æ ·åšä½¿å®ƒä»¬å¾ˆå®¹æ˜“æ“ä½œï¼Œå› ä¸º blob æ²¡æœ‰ç‰¹å®šçš„è¯­æ³•æˆ–çº¦æŸï¼Œé™¤äº†åŸºæœ¬çš„å¯¹è±¡å­˜å‚¨æœºåˆ¶ä¹‹å¤–ï¼Œå®ƒä»¬åªæ˜¯æœªæŒ‡å®šçš„æ•°æ®ã€‚\nGitBlobå¯¹è±¡çš„pythonå®ç°å¦‚ä¸‹ï¼š\nclass GitBlob(GitObject): fmt=b'blob' def serialize(self): return self.blobdata def deserialize(self, data): self.blobdata = data GitTreeå¯¹è±¡ åŒä¸Šï¼Œæˆ‘ä»¬å…ˆæœ€ç›´è§‚çš„çœ‹çœ‹Gitä¸­å¯¹äºæ ‘å†…å®¹çš„å±•ç¤ºï¼Œå¦‚å›¾5æ‰€ç¤ºï¼š\nå›¾5ï¼šè¿è¡Œgit cat-fileä¹‹åå¯¹æœ€é¡¶å±‚çš„æ ‘æ‰€å¯¹åº”çš„ç±»å‹å’Œç±»å‹å†…å®¹çš„å±•ç¤º éæ­£å¼åœ°è¯´ï¼Œæ ‘ï¼ˆtreeï¼‰æè¿°äº†Gitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹ï¼Œå®ƒå°† blobsï¼ˆæ–‡ä»¶å¯¹è±¡ï¼‰ä¸è·¯å¾„å…³è”èµ·æ¥ã€‚æ ‘æ˜¯ä¸€ä¸ªç”±ä¸‰ä¸ªå…ƒç´ ç»„æˆçš„å…ƒç»„æ•°ç»„ï¼Œè¿™äº›å…ƒç´ åŒ…æ‹¬æ–‡ä»¶æ¨¡å¼ã€ç›¸å¯¹äºå·¥ä½œæ ‘çš„è·¯å¾„ï¼Œä»¥åŠä¸€ä¸ª SHA-1 å€¼ã€‚ä¸€ä¸ªå…¸å‹çš„æ ‘çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š\nMode SHA-1 Path 100644 06f844865cfc4b68116d2cbf00833b294aae63ec .DS_Store 100644 e12523960bf9941182c801077be75dce699ff37c a.txt 100644 753e270e92068316ec7fa2b6a40e780a4e1d14d7 b.txt 040000 30d66379dddee7068ab4fd3a17cc1ef9555278ac src æ¨¡å¼ï¼ˆModeï¼‰å°±æ˜¯æ–‡ä»¶çš„æ¨¡å¼ï¼Œè·¯å¾„ï¼ˆPathï¼‰æ˜¯æ–‡ä»¶çš„ä½ç½®ã€‚SHA-1 æ˜¯æŒ‡å‘ä¸€ä¸ª blob æˆ–å¦ä¸€ä¸ªæ ‘å¯¹è±¡ã€‚å¦‚æœæ˜¯ blobï¼Œè·¯å¾„è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼›å¦‚æœæ˜¯æ ‘å¯¹è±¡ï¼Œè·¯å¾„è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªç›®å½•ã€‚\nå¸¸è§çš„æ–‡ä»¶æ¨¡å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š\n100644: æ™®é€šæ–‡ä»¶ï¼Œå…·æœ‰æ ‡å‡†çš„è¯»å†™æƒé™ï¼ˆæ™®é€šçš„æ–‡æœ¬æ–‡ä»¶æˆ–ä»£ç æ–‡ä»¶ï¼‰ã€‚ 100755: å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå…·æœ‰æ‰§è¡Œæƒé™ï¼ˆå¦‚è„šæœ¬æˆ–å¯æ‰§è¡Œç¨‹åºï¼‰ã€‚ 040000: ç›®å½•ï¼ˆdirectoryï¼‰ã€‚ 120000: ç¬¦å·é“¾æ¥ï¼ˆsymbolic linkï¼‰ã€‚ 160000: Git å­æ¨¡å—ï¼ˆsubmoduleï¼‰ã€‚ è€Œå®é™…ä¸Šå½“æˆ‘ä»¬è§£ææ ‘çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å¯¹.git/objectsä¸­æ ‘çš„SHA-1è·¯å¾„æ‰€ä»£è¡¨çš„æ–‡ä»¶è¿›è¡Œè§£å‹ç¼©åæçº¯åˆ°çš„æ ‘å¯¹è±¡å†…å®¹çš„å­—èŠ‚ç¼–ç ï¼Œå®ƒä»¬çš„æ ¼å¼é€šå¸¸å¦‚ä¸‹ï¼š\n[mode] space [path] 0x00 [sha-1] ï¼ˆbyteæ ¼å¼ï¼‰\nç”±äºæ ‘å¯¹åº”çš„æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ä¸æ­¢ä¸€ä¸ªï¼Œæœ‰æ—¶ç”šè‡³ä¼šæœ‰åœ¨æ–‡ä»¶å¤¹ä¸­è¿›è¡Œæ–‡ä»¶å¤¹åµŒå¥—ã€‚å› æ­¤æˆ‘ä»¬è¦è®¾è®¡å‡ºå¶å­å¯¹åº”å•ä¸ªæ–‡ä»¶ï¼Œæ ‘å¯¹åº”ç”±ä¸åŒæ–‡ä»¶æ‰€ç»„æˆçš„æ–‡ä»¶å¤¹ã€‚\næˆ‘ä»¬å¯ä»¥å°†å¶å­å¯¹è±¡å’Œæ ‘å¯¹è±¡æŒ‰ä»¥ä¸‹pythonä»£ç æ¥è¡¨ç¤ºï¼š\nclass GitTreeLeaf (object): def __init__(self, mode, path, sha): self.mode = mode # æ¨¡å¼ self.path = path # æ–‡ä»¶è·¯å¾„ self.sha = sha # æ–‡ä»¶è·¯å¾„ç´¢å¼•åˆ°çš„æ–‡ä»¶å†…å®¹æ ‡å‡†åŒ–åæ‰€å¯¹åº”çš„sha-1å€¼ class GitTree(GitObject): fmt=b'tree' def deserialize(self, data): # tree_parseæ˜¯è§£ææ‰€å¾—åˆ°çš„æ ‘å¯¹è±¡çš„å­—èŠ‚ç¼–ç æ•°æ® self.items = tree_parse(data) def serialize(self): # tree_serializeå°†è§£æåçš„ç»“æœæ±‚é€†å¾—åˆ°æ ‘å¯¹è±¡çš„å­—èŠ‚ç¼–ç æ•°æ® return tree_serialize(self) def init(self): self.items = list() ç”±äºä¸€ä¸ªæ ‘ä¸­æœ‰æ—¶ä¸å•å•åŒ…å«å¶å­æ›´æœ‰å¯èƒ½åŒ…å«å­æ ‘ï¼Œå…·ä½“æƒ…å½¢è§ä¸Šé¢ä¸€æ£µæ ‘çš„å…¸å‹æƒ…å†µï¼Œtree_parseå’Œtree_serializeå‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š\ndef tree_parse(raw): pos = 0 max = len(raw) ret = list() while pos \u003c max: pos, data = tree_parse_one(raw, pos) ret.append(data) return ret def tree_parse_one(raw, start=0): # [mode] space [path] 0x00 [sha-1] ï¼ˆbyteæ ¼å¼ï¼‰ # æŸ¥æ‰¾å­—èŠ‚å½¢å¼ç©ºæ ¼ä»¥ç¡®å®šmode x = raw.find(b' ', start) assert x-start == 5 or x-start==6 # è¯»å–mode mode = raw[start:x] if len(mode) == 5: # æ ‡å‡†åˆ°6å­—èŠ‚ mode = b\"0\" + mode # æŸ¥æ‰¾å­—èŠ‚å½¢å¼ç©ºç»ˆæ­¢ç¬¦ä»¥ç¡®å®špath y = raw.find(b'\\x00', x) # è¯»å–path path = raw[x+1:y] # è¯»å–shaâ€¦ # raw[y+1:y+21] æå–çš„æ˜¯ 20 å­—èŠ‚çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆSHA-1 å“ˆå¸Œå€¼ï¼‰ã€‚ raw_sha = int.from_bytes(raw[y+1:y+21], \"big\") # int.from_bytes(raw[y+1:y+21], \"big\")å°†æå–çš„ 20 å­—èŠ‚äºŒè¿›åˆ¶æ•°æ®è½¬ # æ¢ä¸ºä¸€ä¸ªæ•´æ•°ï¼Œç„¶åä½¿ç”¨ format(raw_sha, \"040x\") å°†è¿™ä¸ªæ•´æ•°è½¬æ¢ä¸º 40 # ä½çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸² ã€‚Gitä¸­é€šå¸¸ä½¿ç”¨çš„shaå€¼æ—¶è¿™ç§å½¢å¼ã€‚æ¯”å¦‚.DS_Storeå¯¹åº” # çš„06f844865cfc4b68116d2cbf00833b294aae63ec sha = format(raw_sha, \"040x\") return y+21, GitTreeLeaf(mode, path.decode(\"utf8\"), sha) def tree_serialize(obj): obj.items.sort(key=tree_leaf_sort_key) ret = b'' for i in obj.items: ret += i.mode ret += b' ' ret += i.path.encode(\"utf8\") ret += b'\\x00' sha = int(i.sha, 16) ret += sha.to_bytes(20, byteorder=\"big\") return ret def tree_leaf_sort_key(leaf): if leaf.mode.startswith(b\"10\"): return leaf.path # æ–‡ä»¶ else: return leaf.path + \"/\" # æ–‡ä»¶å¤¹ GitCommitå¯¹è±¡ åŒä¸Šï¼Œæˆ‘ä»¬å…ˆæœ€ç›´è§‚çš„çœ‹çœ‹Gitä¸­å¯¹äºæ ‘å†…å®¹çš„å±•ç¤ºï¼Œå¦‚å›¾6æ‰€ç¤ºï¼š\nå›¾6ï¼šè¿è¡Œgit cat-fileä¹‹åå¯¹æœ€é¡¶å±‚çš„æäº¤æ‰€å¯¹åº”çš„ç±»å‹å’Œç±»å‹å†…å®¹çš„å±•ç¤º ä¸€ä¸ªæäº¤ï¼ˆCommitï¼‰çš„å…¸å‹å¦‚ä¸‹æ‰€ç¤ºï¼š\ntree 50306289de5ae719af85eaad3430d785517a11e7 parent 735a65cef921f8e30ae55fdf19b695eb15ea8d45 author fordelkon \u003c27xxx88816@qq.com\u003e 1741406298 +0800 committer fordelkon \u003c27xxx88816@qq.com\u003e 1741406298 +0800 life is short, I use Python ä»ä¸Šé¢çš„å…¸å‹æ¥çœ‹ï¼Œä¸€ä¸ªæäº¤ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š\næ ‘å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å·¥ä½œæ ‘çš„å†…å®¹ã€æ–‡ä»¶å’Œç›®å½•ï¼› é›¶ä¸ªã€ä¸€ä¸ªæˆ–å¤šä¸ªçˆ¶æäº¤ï¼› ä¸€ä¸ªä½œè€…èº«ä»½ï¼ˆå§“åå’Œé‚®ç®±ï¼‰ä»¥åŠä¸€ä¸ªæ—¶é—´æˆ³ï¼› ä¸€ä¸ªæäº¤è€…èº«ä»½ï¼ˆå§“åå’Œé‚®ç®±ï¼‰ä»¥åŠä¸€ä¸ªæ—¶é—´æˆ³ï¼› ä¸€ä¸ªæäº¤ä¿¡æ¯ã€‚ ä»æäº¤çš„ç»„æˆæ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç™½å·²ç»åˆ›å»ºå¥½çš„æäº¤æ˜¯ä¸å¯å˜çš„ã€‚å¦‚æœæˆ‘ä»¬æ›´æ”¹äº†ä½œè€…ã€çˆ¶æäº¤æˆ–ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å®é™…ä¸Šæœ€ç»ˆä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ã€ä¸åŒçš„æäº¤å¯¹è±¡ä¸æ”¹å˜åçš„ç»“æœç»‘å®šã€‚æ‰€ä»¥æ¯ä¸€ä¸ªæäº¤éƒ½ä¸å®ƒåœ¨æ•´ä¸ªä»“åº“ä¸­çš„ä½ç½®åŠå…¶ä¸æœ€åˆæäº¤çš„å…³ç³»ç´§å¯†ç›¸è¿ã€‚æ¢å¥è¯è¯´ï¼Œä¸€ä¸ªç»™å®šçš„æäº¤ ID ï¼ˆsha-1ï¼‰ä¸ä»…æ ‡è¯†äº†æŸäº›æ–‡ä»¶çš„å†…å®¹ï¼Œè¿˜å°†æäº¤ä¸å®ƒçš„æ•´ä¸ªå†å²åŠæ•´ä¸ªä»“åº“ç»‘å®šåœ¨ä¸€èµ·ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰äº†æäº¤ï¼Œæˆ‘ä»¬çš„Gitçš„å†å²è®°å½•åŠŸèƒ½å°±æœ‰äº†ä¿è¯ï¼ ä¸€ä¸ªæäº¤å¯¹è±¡çš„pythonä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\nclass GitCommit(GitObject): fmt=b'commit' def deserialize(self, data): # kvlm_parseæ˜¯è§£ææ‰€å¾—åˆ°çš„æäº¤å¯¹è±¡çš„å­—èŠ‚ç¼–ç æ•°æ® self.kvlm = kvlm_parse(data) def serialize(self): # kvlm_serializeå°†è§£æåçš„ç»“æœæ±‚é€†å¾—åˆ°æäº¤å¯¹è±¡çš„å­—èŠ‚ç¼–ç æ•°æ® return kvlm_serialize(self.kvlm) def init(self): self.kvlm = dict() ç”±æäº¤çš„å…¸å‹æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†æäº¤å¯¹è±¡çš„å­—èŠ‚ç¼–ç æ•°æ®è½¬æ¢æˆé”®å€¼å¯¹çš„å­—å…¸æ ¼å¼ï¼Œç”±äºæœ‰ç©ºæ ¼å’Œå›è½¦ã€‚æ›´å½¢è±¡çš„è¡¨ç¤ºå¦‚ä¸‹:\n[key1] space [value1] \\n â€¦ [keyn] space [valuen] \\n [commit]\nå› æ­¤ï¼Œkvlm_parseå’Œkvlm_serializeçš„pythonä»£ç å¦‚ä¸‹æ‰€ç¤º\ndef kvlm_parse(raw, start=0, dct=None): # å¦‚æœ dct ä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸€ä¸ªç©ºå­—å…¸ if not dct: dct = dict() # ä¸èƒ½åœ¨å‡½æ•°å‚æ•°ä¸­ç›´æ¥å£°æ˜ dct=dict()ï¼Œå¦åˆ™æ‰€æœ‰å‡½æ•°è°ƒç”¨ä¼šå…±ç”¨åŒä¸€ä¸ªå­—å…¸ï¼Œ # å¯¼è‡´æ¯æ¬¡è°ƒç”¨æ—¶å­—å…¸ä¸æ–­å¢é•¿ã€‚ # è¿™ä¸ªå‡½æ•°æ˜¯é€’å½’çš„ï¼šå®ƒè¯»å–ä¸€ä¸ªé”®/å€¼å¯¹ï¼Œç„¶åè°ƒç”¨è‡ªèº«æ¥å¤„ç†ä¸‹ä¸€ä¸ªä½ç½®ã€‚ # å› æ­¤æˆ‘ä»¬é¦–å…ˆéœ€è¦çŸ¥é“å½“å‰çš„ä½ç½®ï¼šæ˜¯åœ¨ä¸€ä¸ªå…³é”®å­—ï¼Œè¿˜æ˜¯å·²ç»åˆ°äº†æ¶ˆæ¯éƒ¨åˆ†ã€‚ # æŸ¥æ‰¾ä¸‹ä¸€ä¸ªç©ºæ ¼å’Œæ¢è¡Œç¬¦çš„ä½ç½® spc = raw.find(b' ', start) nl = raw.find(b'\\n', start) # å¦‚æœç©ºæ ¼å‡ºç°åœ¨æ¢è¡Œç¬¦ä¹‹å‰ï¼Œè¯´æ˜æˆ‘ä»¬æœ‰ä¸€ä¸ªå…³é”®å­—ã€‚å¦åˆ™ï¼Œå®ƒæ˜¯æœ€ç»ˆçš„æ¶ˆæ¯éƒ¨åˆ†ï¼Œ # æˆ‘ä»¬ä¼šè¯»å–ç›´åˆ°æ–‡ä»¶çš„æœ«å°¾ã€‚ # åŸºæœ¬æƒ…å†µ # ========= # å¦‚æœæ¢è¡Œç¬¦å…ˆå‡ºç°ï¼ˆæˆ–è€…æ ¹æœ¬æ²¡æœ‰ç©ºæ ¼ï¼Œè¿™ç§æƒ…å†µä¸‹ find è¿”å› -1ï¼‰ï¼Œ # æˆ‘ä»¬å‡è®¾é‡åˆ°äº†ä¸€ä¸ªç©ºè¡Œã€‚ç©ºè¡Œæ„å‘³ç€å‰©ä½™çš„æ•°æ®æ˜¯æ¶ˆæ¯éƒ¨åˆ†ã€‚ # æˆ‘ä»¬å°†å®ƒå­˜å‚¨åœ¨å­—å…¸ä¸­ï¼Œé”®ä¸º Noneï¼Œç„¶åè¿”å›ã€‚ if (spc \u003c 0) or (nl \u003c spc): assert nl == start dct[None] = raw[start+1:] # å­˜å‚¨æ¶ˆæ¯éƒ¨åˆ† return dct # é€’å½’æƒ…å†µ # ============== # è¯»å–ä¸€ä¸ªé”®å€¼å¯¹å¹¶é€’å½’å¤„ç†ä¸‹ä¸€ä¸ªã€‚ key = raw[start:spc] # æŸ¥æ‰¾å€¼çš„ç»“å°¾ã€‚ä»¥ç©ºæ ¼å¼€å¤´çš„è¡Œè¡¨ç¤ºå€¼çš„å»¶ç»­è¡Œï¼Œ # å› æ­¤æˆ‘ä»¬éœ€è¦å¾ªç¯ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªä¸æ˜¯ä»¥ç©ºæ ¼å¼€å¤´çš„æ¢è¡Œç¬¦ã€‚ end = start while True: end = raw.find(b'\\n', end+1) if raw[end+1] != ord(' '): break # æ‰¾åˆ°ä¸€ä¸ªä¸ä»¥ç©ºæ ¼å¼€å¤´çš„æ¢è¡Œç¬¦ # è·å–å€¼ï¼ŒåŒæ—¶åˆ é™¤å»¶ç»­è¡Œçš„å‰å¯¼ç©ºæ ¼ value = raw[spc+1:end].replace(b'\\n ', b'\\n') # ä¸è¦è¦†ç›–ç°æœ‰çš„æ•°æ®å†…å®¹ if key in dct: # å¦‚æœå­—å…¸ä¸­å·²æœ‰è¯¥é”®ï¼Œä¸”å€¼ä¸ºåˆ—è¡¨ï¼Œåˆ™ç›´æ¥æ·»åŠ æ–°å€¼ if type(dct[key]) == list: dct[key].append(value) else: # å¦‚æœå·²æœ‰çš„å€¼ä¸æ˜¯åˆ—è¡¨ï¼Œåˆ›å»ºä¸€ä¸ªåˆ—è¡¨æ¥å­˜å‚¨å¤šä¸ªå€¼ dct[key] = [ dct[key], value ] else: # å¦‚æœå­—å…¸ä¸­æ²¡æœ‰è¯¥é”®ï¼Œåˆ™ç›´æ¥å­˜å‚¨é”®å€¼å¯¹ dct[key]=value # é€’å½’å¤„ç†å‰©ä½™çš„éƒ¨åˆ† return kvlm_parse(raw, start=end+1, dct=dct) def kvlm_serialize(kvlm): ret = b'' # åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„å­—èŠ‚ä¸²ç”¨äºå­˜å‚¨åºåˆ—åŒ–ç»“æœ # è¾“å‡ºå­—æ®µ for k in kvlm.keys(): # è·³è¿‡æ¶ˆæ¯ä½“æœ¬èº«ï¼ˆæ¶ˆæ¯å­˜å‚¨åœ¨å­—å…¸çš„ None é”®ä¸­ï¼‰ if k == None: continue val = kvlm[k] # å°†å•ä¸ªå€¼è§„èŒƒåŒ–ä¸ºåˆ—è¡¨ï¼Œä»¥ä¾¿ç»Ÿä¸€å¤„ç† if type(val) != list: val = [ val ] # éå†å€¼åˆ—è¡¨ï¼Œå¤„ç†æ¯ä¸ªå€¼ for v in val: # æ‹¼æ¥é”®å’Œå€¼ï¼Œå¹¶ç¡®ä¿æ¢è¡Œç¬¦åé¢æœ‰ä¸€ä¸ªç©ºæ ¼ï¼ˆç”¨äºè¡¨ç¤ºå€¼çš„å»¶ç»­è¡Œï¼‰ ret += k + b' ' + (v.replace(b'\\n', b'\\n ')) + b'\\n' # æœ€åæ‹¼æ¥æ¶ˆæ¯ä½“ï¼Œæ¶ˆæ¯ä½“ä¹‹å‰éœ€è¦ä¸€ä¸ªç©ºè¡Œåˆ†éš” ret += b'\\n' + kvlm[None] return ret # è¿”å›åºåˆ—åŒ–åçš„å­—èŠ‚ä¸² GitTagå¯¹è±¡ æ ‡ç­¾å®é™…ä¸Šå°±æ˜¯å¼•ç”¨ï¼ˆrefsï¼‰ã€‚å®ƒä»¬ä½äº .git/refs/tags/ ç›®å½•ä¸‹ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ ‡ç­¾æœ‰ä¸¤ç§ç±»å‹ï¼šè½»é‡æ ‡ç­¾å’Œæ ‡ç­¾å¯¹è±¡ã€‚\nè½»é‡æ ‡ç­¾ï¼ˆâ€œLightweightâ€ tagsï¼‰ ä»…ä»…æ˜¯æŒ‡å‘æäº¤ã€æ ‘å¯¹è±¡æˆ– blob å¯¹è±¡çš„æ™®é€šå¼•ç”¨ã€‚\næ ‡ç­¾å¯¹è±¡ï¼ˆTag objectsï¼‰ æ˜¯æŒ‡å‘æ ‡ç­¾ç±»å‹å¯¹è±¡çš„æ™®é€šå¼•ç”¨ã€‚ä¸è½»é‡æ ‡ç­¾ä¸åŒï¼Œæ ‡ç­¾å¯¹è±¡åŒ…å«ä½œè€…ã€æ—¥æœŸã€å¯é€‰çš„ PGP ç­¾åä»¥åŠå¯é€‰çš„æ³¨é‡Šã€‚å®ƒä»¬çš„æ ¼å¼ä¸æäº¤å¯¹è±¡ç›¸åŒã€‚\nå› æ­¤ï¼ŒGitTagçš„pythonä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\nclass GitTag(GitCommit): fmt = b'tag' æˆ‘ä»¬å·²ç»äº†è§£äº†ä¸Šé¢å››ç§Gitå¯¹è±¡ï¼Œç”±Gitå¯¹è±¡çš„å†…å®¹å†³å®šè·¯å¾„çš„æ€§è´¨ï¼Œå¯ä»¥ä¿è¯å¯¹äºééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ä¸€æ—¦è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆç›¸åº”çš„Gitå¯¹è±¡çš„è·¯å¾„ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜ï¼Œå°†ä¿®æ”¹åçš„ä¸åŒçš„Gitå¯¹è±¡çš„æ–‡ä»¶æ ‡å‡†åŒ–åå‹ç¼©æŒ‰ç…§æ”¹å˜çš„è·¯å¾„å­˜å‚¨åœ¨.git/objectsæ–‡ä»¶å¤¹ä¸‹ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å¯¹è¯¥æ”¹å˜çš„è®°å½•ã€‚é‚£ä¹ˆæ–‡ä»¶çš„å†…å®¹å’Œæ–‡ä»¶çš„è·¯å¾„æœ‰ç€æ˜ç¡®çš„æ˜ å°„å…³ç³»å—ï¼ŸGitç»™å‡ºçš„ç­”æ¡ˆæ˜¯å¯¹æ ‡å‡†åŒ–åçš„æ–‡ä»¶å†…å®¹è¿›è¡ŒÂ SHA-1å“ˆå¸Œåå¾—åˆ°æ–‡ä»¶çš„è·¯å¾„ã€‚å¦‚ä½•è¿›è¡Œæ ‡å‡†åŒ–ä¹Ÿæ˜¯æˆ‘ä»¬å€¼å¾—æ³¨æ„çš„ï¼ŒGitä¸­å®ç°çš„æ–¹æ¡ˆæ˜¯å­—èŠ‚å½¢å¼ç±»å‹å¤´+å­—èŠ‚å½¢å¼ç©ºæ ¼+å­—èŠ‚å½¢å¼å¤§å°+å­—èŠ‚å½¢å¼ç©ºåˆ†ç¦»ç¬¦+å¯¹è±¡å†…å®¹çš„å­—èŠ‚ç¼–ç ã€‚ å…·ä½“æ–¹æ¡ˆå¦‚ä¸‹æ‰€ç¤ºï¼š\n[fmt] space [size] 0x00 [data] (byteæ ¼å¼)\næ ¹æ®è¿™ä¸€æ ‡å‡†åŒ–çš„å½¢å¼æˆ‘ä»¬å¯ä»¥å¯¹å¯¹è±¡è¿›è¡Œè¯»å’Œå†™æ“ä½œï¼Œæ‰€æœ‰å¯¹è±¡çš„æ ¸å¿ƒè½½ä½“æ˜¯å¯¹è±¡å†…å®¹çš„å­—èŠ‚ç¼–ç ã€‚å…·ä½“pythonä»£ç å¦‚ä¸‹ï¼š\ndef object_read(repo, sha): \"\"\"Read object sha from Git repository repo. Return a GitObject whose exact type depends on the object.\"\"\" # ç”±sha1å€¼å¾—åˆ°å¯¹åº”è·¯å¾„ path = repo_file(repo, \"objects\", sha[0:2], sha[2:]) if not os.path.isfile(path): return None with open (path, \"rb\") as f: raw = zlib.decompress(f.read()) # è¯»å–å¯¹è±¡ç±»å‹ x = raw.find(b' ') # 0x20 å­—èŠ‚å½¢å¼ç©ºæ ¼ fmt = raw[0:x] # å­—èŠ‚å½¢å¼ç±»å‹å¤´ # è¯»å–æœ‰æ•ˆçš„å¯¹è±¡å¤§å° y = raw.find(b'\\x00', x) # 0x00 å­—èŠ‚å½¢å¼ç©ºåˆ†ç¦»ç¬¦ size = int(raw[x:y].decode(\"ascii\")) if size != len(raw)-y-1: raise Exception(f\"Malformed object {sha}: bad length\") # æ ¹æ®å¯¹è±¡ç±»å‹é€‰æ‹©ç”Ÿæˆå™¨ match fmt: case b'commit' : c=GitCommit case b'tree' : c=GitTree case b'tag' : c=GitTag case b'blob' : c=GitBlob case _: raise Exception(f\"Unknown type {fmt.decode(\"ascii\")} for object {sha}\") # è°ƒç”¨ç”Ÿæˆå™¨è¿”å›å¯¹è±¡ return c(raw[y+1:]) # raw[y+1:]å¯¹è±¡å†…å®¹çš„å­—èŠ‚ç¼–ç  def object_write(obj, repo=None): # å¯¹è±¡å†…å®¹çš„å­—èŠ‚ç¼–ç  data = obj.serialize() # æ·»åŠ ä¸€äº›å‰ç¼€æˆä¸ºæ ‡å‡†æ ¼å¼ result = obj.fmt + b' ' + str(len(data)).encode() + b'\\x00' + data # è®¡ç®—sha1 sha = hashlib.sha1(result).hexdigest() if repo: # ç”±sha1å€¼å¾—åˆ°å¯¹åº”è·¯å¾„ path=repo_file(repo, \"objects\", sha[0:2], sha[2:], mkdir=True) if not os.path.exists(path): with open(path, 'wb') as f: # Compress and write f.write(zlib.compress(result)) return sha å¥½äº†ï¼Œå‰æˆå·²ç»å‡†å¤‡äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬å¯ä»¥å‡­å€ŸGitä»“åº“å’ŒGitå¯¹è±¡æ¥å®ç°æœ€æœ€æœ€é‡è¦çš„Gitä¸¤è¿å‡»å—ï¼ˆgit addå’Œgit commitï¼‰ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯â€¦â€¦å¦å®šçš„ã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬å·²ç»æ‹¥æœ‰äº†è¿™ä¹ˆå¤šçš„å¯¹è±¡ï¼Œä¹Ÿæœ‰äº†è¯»å–å’Œå†™å…¥å¯¹è±¡çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬æ”¹å˜æ–‡ä»¶ï¼ˆä¸å¦¨å°±æ”¹å˜a.txtæ–‡ä»¶çš„å†…å®¹ï¼‰ï¼Œç”±å‰é¢æˆ‘ä»¬è¯´çš„ä¸»è¦çš„ä¸‰ç§å¯¹è±¡æ¥çœ‹ï¼ŒGitBlobå…ƒæ•°æ®ä¼šæ”¹å˜ï¼Œéšä¹‹è€Œæ¥çš„GitTreeå…ƒæ•°æ®ä¼šæ”¹å˜ï¼Œè¿›è€ŒGitCommitå…ƒæ•°æ®ä¹Ÿä¼šæ”¹å˜ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸æ˜¯ä¸€æŒ¥è€Œå°±çš„ï¼Œæ‰€ä»¥Gitç§æ‰ä¼šåˆ†ä¸ºgit addå’Œgit commitä¸¤æ­¥èµ°ã€‚åœ¨git addçš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å°†ä¿®æ”¹åçš„æ–‡ä»¶å±æ€§å˜åŒ–æäº¤åˆ°æš‚å­˜åŒºï¼ˆStaging areaï¼‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å›¾3ä¸­çš„.git/indexæ–‡ä»¶ä¸­ã€‚ç„¶åä½¿ç”¨git commitå°†æš‚å­˜åŒºä¸­çš„æ‰€æœ‰è®°å½•çš„æ–‡ä»¶ç»Ÿåˆç”Ÿæˆæ–°çš„GitTreeï¼Œè¿›è€Œç”Ÿæˆæ–°çš„GitCommitã€‚å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªè¡¨ç¤ºæš‚å­˜åŒºçš„ç±»å‹ã€‚\næš‚å­˜åŒºï¼ˆStaging areaï¼‰ æš‚å­˜åŒºåœ¨.gitæ–‡ä»¶å¤¹ä¸­çš„å±•ç°å½¢å¼å°±æ˜¯.git/indexæ–‡ä»¶ï¼Œåœ¨ä¸€æ¬¡æäº¤ä¹‹åï¼Œ.git/indexæ–‡ä»¶å¯ä»¥çœ‹ä½œæ˜¯è¯¥æäº¤çš„ä¸€ç§å‰¯æœ¬ï¼šå®ƒä¿å­˜äº†ä¸å¯¹åº”çš„æ ‘ç›¸åŒçš„è·¯å¾„/Blobï¼ˆå¯¹è±¡ï¼‰çš„å…³è”å…³ç³»ã€‚ä½†å®ƒè¿˜ä¿å­˜äº†Gitä»“åº“ä¸­å…³äºæ–‡ä»¶çš„é¢å¤–ä¿¡æ¯ï¼Œæ¯”å¦‚å®ƒä»¬çš„åˆ›å»º/ä¿®æ”¹æ—¶é—´ï¼Œå› æ­¤ git status é€šå¸¸ä¸éœ€è¦å®é™…æ¯”è¾ƒæ–‡ä»¶ï¼šå®ƒåªéœ€è¦æ£€æŸ¥æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´æ˜¯å¦ä¸ç´¢å¼•æ–‡ä»¶ä¸­å­˜å‚¨çš„æ—¶é—´ç›¸åŒï¼Œåªæœ‰å½“å®ƒä»¬ä¸åŒæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œå®é™…çš„æ¯”è¾ƒã€‚ç±»æ¯”æ ‘å¯¹è±¡çš„è¡¨ç¤ºï¼Œ.git/indexæ–‡ä»¶ä¸­åŒ…å«è®¸å¤šå…ƒç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯å¯¹å•ä¸ªå…ƒç´ è¿›è¡Œè¡¨ç¤ºï¼Œä¹‹åæ˜¯å¯¹æ•´ä½“.git/indexæ–‡ä»¶è¿›è¡Œè¡¨ç¤ºã€‚\nå•ä¸ªå…ƒç´ å’Œæ•´ä½“.git/indexæ–‡ä»¶çš„pythonè¡¨ç¤ºå¦‚ä¸‹ï¼š\nclass GitIndexEntry (object): def __init__(self, ctime=None, mtime=None, dev=None, ino=None, mode_type=None, mode_perms=None, uid=None, gid=None, fsize=None, sha=None, flag_assume_valid=None, flag_stage=None, name=None): # æ–‡ä»¶å…ƒæ•°æ®æœ€åæ›´æ”¹çš„æ—¶é—´ã€‚æ ¼å¼æ˜¯ä¸€ä¸ªäºŒå…ƒç»„ # (ä»¥ç§’ä¸ºå•ä½çš„æ—¶é—´æˆ³, çº³ç§’) self.ctime = ctime # æ–‡ä»¶æ•°æ®æœ€åæ›´æ”¹çš„æ—¶é—´ã€‚æ ¼å¼æ˜¯ä¸€ä¸ªäºŒå…ƒç»„ # (ä»¥ç§’ä¸ºå•ä½çš„æ—¶é—´æˆ³, çº³ç§’) self.mtime = mtime # åŒ…å«è¯¥æ–‡ä»¶çš„è®¾å¤‡ID self.dev = dev # æ–‡ä»¶çš„inodeç¼–å· self.ino = ino # å¯¹è±¡ç±»å‹ï¼Œå¯ä»¥æ˜¯ b1000 (æ™®é€šæ–‡ä»¶), b1010 (ç¬¦å·é“¾æ¥), # b1110 (gitlink) self.mode_type = mode_type # å¯¹è±¡çš„æƒé™ï¼Œè¡¨ç¤ºä¸ºä¸€ä¸ªæ•´æ•° self.mode_perms = mode_perms # æ–‡ä»¶æ‰€æœ‰è€…çš„ç”¨æˆ·ID self.uid = uid # æ–‡ä»¶æ‰€æœ‰è€…çš„ç»„ID self.gid = gid # å¯¹è±¡çš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ self.fsize = fsize # å¯¹è±¡çš„SHAå“ˆå¸Œå€¼ self.sha = sha # æ ‡å¿—ï¼šå‡è®¾è¯¥å¯¹è±¡æœ‰æ•ˆ self.flag_assume_valid = flag_assume_valid # æ–‡ä»¶çš„é˜¶æ®µæ ‡å¿— self.flag_stage = flag_stage # å¯¹è±¡çš„åç§°ï¼ˆåŒ…æ‹¬å®Œæ•´è·¯å¾„ï¼‰ self.name = name class GitIndex (object): version = None entries = [] # ext = None # sha = None def __init__(self, version=2, entries=None): if not entries: entries = list() self.version = version self.entries = entries .git/indexæ–‡ä»¶æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯å‡ºäºæ€§èƒ½è€ƒè™‘ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒçš„æ ¼å¼ç›¸å¯¹ç®€å•ã€‚æ–‡ä»¶å¼€å§‹éƒ¨åˆ†æ˜¯ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯ï¼ŒåŒ…å«äº† DIRC é­”æ³•å­—èŠ‚ã€ç‰ˆæœ¬å·ä»¥åŠè¯¥ç´¢å¼•æ–‡ä»¶ä¸­çš„æ¡ç›®æ€»æ•°ã€‚æ›´å½¢è±¡çš„æ ¼å¼å¦‚ä¸‹ï¼š\n[DIRC] [version] [count] [entries]\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®šä¹‰index_readå’Œindex_writeå‡½æ•°å¦‚ä¸‹ï¼š\ndef index_read(repo): # è·å–ä»“åº“ç´¢å¼•æ–‡ä»¶çš„è·¯å¾„ index_file = repo_file(repo, \"index\") # å¦‚æœç´¢å¼•æ–‡ä»¶ä¸å­˜åœ¨ï¼ˆä¾‹å¦‚æ–°ä»“åº“ï¼‰ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºçš„ GitIndex å®ä¾‹ if not os.path.exists(index_file): return GitIndex() # æ‰“å¼€ç´¢å¼•æ–‡ä»¶ï¼Œä»¥äºŒè¿›åˆ¶æ–¹å¼è¯»å– with open(index_file, 'rb') as f: raw = f.read() # ç´¢å¼•æ–‡ä»¶çš„å¤´éƒ¨åŒ…å« 12 ä¸ªå­—èŠ‚ header = raw[:12] signature = header[:4] # æ£€æŸ¥ç´¢å¼•æ–‡ä»¶çš„é­”æ³•å­—èŠ‚ï¼Œå¿…é¡»ä¸º \"DIRC\"ï¼Œä»£è¡¨ \"DirCache\" assert signature == b\"DIRC\" # ä»å¤´éƒ¨è§£æç‰ˆæœ¬å·ï¼ˆ4-8å­—èŠ‚ï¼‰ï¼Œæ­¤å¤„åªæ”¯æŒç‰ˆæœ¬ 2 version = int.from_bytes(header[4:8], \"big\") assert version == 2, \"wyag åªæ”¯æŒç´¢å¼•æ–‡ä»¶ç‰ˆæœ¬ 2\" # ä»å¤´éƒ¨è§£æç´¢å¼•æ–‡ä»¶ä¸­çš„æ¡ç›®æ•°é‡ï¼ˆ8-12å­—èŠ‚ï¼‰ count = int.from_bytes(header[8:12], \"big\") # ç”¨äºå­˜å‚¨è¯»å–åˆ°çš„ç´¢å¼•æ¡ç›® entries = list() # ç´¢å¼•æ–‡ä»¶å†…å®¹éƒ¨åˆ†ä»ç¬¬ 12 ä¸ªå­—èŠ‚å¼€å§‹ content = raw[12:] idx = 0 # å¾ªç¯è§£ææ¯ä¸ªæ¡ç›®ï¼Œæ ¹æ®æ–‡ä»¶å¤´éƒ¨ç»™å‡ºçš„æ¡ç›®æ•°è¿›è¡Œå¾ªç¯ for i in range(0, count): # è§£æåˆ›å»ºæ—¶é—´ï¼ˆç§’æ•°å’Œçº³ç§’æ•°ï¼‰ ctime_s = int.from_bytes(content[idx: idx+4], \"big\") ctime_ns = int.from_bytes(content[idx+4: idx+8], \"big\") # è§£æä¿®æ”¹æ—¶é—´ï¼ˆç§’æ•°å’Œçº³ç§’æ•°ï¼‰ mtime_s = int.from_bytes(content[idx+8: idx+12], \"big\") mtime_ns = int.from_bytes(content[idx+12: idx+16], \"big\") # è§£æè®¾å¤‡ ID dev = int.from_bytes(content[idx+16: idx+20], \"big\") # è§£æ inode ç¼–å· ino = int.from_bytes(content[idx+20: idx+24], \"big\") # å¿½ç•¥çš„å­—æ®µ unused = int.from_bytes(content[idx+24: idx+26], \"big\") assert 0 == unused # è§£ææ–‡ä»¶æ¨¡å¼ï¼ˆåŒ…æ‹¬ç±»å‹å’Œæƒé™ï¼‰ mode = int.from_bytes(content[idx+26: idx+28], \"big\") mode_type = mode \u003e\u003e 12 assert mode_type in [0b1000, 0b1010, 0b1110] # æ–‡ä»¶ç±»å‹å¿…é¡»æ˜¯å¸¸è§„æ–‡ä»¶ã€ç¬¦å·é“¾æ¥æˆ– gitlink mode_perms = mode \u0026 0b0000000111111111 # è§£æç”¨æˆ· ID å’Œç»„ ID uid = int.from_bytes(content[idx+28: idx+32], \"big\") gid = int.from_bytes(content[idx+32: idx+36], \"big\") # è§£ææ–‡ä»¶å¤§å° fsize = int.from_bytes(content[idx+36: idx+40], \"big\") # è§£æ SHAï¼ˆå¯¹è±¡ IDï¼‰ï¼Œå¹¶æ ¼å¼åŒ–ä¸º 40 å­—ç¬¦çš„å°å†™åå…­è¿›åˆ¶å­—ç¬¦ä¸² sha = format(int.from_bytes(content[idx+40: idx+60], \"big\"), \"040x\") # è§£ææ ‡å¿—ä½ flags = int.from_bytes(content[idx+60: idx+62], \"big\") # è§£æå‡å®šæœ‰æ•ˆæ ‡å¿—ä½ flag_assume_valid = (flags \u0026 0b1000000000000000) != 0 # è§£ææ‰©å±•æ ‡å¿—ä½ï¼ˆè¢«å¿½ç•¥ï¼‰ flag_extended = (flags \u0026 0b0100000000000000) != 0 assert not flag_extended # è§£æé˜¶æ®µæ ‡å¿—ä½ flag_stage = flags \u0026 0b0011000000000000 # è§£ææ–‡ä»¶åé•¿åº¦ï¼ˆ12 ä½ï¼‰ name_length = flags \u0026 0b0000111111111111 # è¯»å–äº† 62 ä¸ªå­—èŠ‚ï¼Œç»§ç»­å¤„ç†æ–‡ä»¶å idx += 62 # å¦‚æœæ–‡ä»¶åé•¿åº¦å°äº 0xFFFï¼Œåˆ™æ–‡ä»¶åä¹‹åæœ‰ä¸€ä¸ªç©ºå­—èŠ‚ç»ˆæ­¢ç¬¦ if name_length \u003c 0xFFF: assert content[idx + name_length] == 0x00 raw_name = content[idx:idx+name_length] idx += name_length + 1 else: # å¤„ç†æ–‡ä»¶åé•¿åº¦å¤§äºç­‰äº 0xFFF çš„æƒ…å†µï¼Œéœ€è¦æŸ¥æ‰¾ç©ºå­—èŠ‚ç»ˆæ­¢ç¬¦ print(f\"æ³¨æ„: æ–‡ä»¶åé•¿åº¦ä¸º 0x{name_length:X} å­—èŠ‚é•¿ã€‚\") null_idx = content.find(b'\\x00', idx + 0xFFF) raw_name = content[idx: null_idx] idx = null_idx + 1 # å°†æ–‡ä»¶åè§£æä¸º UTF-8 å­—ç¬¦ä¸² name = raw_name.decode(\"utf8\") # ç´¢å¼•æ–‡ä»¶ä¸­çš„æ•°æ®ä»¥ 8 å­—èŠ‚å¯¹é½ï¼Œå› æ­¤éœ€è¦æ ¹æ®æŒ‡é’ˆå¯¹é½è°ƒæ•´ idx idx = 8 * ceil(idx / 8) # å°†è§£æå‡ºçš„ç´¢å¼•æ¡ç›®æ·»åŠ åˆ°åˆ—è¡¨ä¸­ entries.append(GitIndexEntry(ctime=(ctime_s, ctime_ns), mtime=(mtime_s, mtime_ns), dev=dev, ino=ino, mode_type=mode_type, mode_perms=mode_perms, uid=uid, gid=gid, fsize=fsize, sha=sha, flag_assume_valid=flag_assume_valid, flag_stage=flag_stage, name=name)) # è¿”å›åŒ…å«æ‰€æœ‰ç´¢å¼•æ¡ç›®çš„ GitIndex å®ä¾‹ return GitIndex(version=version, entries=entries) def index_write(repo, index): with open(repo_file(repo, \"index\"), \"wb\") as f: # å†™å…¥å¤´éƒ¨ä¿¡æ¯ # å†™å…¥é­”æœ¯å­—èŠ‚ \"DIRC\" ä»¥æ ‡è¯†è¯¥æ–‡ä»¶ä¸º Git ç´¢å¼•æ–‡ä»¶ã€‚ f.write(b\"DIRC\") # å†™å…¥ç‰ˆæœ¬å·ï¼ˆå›ºå®šä¸º 2ï¼‰ã€‚ f.write(index.version.to_bytes(4, \"big\")) # å†™å…¥ç´¢å¼•æ¡ç›®æ•°é‡ã€‚ f.write(len(index.entries).to_bytes(4, \"big\")) # å†™å…¥æ¡ç›®æ•°æ® idx = 0 for e in index.entries: # å†™å…¥åˆ›å»ºæ—¶é—´ï¼ˆç§’ï¼‰å’Œåˆ›å»ºæ—¶é—´çš„çº³ç§’éƒ¨åˆ†ã€‚ f.write(e.ctime[0].to_bytes(4, \"big\")) f.write(e.ctime[1].to_bytes(4, \"big\")) # å†™å…¥ä¿®æ”¹æ—¶é—´ï¼ˆç§’ï¼‰å’Œä¿®æ”¹æ—¶é—´çš„çº³ç§’éƒ¨åˆ†ã€‚ f.write(e.mtime[0].to_bytes(4, \"big\")) f.write(e.mtime[1].to_bytes(4, \"big\")) # å†™å…¥è®¾å¤‡å·å’Œ inode å·ã€‚ f.write(e.dev.to_bytes(4, \"big\")) f.write(e.ino.to_bytes(4, \"big\")) # å†™å…¥æ–‡ä»¶æƒé™æ¨¡å¼ï¼ˆç±»å‹å’Œæƒé™åˆå¹¶ï¼‰ã€‚ mode = (e.mode_type \u003c\u003c 12) | e.mode_perms f.write(mode.to_bytes(4, \"big\")) # å†™å…¥ç”¨æˆ· ID å’Œç»„ IDã€‚ f.write(e.uid.to_bytes(4, \"big\")) f.write(e.gid.to_bytes(4, \"big\")) # å†™å…¥æ–‡ä»¶å¤§å°ã€‚ f.write(e.fsize.to_bytes(4, \"big\")) # å†™å…¥ SHA-1 å¯¹è±¡ IDã€‚ f.write(int(e.sha, 16).to_bytes(20, \"big\")) # å¤„ç†æ ‡å¿—ä½ `flag_assume_valid`ã€‚ flag_assume_valid = 0x1 \u003c\u003c 15 if e.flag_assume_valid else 0 # å°†æ–‡ä»¶åç¼–ç ä¸º UTF-8ï¼Œå¹¶è®¡ç®—é•¿åº¦ã€‚ name_bytes = e.name.encode(\"utf8\") bytes_len = len(name_bytes) if bytes_len \u003e= 0xFFF: name_length = 0xFFF # é•¿åº¦è¿‡é•¿æ—¶ï¼Œæ ‡è®°ä¸º 0xFFFã€‚ else: name_length = bytes_len # å°† `flag_assume_valid`ã€`flag_stage` å’Œåç§°é•¿åº¦åˆå¹¶åˆ° 2 ä¸ªå­—èŠ‚ä¸­ã€‚ f.write((flag_assume_valid | e.flag_stage | name_length).to_bytes(2, \"big\")) # å†™å…¥æ–‡ä»¶åï¼Œå¹¶é™„åŠ ä¸€ä¸ª 0x00 ä½œä¸ºç»“å°¾ã€‚ f.write(name_bytes) f.write((0).to_bytes(1, \"big\")) # è®¡ç®—å½“å‰æ¡ç›®çš„å­—èŠ‚æ•°ã€‚ idx += 62 + len(name_bytes) + 1 # è‹¥æ¡ç›®ä¸æ˜¯ 8 å­—èŠ‚å¯¹é½ï¼Œåˆ™è¿›è¡Œå¡«å……ã€‚ if idx % 8 != 0: pad = 8 - (idx % 8) f.write((0).to_bytes(pad, \"big\")) idx += pad æŒ‰ç…§æˆ‘ä»¬å‰é¢æ‰€è¯´çš„ï¼Œgit addä¼šæ ¹æ®æ‰€ä¿®æ”¹çš„æ–‡ä»¶è·¯å¾„å¯¹.git/indexæ–‡ä»¶ä¸­çš„å†…å®¹è¿›è¡Œä¿®æ”¹ã€‚å…·ä½“å®ç°æ–¹å¼æ˜¯ä».git/indexæ–‡ä»¶ä¸­ç§»é™¤æŒ‡å®šè·¯å¾„çš„æ¡ç›®ï¼ˆä¸ç‰©ç†åˆ é™¤æ–‡ä»¶ï¼‰ï¼Œç„¶åå¯¹æ¯ä¸ªè·¯å¾„ï¼Œè¯»å–æ–‡ä»¶å†…å®¹ï¼Œè®¡ç®—æ–‡ä»¶çš„å“ˆå¸Œå€¼å¹¶è·å–æ–‡ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œç„¶åå°†æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯æ·»åŠ åˆ°.git/indexæ–‡ä»¶ä¸­ï¼ŒåŒ…æ‹¬ ctimeã€mtimeã€æ–‡ä»¶æƒé™ç­‰ï¼Œæœ€åå°†æ–°çš„ç´¢å¼•æ¡ç›®å†™å›ç´¢å¼•æ–‡ä»¶ã€‚å…·ä½“çš„addå‡½æ•°å®ç°å¦‚ä¸‹ï¼š\ndef add(repo, paths, delete=True, skip_missing=False): # é¦–å…ˆè°ƒç”¨ rm å‡½æ•°ä»ç´¢å¼•ä¸­ç§»é™¤è¿™äº›è·¯å¾„çš„æ¡ç›®ï¼Œé¿å…é‡å¤ï¼ˆä¸ç‰©ç†åˆ é™¤æ–‡ä»¶ï¼‰ã€‚ rm(repo, paths, delete=False, skip_missing=True) # è·å–å·¥ä½œæ ‘çš„æ ¹ç›®å½•è·¯å¾„ï¼ˆæœ«å°¾åŠ ä¸Šè·¯å¾„åˆ†éš”ç¬¦ï¼‰ worktree = repo.worktree + os.sep # å°†è·¯å¾„è½¬æ¢ä¸º (ç»å¯¹è·¯å¾„ï¼Œç›¸å¯¹è·¯å¾„) çš„å¯¹ï¼Œå¹¶ç¡®ä¿å®ƒä»¬åœ¨å·¥ä½œæ ‘å†…ä¸”ä¸ºæ–‡ä»¶ clean_paths = set() for path in paths: abspath = os.path.abspath(path) # è·å–ç»å¯¹è·¯å¾„ if not (abspath.startswith(worktree) and os.path.isfile(abspath)): # ç¡®ä¿è·¯å¾„åœ¨å·¥ä½œæ ‘å†…ä¸”ä¸ºæ–‡ä»¶ raise Exception(f\"Not a file, or outside the worktree: {paths}\") # å¦‚æœè·¯å¾„æ— æ•ˆæˆ–ä¸åœ¨å·¥ä½œæ ‘å†…ï¼ŒæŠ›å‡ºå¼‚å¸¸ relpath = os.path.relpath(abspath, repo.worktree) # è·å–ç›¸å¯¹è·¯å¾„ clean_paths.add((abspath, relpath)) # æ·»åŠ åˆ° clean_paths é›†åˆä¸­ # æŸ¥æ‰¾å¹¶è¯»å–ç´¢å¼•ã€‚ç”±äº `rm` å·²ç»ä¿®æ”¹äº†ç´¢å¼•ï¼Œè¿™é‡Œå†æ¬¡è¯»å–ã€‚ # @FIXMEï¼šå¯ä»¥é€šè¿‡ä¼ é€’å‘½ä»¤æ¥ç§»åŠ¨ç´¢å¼•ï¼Œè€Œä¸æ˜¯åå¤è¯»å†™ç´¢å¼•ã€‚ index = index_read(repo) # éå†æ¯ä¸ªè·¯å¾„å¯¹ï¼Œè¯»å–æ–‡ä»¶ï¼Œç”Ÿæˆå“ˆå¸Œå¹¶æ›´æ–°ç´¢å¼•æ¡ç›® for (abspath, relpath) in clean_paths: with open(abspath, \"rb\") as fd: sha = object_hash(fd, b\"blob\", repo) # è®¡ç®—æ–‡ä»¶çš„ SHA å“ˆå¸Œå€¼ stat = os.stat(abspath) # è·å–æ–‡ä»¶çŠ¶æ€ # è·å–æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´å’Œä¿®æ”¹æ—¶é—´ï¼ˆç§’å’Œçº³ç§’ï¼‰ ctime_s = int(stat.st_ctime) ctime_ns = stat.st_ctime_ns % 10**9 mtime_s = int(stat.st_mtime) mtime_ns = stat.st_mtime_ns % 10**9 # åˆ›å»º Git ç´¢å¼•æ¡ç›®å¯¹è±¡ entry = GitIndexEntry(ctime=(ctime_s, ctime_ns), mtime=(mtime_s, mtime_ns), dev=stat.st_dev, ino=stat.st_ino, mode_type=0b1000, mode_perms=0o644, uid=stat.st_uid, gid=stat.st_gid, fsize=stat.st_size, sha=sha, flag_assume_valid=False, flag_stage=False, name=relpath) # å°†æ–°æ¡ç›®æ·»åŠ åˆ°ç´¢å¼•æ¡ç›®åˆ—è¡¨ index.entries.append(entry) # å°†æ›´æ–°åçš„ç´¢å¼•å†™å›æ–‡ä»¶ index_write(repo, index) def rm(repo, paths, delete=True, skip_missing=False): # æŸ¥æ‰¾å¹¶è¯»å–ç´¢å¼•æ–‡ä»¶ index = index_read(repo) # è·å–å·¥ä½œæ ‘çš„æ ¹ç›®å½•è·¯å¾„ï¼ˆæœ«å°¾åŠ ä¸Šè·¯å¾„åˆ†éš”ç¬¦ï¼‰ worktree = repo.worktree + os.sep # å°†è¾“å…¥è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„ï¼Œå¹¶ç¡®ä¿å®ƒä»¬ä½äºå·¥ä½œæ ‘å†… abspaths = set() for path in paths: abspath = os.path.abspath(path) # è·å–ç»å¯¹è·¯å¾„ if abspath.startswith(worktree): # ç¡®ä¿è·¯å¾„åœ¨å·¥ä½œæ ‘ä¸­ abspaths.add(abspath) else: raise Exception(f\"Cannot remove paths outside of worktree: {paths}\") # å¦‚æœè·¯å¾„ä¸åœ¨å·¥ä½œæ ‘å†…ï¼ŒæŠ›å‡ºå¼‚å¸¸ # å°†è¦ä¿ç•™çš„ç´¢å¼•æ¡ç›®åˆ—è¡¨ï¼Œç”¨äºæ›´æ–°ç´¢å¼•æ–‡ä»¶ kept_entries = list() # å°†è¦åˆ é™¤çš„è·¯å¾„åˆ—è¡¨ï¼Œç”¨äºç‰©ç†åˆ é™¤æ–‡ä»¶ remove = list() # éå†ç´¢å¼•æ¡ç›®ï¼Œåˆ é™¤åŒ¹é…çš„è·¯å¾„ï¼Œä¿ç•™å…¶ä½™æ¡ç›® for e in index.entries: full_path = os.path.join(repo.worktree, e.name) # è·å–ç´¢å¼•æ¡ç›®çš„å®Œæ•´è·¯å¾„ if full_path in abspaths: # å¦‚æœè·¯å¾„åœ¨å¾…åˆ é™¤åˆ—è¡¨ä¸­ remove.append(full_path) # åŠ å…¥å¾…åˆ é™¤åˆ—è¡¨ abspaths.remove(full_path) # ä»å¾…åˆ é™¤è·¯å¾„ä¸­ç§»é™¤ else: kept_entries.append(e) # ä¿ç•™è¯¥æ¡ç›® # å¦‚æœæœ‰æœªåœ¨ç´¢å¼•ä¸­æ‰¾åˆ°çš„è·¯å¾„ï¼Œä¸” skip_missing=Falseï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ if len(abspaths) \u003e 0 and not skip_missing: raise Exception(f\"Cannot remove paths not in the index: {abspaths}\") # ç‰©ç†åˆ é™¤æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ if delete: for path in remove: os.unlink(path) # åˆ é™¤æ–‡ä»¶ # æ›´æ–°ç´¢å¼•æ¡ç›®ï¼Œå¹¶å°†å…¶å†™å›ç´¢å¼•æ–‡ä»¶ index.entries = kept_entries index_write(repo, index) ç„¶åå†ä½¿ç”¨git addä¹‹åçš„.git/indexæ–‡ä»¶ç”Ÿæˆæ ‘å¯¹è±¡ï¼Œæœ€åå†å€Ÿç”±æ ‘å¯¹è±¡ç”Ÿæˆæäº¤å¯¹è±¡ï¼ï¼ï¼å…·ä½“pythonä»£ç å®ç°å¦‚ä¸‹ï¼š\ndef tree_from_index(repo, index): # åˆå§‹åŒ–ä¸€ä¸ªå­—å…¸ï¼Œç”¨äºå­˜å‚¨ç›®å½•åŠå…¶å†…å®¹ï¼Œæ ¹ç›®å½• \"\" å­˜å‚¨ä¸€ä¸ªç©ºåˆ—è¡¨ã€‚ contents = dict() contents[\"\"] = list() # éå†ç´¢å¼•ä¸­çš„æ¯ä¸ªæ¡ç›®ï¼Œæ„å»ºç›®å½•ç»“æ„ã€‚ for entry in index.entries: dirname = os.path.dirname(entry.name) # è·å–å½“å‰æ¡ç›®çš„ç›®å½•å # éå†ç›®å½•è·¯å¾„ï¼Œç›´åˆ°æ ¹ç›®å½•ï¼Œç¡®ä¿æ¯ä¸ªç›®å½•éƒ½è¢«åˆ›å»º key = dirname while key != \"\": if key not in contents: # å¦‚æœè¯¥ç›®å½•å°šæœªåœ¨ contents ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªç©ºåˆ—è¡¨ contents[key] = list() key = os.path.dirname(key) # å°†æ¡ç›®æ·»åŠ åˆ°å¯¹åº”ç›®å½•çš„å†…å®¹åˆ—è¡¨ä¸­ contents[dirname].append(entry) # è·å–æ‰€æœ‰ç›®å½•çš„è·¯å¾„å¹¶æŒ‰è·¯å¾„é•¿åº¦ä»é•¿åˆ°çŸ­æ’åº sorted_paths = sorted(contents.keys(), key=len, reverse=True) # åˆå§‹åŒ–æ ‘çš„ SHA-1 å“ˆå¸Œï¼ˆæ ¹æ ‘çš„å“ˆå¸Œå€¼å°†ä¼šä¿å­˜åœ¨è¿™é‡Œï¼‰ sha = None # éå†æ’åºåçš„è·¯å¾„ï¼ˆç›®å½•ï¼‰ï¼Œæ„å»ºæ ‘å¯¹è±¡ for path in sorted_paths: tree = GitTree() # åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºæ ‘å¯¹è±¡ # éå†è¯¥ç›®å½•ä¸‹çš„æ¡ç›®ï¼Œç”Ÿæˆæ ‘å¶å¹¶æ·»åŠ åˆ°æ ‘ä¸­ for entry in contents[path]: if isinstance(entry, GitIndexEntry): # æ™®é€šçš„æ–‡ä»¶æ¡ç›® # è½¬æ¢æ–‡ä»¶çš„æƒé™æ¨¡å¼ï¼ŒGit ä½¿ç”¨åå…­è¿›åˆ¶è¡¨ç¤ºï¼Œæ ‘å¯¹è±¡éœ€è¦çš„æ˜¯å…«è¿›åˆ¶ ASCII å­—ç¬¦ä¸² leaf_mode = f\"{entry.mode_type:02o}{entry.mode_perms:04o}\".encode(\"ascii\") leaf = GitTreeLeaf(mode=leaf_mode, path=os.path.basename(entry.name), sha=entry.sha) else: # å­ç›®å½•æ¡ç›®ï¼ˆæ ‘ï¼‰ leaf = GitTreeLeaf(mode=b\"040000\", path=entry[0], sha=entry[1]) tree.items.append(leaf) # å°†å¶å­æ·»åŠ åˆ°æ ‘å¯¹è±¡ä¸­ # å°†ç”Ÿæˆçš„æ ‘å¯¹è±¡å†™å…¥å¯¹è±¡å­˜å‚¨ï¼Œå¹¶è·å–å…¶ SHA-1 å“ˆå¸Œ sha = object_write(tree, repo) # å°†æ ‘å¯¹è±¡çš„å“ˆå¸Œå€¼æ·»åŠ åˆ°å…¶çˆ¶ç›®å½•çš„å†…å®¹åˆ—è¡¨ä¸­ï¼Œä½œä¸ºä¸€å¯¹ (æ–‡ä»¶å, SHA) parent = os.path.dirname(path) # è·å–çˆ¶ç›®å½•è·¯å¾„ base = os.path.basename(path) # è·å–å½“å‰ç›®å½•çš„åç§°ï¼ˆä¾‹å¦‚ \"main.go\"ï¼‰ contents[parent].append((base, sha)) # å°†çˆ¶ç›®å½•ä¸æ–°ç”Ÿæˆçš„æ ‘çš„å“ˆå¸Œå€¼å…³è” return sha # è¿”å›æ ¹æ ‘çš„ SHA-1 å“ˆå¸Œ def commit_create(repo, tree, parent, author, timestamp, message): commit = GitCommit() # åˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤å¯¹è±¡ # è®¾ç½®æäº¤å¯¹è±¡çš„æ ‘å­—æ®µä¸ºå½“å‰æäº¤çš„æ ‘å¯¹è±¡çš„ SHA-1 å€¼ commit.kvlm[b\"tree\"] = tree.encode(\"ascii\") # å¦‚æœæœ‰çˆ¶æäº¤ï¼Œè®¾ç½®çˆ¶æäº¤å­—æ®µ if parent: commit.kvlm[b\"parent\"] = parent.encode(\"ascii\") # æ¸…ç†æäº¤ä¿¡æ¯ï¼Œå¹¶åœ¨æœ«å°¾åŠ ä¸Šæ¢è¡Œç¬¦ message = message.strip() + \"\\n\" # æ ¼å¼åŒ–æ—¶åŒºåç§»ï¼ˆä¾‹å¦‚ \"+0200\" æˆ– \"-0700\"ï¼‰ offset = int(timestamp.astimezone().utcoffset().total_seconds()) # è·å–æ—¶åŒºåç§»ï¼ˆç§’ï¼‰ hours = offset // 3600 # è®¡ç®—å°æ—¶ minutes = (offset % 3600) // 60 # è®¡ç®—åˆ†é’Ÿ tz = \"{}{:02}{:02}\".format(\"+\" if offset \u003e 0 else \"-\", hours, minutes) # æ ¼å¼åŒ–æ—¶åŒºå­—ç¬¦ä¸² # å°†ä½œè€…ä¿¡æ¯æ ¼å¼åŒ–ä¸º \"Author Name timestamp timezone\" author = author + timestamp.strftime(\" %s \") + tz # è®¾ç½®æäº¤å¯¹è±¡çš„ä½œè€…å’Œæäº¤è€…å­—æ®µä¸ºç›¸åŒçš„å€¼ commit.kvlm[b\"author\"] = author.encode(\"utf8\") commit.kvlm[b\"committer\"] = author.encode(\"utf8\") # è®¾ç½®æäº¤ä¿¡æ¯å­—æ®µ commit.kvlm[None] = message.encode(\"utf8\") # å°†æäº¤å¯¹è±¡å†™å…¥å¯¹è±¡å­˜å‚¨ï¼Œå¹¶è¿”å›å…¶ SHA-1 å“ˆå¸Œ return object_write(commit, repo) GitäºŒè¿å‡»å¯è§†åŒ– å·²ç»äº†è§£äº†ä¸Šé¢çš„åº•å±‚åŸç†åï¼Œå¯¹Gitä¸¤è¿å‡»çš„çš„å¯è§†åŒ–ä¹Ÿå°±ååˆ†ç®€å•äº†ï¼Œè¯¦è§ä¸‹å›¾ï¼Œå‚è€ƒè¿™æ‰æ˜¯çœŸæ­£çš„Gitâ€”â€”Gitå†…éƒ¨åŸç†æ­ç§˜ï¼ï¼š ç°åœ¨ï¼ŒğŸ˜®â€ğŸ’¨ï¼Œæ‰€æœ‰GitåŸºç¡€çš„å†…å®¹çš„åº•å±‚åŸç†ä»¥åŠå…¶ä»£ç å½¢å¼å·®ä¸å¤šå°±è®²è§£å®Œäº†ã€‚è¿˜æœ‰ä¸€äº›æ¯”è¾ƒé«˜çº§çš„Gitå†…å®¹æˆ‘ä»¬ç•™å¾…åæ–‡ã€‚\nGitå¸¸ç”¨å‘½ä»¤è¿›é˜¶ æˆ‘ä»¬å·²ç»å¯è§†åŒ–äº†Gitä¸¤è¿å‡»ä¸­ç»†èŠ‚ï¼Œä¸‹é¢æˆ‘ä»¬å¯ä»¥ä»é«˜å±‚æ¬¡çš„è§†è§’ï¼ˆGitCommitï¼‰æ¥å¯¹Gitä¸­çš„é«˜é˜¶å¸¸ç”¨å‘½ä»¤è¿›è¡Œå¯è§†åŒ–ï¼Œå¯è§†åŒ–ç»“æœç”±Learn Git Branchæä¾›ã€‚æˆ‘ä»¬ç»è¿‡ä¸€ç³»åˆ—çš„git addå’Œgit commitä»¥åŠgit checkoutä¹‹åå¾—åˆ°çš„åˆå§‹çš„GitCommitçš„åˆ†å¸ƒæƒ…å†µå¦‚å›¾7æ‰€ç¤ºã€‚\nå›¾7ï¼šåˆå§‹GitCommitåˆ†å¸ƒæƒ…å†µ æ¥ä¸‹æ¥å…ˆä»‹ç»çš„4ä¸ªå‘½ä»¤çš„è”ç³»å¦‚å›¾8æ‰€ç¤ºï¼š\nå›¾8ï¼šgit resetã€git checkoutã€git addå’Œ git commitçš„è”ç³» git addå’Œgit commit å‘½ä»¤æˆ‘ä»¬å·²ç»è¯¦ç»†ä»‹ç»è¿‡äº†ï¼Œä¸‹é¢å†ç®€è¦å¯¹å¯¹è¿™4ä¸ªå‘½ä»¤è¿›è¡Œå™è¿°ã€‚\ngit addÂ filesÂ æŠŠå½“å‰æ–‡ä»¶æ”¾å…¥æš‚å­˜åŒºåŸŸã€‚ git commit -m messageÂ ç»™æš‚å­˜åŒºåŸŸç”Ÿæˆå¿«ç…§å¹¶æäº¤ï¼Œè€Œgit commit -a -m messageè‡ªåŠ¨å°†æ‰€æœ‰è¢«è·Ÿè¸ªçš„æ–‡ä»¶çš„æ›´æ”¹æš‚å­˜å¹¶æäº¤ï¼Œçœç•¥äº†git addçš„æ­¥éª¤ã€‚ git reset filesÂ ç”¨æ¥æ’¤é”€æœ€åä¸€æ¬¡git addÂ filesï¼Œä½ ä¹Ÿå¯ä»¥ç”¨git resetÂ æ’¤é”€æ‰€æœ‰æš‚å­˜åŒºåŸŸæ–‡ä»¶ã€‚ git checkout filesÂ æŠŠæ–‡ä»¶ä»æš‚å­˜åŒºåŸŸå¤åˆ¶åˆ°å·¥ä½œç›®å½•ï¼Œç”¨æ¥ä¸¢å¼ƒæœ¬åœ°ä¿®æ”¹ï¼Œè€Œgit checkout HEAD filesÂ ç”¨æ¥å°†å·¥ä½œç›®å½•ä¸­æŒ‡å®šæ–‡ä»¶æ¢å¤åˆ°å½“å‰åˆ†æ”¯æœ€æ–°ä¸€æ¬¡æäº¤æ—¶çš„çŠ¶æ€ï¼ˆå³ HEAD æŒ‡é’ˆæŒ‡å‘çš„æäº¤ï¼‰ã€‚è¿™ç›¸å½“äºä¸¢å¼ƒå¯¹è¿™äº›æ–‡ä»¶çš„æ‰€æœ‰æœªæäº¤ä¿®æ”¹ï¼Œæ¢å¤åˆ°ä¸Šä¸€æ¬¡æäº¤çš„ç‰ˆæœ¬ã€‚ git checkout åˆ†æ”¯å‚æ•° checkoutå‘½ä»¤ç”¨äºä»å†å²æäº¤ï¼ˆæˆ–è€…æš‚å­˜åŒºåŸŸï¼‰ä¸­æ‹·è´æ–‡ä»¶åˆ°å·¥ä½œç›®å½•ï¼Œä¹Ÿå¯ç”¨äºåˆ‡æ¢åˆ†æ”¯ã€‚å½“ä¸æŒ‡å®šæ–‡ä»¶åï¼Œè€Œæ˜¯ç»™å‡ºä¸€ä¸ªï¼ˆæœ¬åœ°ï¼‰åˆ†æ”¯æ—¶ï¼Œé‚£ä¹ˆHEADæ ‡è¯†ä¼šç§»åŠ¨åˆ°é‚£ä¸ªåˆ†æ”¯ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬â€œåˆ‡æ¢â€åˆ°é‚£ä¸ªåˆ†æ”¯äº†ï¼‰ï¼Œç„¶åæš‚å­˜åŒºåŸŸå’Œå·¥ä½œç›®å½•ä¸­çš„å†…å®¹ä¼šå’ŒHEADå¯¹åº”çš„æäº¤èŠ‚ç‚¹ä¸€è‡´ã€‚æ–°æäº¤èŠ‚ç‚¹ï¼ˆä¸‹å›¾ä¸­çš„C1ï¼‰ä¸­çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šè¢«å¤åˆ¶ï¼ˆåˆ°æš‚å­˜åŒºåŸŸå’Œå·¥ä½œç›®å½•ä¸­ï¼‰ï¼›åªå­˜åœ¨äºè€çš„æäº¤èŠ‚ç‚¹ï¼ˆC5ï¼‰ä¸­çš„æ–‡ä»¶ä¼šè¢«åˆ é™¤ï¼›ä¸å±äºä¸Šè¿°ä¸¤è€…çš„æ–‡ä»¶ä¼šè¢«å¿½ç•¥ï¼Œä¸å—å½±å“ã€‚(åˆ†æ”¯åœ¨.gitæ–‡ä»¶å¤¹ä¸­å¯¹åº”.git/refs/heads/ä¸­çš„æ–‡ä»¶ï¼ŒHEADå¯¹åº”.gitæ–‡ä»¶å¤¹ä¸­çš„HEADæ–‡ä»¶ï¼Œgit checkout stableå°†HEADæ–‡ä»¶å†…å®¹ç”±ref: refs/heads/mainæ”¹å˜æˆref: refs/heads/stableåŒæ—¶æš‚å­˜åŒºå’Œå·¥ä½œç›®å½•ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–)\nå›¾9ï¼šgit checkout stableå°†åˆ†æ”¯ä»mainè½¬æ¢åˆ°stable è¢«åˆ†ç¦»çš„HEADæ ‡è¯† å¦‚æœæ—¢æ²¡æœ‰æŒ‡å®šæ–‡ä»¶åï¼Œä¹Ÿæ²¡æœ‰æŒ‡å®šåˆ†æ”¯åï¼Œè€Œæ˜¯ä¸€ä¸ªæ ‡ç­¾ã€è¿œç¨‹åˆ†æ”¯ã€SHA-1å€¼æˆ–è€…æ˜¯åƒmain~3ç±»ä¼¼çš„ä¸œè¥¿ï¼Œå°±å¾—åˆ°ä¸€ä¸ªåŒ¿ååˆ†æ”¯ï¼Œç§°ä½œdetached HEADï¼ˆè¢«åˆ†ç¦»çš„HEADæ ‡è¯†ï¼‰ï¼Œæš‚å­˜åŒºåŸŸå’Œå·¥ä½œç›®å½•ä¸­çš„å†…å®¹ä¼šå’ŒHEADå¯¹åº”çš„æäº¤èŠ‚ç‚¹ä¸€è‡´ã€‚\nå›¾10ï¼šgit checkout main~3å°†HEADåˆ†ç¦»å‡ºæ¥ HEADå¤„äºåˆ†ç¦»çŠ¶æ€æ—¶ï¼Œæäº¤æ“ä½œå¯ä»¥æ­£å¸¸è¿›è¡Œå¦‚å›¾11æ‰€ç¤ºï¼Œä½†æ˜¯ä¸ä¼šæ›´æ–°ä»»ä½•å·²å‘½åçš„åˆ†æ”¯ã€‚(ä½ å¯ä»¥è®¤ä¸ºè¿™æ˜¯åœ¨æ›´æ–°ä¸€ä¸ªåŒ¿ååˆ†æ”¯ã€‚)ä¸€æ—¦æ­¤åä½ åˆ‡æ¢åˆ°åˆ«çš„åˆ†æ”¯ï¼Œæ¯”å¦‚è¯´mainï¼Œé‚£ä¹ˆè¿™ä¸ªæäº¤èŠ‚ç‚¹ï¼ˆå¯èƒ½ï¼‰å†ä¹Ÿä¸ä¼šè¢«å¼•ç”¨åˆ°ï¼Œç„¶åå°±ä¼šè¢«ä¸¢å¼ƒæ‰äº†ï¼Œå¦‚å›¾12æ‰€ç¤ºã€‚\nå›¾11ï¼šHEADæ ‡è¯†å¤„äºåˆ†ç¦»çŠ¶æ€æ—¶çš„æäº¤æ“ä½œ å›¾12ï¼šgit checkout mainè¿è¡Œåä¹‹å‰æäº¤èŠ‚ç‚¹çš„æƒ…å†µ ä½†æ˜¯ï¼Œå¦‚æœä½ æƒ³ä¿å­˜è¿™ä¸ªçŠ¶æ€ï¼Œå¯ä»¥ç”¨å‘½ä»¤git checkout -bÂ nameæ¥åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯ï¼Œå¦‚å›¾13æ‰€ç¤ºã€‚\nå›¾13ï¼šgit checkout -b newè¿è¡Œåå¯ä»¥ä¿å­˜æäº¤çŠ¶æ€ git reset resetå‘½ä»¤æŠŠå½“å‰åˆ†æ”¯æŒ‡å‘å¦ä¸€ä¸ªä½ç½®ï¼Œå¹¶ä¸”æœ‰é€‰æ‹©çš„å˜åŠ¨å·¥ä½œç›®å½•å’Œç´¢å¼•ã€‚ä¹Ÿç”¨æ¥åœ¨ä»å†å²ä»“åº“ä¸­å¤åˆ¶æ–‡ä»¶åˆ°ç´¢å¼•ï¼Œè€Œä¸åŠ¨å·¥ä½œç›®å½•ã€‚\nå¦‚æœä¸ç»™é€‰é¡¹ï¼Œç§»åŠ¨HEADåˆ°æŒ‡å®šçš„æäº¤ï¼Œå¹¶ä¸”å°†æ›´æ”¹ä»æš‚å­˜åŒºç§»é™¤ï¼Œä½†ä¿ç•™åœ¨å·¥ä½œç›®å½•ä¸­ï¼ˆéœ€è¦git addå’Œgit commitï¼‰ã€‚å¦‚æœç”¨--hardé€‰é¡¹ï¼Œç§»åŠ¨HEADåˆ°æŒ‡å®šçš„æäº¤ï¼Œå¹¶ä¸”é‡ç½®æš‚å­˜åŒºå’Œå·¥ä½œç›®å½•ï¼Œå¦‚æœç”¨--softé€‰é¡¹ï¼Œä»…ä»…ç§»åŠ¨HEADåˆ°æŒ‡å®šçš„æäº¤ï¼Œä½†ä¿ç•™å·¥ä½œåŒºå’Œæš‚å­˜åŒºçš„æ›´æ”¹ï¼ˆä»…éœ€è¦git commitï¼‰ã€‚\nå›¾14ï¼šç°å°†HEADæŒ‡å‘mainåˆ†æ”¯å†è¿è¡Œgit reset main~3åçš„æƒ…å†µ å¦‚æœæ²¡æœ‰ç»™å‡ºæäº¤ç‚¹çš„ç‰ˆæœ¬å·ï¼Œé‚£ä¹ˆé»˜è®¤ç”¨HEADã€‚è¿™æ ·ï¼Œåˆ†æ”¯æŒ‡å‘ä¸å˜ï¼Œä½†æ˜¯ç´¢å¼•ä¼šå›æ»šåˆ°æœ€åä¸€æ¬¡æäº¤ï¼Œå¦‚æœç”¨--hardé€‰é¡¹ï¼Œå·¥ä½œç›®å½•ä¹ŸåŒæ ·ã€‚\ngit merge merge å‘½ä»¤æŠŠä¸åŒåˆ†æ”¯åˆå¹¶èµ·æ¥ã€‚åˆå¹¶å‰ï¼Œç´¢å¼•å¿…é¡»å’Œå½“å‰æäº¤ç›¸åŒã€‚å¦‚æœå¦ä¸€ä¸ªåˆ†æ”¯æ˜¯å½“å‰æäº¤çš„ç¥–çˆ¶èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåˆå¹¶å‘½ä»¤å°†ä»€ä¹ˆä¹Ÿä¸åšã€‚ å¦ä¸€ç§æƒ…å†µæ˜¯å¦‚æœå½“å‰æäº¤æ˜¯å¦ä¸€ä¸ªåˆ†æ”¯çš„ç¥–çˆ¶èŠ‚ç‚¹ï¼Œå°±å¯¼è‡´fast-forwardåˆå¹¶ã€‚æŒ‡å‘åªæ˜¯ç®€å•çš„ç§»åŠ¨ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„æäº¤ã€‚\nå›¾14ï¼šè¿è¡Œgit merge mainå‰çš„æƒ…å†µ å›¾15ï¼šè¿è¡Œgit merge mainåçš„æƒ…å†µï¼Œå¿«é€Ÿå‰è¿› å¦åˆ™å°±æ˜¯ä¸€æ¬¡çœŸæ­£çš„åˆå¹¶ã€‚é»˜è®¤æŠŠå½“å‰æäº¤(C5Â å¦‚ä¸‹æ‰€ç¤º)å’Œå¦ä¸€ä¸ªæäº¤(C7)ä»¥åŠä»–ä»¬çš„å…±åŒç¥–çˆ¶èŠ‚ç‚¹(C2)è¿›è¡Œä¸€æ¬¡ä¸‰æ–¹åˆå¹¶ã€‚ç»“æœæ˜¯å…ˆä¿å­˜å½“å‰ç›®å½•å’Œç´¢å¼•ï¼Œç„¶åå’Œçˆ¶èŠ‚ç‚¹C7ä¸€èµ·åšä¸€æ¬¡æ–°æäº¤ã€‚\nå›¾16ï¼šè¿è¡Œgit merge mainå‰çš„æƒ…å†µ å›¾17ï¼šè¿è¡Œgit merge mainåçš„æƒ…å†µï¼Œæ­£å®—èåˆ git cherry-pick git cherry-pickå‘½ä»¤\"å¤åˆ¶\"ä¸€ä¸ªæäº¤èŠ‚ç‚¹å¹¶åœ¨å½“å‰åˆ†æ”¯åšä¸€æ¬¡å®Œå…¨ä¸€æ ·çš„æ–°æäº¤ï¼Œæš‚å­˜åŒºå’Œå·¥ä½œç›®å½•éƒ½å‘ç”Ÿæ”¹å˜ã€‚\nå›¾18ï¼šè¿è¡Œgit cherry-pick C4ä¹‹å‰çš„æƒ…å†µ å›¾19ï¼šè¿è¡Œgit cherry-pick C4ä¹‹åçš„æƒ…å†µï¼Œå¤åˆ¶C4åœ¨å½“å‰mainåˆ†æ”¯ä¸‹åšä¸€æ¬¡å®Œå…¨ç›¸åŒçš„æäº¤ ### `git rebase` è¡åˆæ˜¯åˆå¹¶å‘½ä»¤çš„å¦ä¸€ç§é€‰æ‹©ã€‚åˆå¹¶æŠŠä¸¤ä¸ªçˆ¶åˆ†æ”¯åˆå¹¶è¿›è¡Œä¸€æ¬¡æäº¤ï¼Œæäº¤å†å²ä¸æ˜¯çº¿æ€§çš„ã€‚è¡åˆåœ¨å½“å‰åˆ†æ”¯ä¸Šé‡æ¼”å¦ä¸€ä¸ªåˆ†æ”¯çš„å†å²ï¼Œæäº¤å†å²æ˜¯çº¿æ€§çš„ã€‚ æœ¬è´¨ä¸Šï¼Œè¿™æ˜¯çº¿æ€§åŒ–çš„è‡ªåŠ¨çš„Â cherry-pickã€‚\nå›¾20ï¼šè¿è¡Œgit rebase bugFixä¹‹å‰çš„æƒ…å†µ å›¾21ï¼šè¿è¡Œgit rebase bugFixä¹‹åçš„æƒ…å†µ Gitæœ¬åœ°ä»“åº“è¿æ¥å¹¶ä¸Šä¼ è¿œç¨‹ä»“åº“ ä½¿ç”¨sshå¯†é’¥å°†æœ¬åœ°gitå’Œè¿œç¨‹GitHubé…å¯¹ å‚è€ƒhttps://zhuanlan.zhihu.com/p/138305054\næœ¬åœ°ä¸Šä¼ è¿œç¨‹6æ­¥èµ°æˆ˜ç•¥ git initï¼šå°†æ–‡ä»¶å¤¹è®¾ç½®ä¸ºæœ¬åœ°ä»“åº“ï¼Œåªæœ‰è¿™æ ·æ‰å¯ä»¥æŠŠæœ¬åœ°çš„æ–‡ä»¶ä¼ å…¥githubä»“åº“ã€‚ git remote add originÂ git@github.com:yourusername/yourprojectname.gitï¼šå°†æœ¬åœ°ä»“åº“ä¸githubä»“åº“è¿›è¡Œå…³è”ã€‚ git pull origin main(or master)ï¼šå°†GitHubä¸Šä»“åº“çš„å†…å®¹pullåˆ°æœ¬åœ°ä»“åº“ï¼Œä¸¤è€…ä¿æŒä¸€è‡´ã€‚ git addï¼šéœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ æ·»åŠ æ–‡ä»¶åˆ°æœ¬åœ°åº“ã€‚ï¼ˆå†æ¬¡ä¸Šä¼ å°±æ˜¯3æ­¥èµ°æˆ˜ç•¥ï¼‰ git commit -m â€œinformationâ€ï¼šæäº¤æ–‡ä»¶åˆ°æœ¬åœ°åº“ã€‚ï¼ˆå†æ¬¡ä¸Šä¼ å°±æ˜¯3æ­¥èµ°æˆ˜ç•¥ï¼‰ git push origin main(or master)ï¼šä¸Šä¼ æ–‡ä»¶ã€‚ï¼ˆå†æ¬¡ä¸Šä¼ å°±æ˜¯3æ­¥èµ°æˆ˜ç•¥ï¼‰ å‚è€ƒç½‘ç«™ Write yourself a Git! è¿™æ‰æ˜¯çœŸæ­£çš„Gitâ€”â€”Gitå†…éƒ¨åŸç†æ­ç§˜ï¼ Learn Git Branch ","wordCount":"2214","inLanguage":"en","image":"https://fordelkon.github.io/img/git_intro_summary.png","datePublished":"2025-08-24T23:09:00+09:00","dateModified":"2025-08-24T23:09:00+09:00","author":{"@type":"Person","name":"DL Kong"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fordelkon.github.io/posts/git_intro/"},"publisher":{"@type":"Organization","name":"DL Kong","logo":{"@type":"ImageObject","url":"https://fordelkon.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://fordelkon.github.io/ accesskey=h title="DL Kong (Alt + H)"><img src=https://fordelkon.github.io/logo_filled_outlined_6.png alt="Site icon in header" aria-label=logo height=35>DL Kong</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><button id=menu-trigger aria-haspopup=menu aria-label="Menu Button">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><ul class="menu hidden"><li><a href=https://fordelkon.github.io/about/ title=About><span>About</span></a></li><li><a href=https://fordelkon.github.io/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://fordelkon.github.io/teaching/ title=Teaching><span>Teaching</span></a></li><li><a href=https://fordelkon.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fordelkon.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://fordelkon.github.io/posts/>Posts</a></div><h1 class=post-title>Gitè¯¦è§£</h1><div class=post-meta><span title='2025-08-24 23:09:00 +0900 +0900'>August 8, 24000</span>&nbsp;Â·&nbsp;11 min&nbsp;Â·&nbsp;DL Kong</div></header><div class="toc side left"><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#gitä»“åº“git-repository>Gitä»“åº“ï¼ˆGit Repositoryï¼‰</a></li><li><a href=#gitæ–‡ä»¶å¤¹å†…éƒ¨ç»“æ„æ¢ç©¶>.gitæ–‡ä»¶å¤¹å†…éƒ¨ç»“æ„æ¢ç©¶</a></li><li><a href=#gitå¯¹è±¡git-object>Gitå¯¹è±¡ï¼ˆGit Objectï¼‰</a><ul><li><a href=#gitblobå¯¹è±¡>GitBlobå¯¹è±¡</a></li><li><a href=#gittreeå¯¹è±¡>GitTreeå¯¹è±¡</a></li><li><a href=#gitcommitå¯¹è±¡>GitCommitå¯¹è±¡</a></li><li><a href=#gittagå¯¹è±¡>GitTagå¯¹è±¡</a><ul><li><a href=#è½»é‡æ ‡ç­¾lightweight-tags>è½»é‡æ ‡ç­¾ï¼ˆâ€œLightweightâ€ tagsï¼‰</a></li><li><a href=#æ ‡ç­¾å¯¹è±¡tag-objects>æ ‡ç­¾å¯¹è±¡ï¼ˆTag objectsï¼‰</a></li></ul></li></ul></li><li><a href=#æš‚å­˜åŒºstaging-area>æš‚å­˜åŒºï¼ˆStaging areaï¼‰</a></li><li><a href=#gitäºŒè¿å‡»å¯è§†åŒ–>GitäºŒè¿å‡»å¯è§†åŒ–</a></li><li><a href=#gitå¸¸ç”¨å‘½ä»¤è¿›é˜¶>Gitå¸¸ç”¨å‘½ä»¤è¿›é˜¶</a><ul><li><a href=#git-checkout><code>git checkout</code></a><ul><li><a href=#åˆ†æ”¯å‚æ•°>åˆ†æ”¯å‚æ•°</a></li><li><a href=#è¢«åˆ†ç¦»çš„headæ ‡è¯†>è¢«åˆ†ç¦»çš„HEADæ ‡è¯†</a></li></ul></li><li><a href=#git-reset><code>git reset</code></a></li><li><a href=#git-merge><code>git merge</code></a></li><li><a href=#git-cherry-pick><code>git cherry-pick</code></a></li></ul></li><li><a href=#gitæœ¬åœ°ä»“åº“è¿æ¥å¹¶ä¸Šä¼ è¿œç¨‹ä»“åº“>Gitæœ¬åœ°ä»“åº“è¿æ¥å¹¶ä¸Šä¼ è¿œç¨‹ä»“åº“</a><ul><li><a href=#ä½¿ç”¨sshå¯†é’¥å°†æœ¬åœ°gitå’Œè¿œç¨‹githubé…å¯¹>ä½¿ç”¨sshå¯†é’¥å°†æœ¬åœ°gitå’Œè¿œç¨‹GitHubé…å¯¹</a></li><li><a href=#æœ¬åœ°ä¸Šä¼ è¿œç¨‹6æ­¥èµ°æˆ˜ç•¥>æœ¬åœ°ä¸Šä¼ è¿œç¨‹6æ­¥èµ°æˆ˜ç•¥</a></li></ul></li><li><a href=#å‚è€ƒç½‘ç«™>å‚è€ƒç½‘ç«™</a></li></ul></nav></div></details></div><div class=post-content><p>è¿™ç¯‡åšå®¢ä¸»è¦è‡ªåº•å‘ä¸Šåœ°ä»‹ç»Gitå‘½ä»¤è¡Œï¼Œæœ‰æ—¶ç”šè‡³ä¼šä½¿ç”¨ä¸€äº›<code>python</code>ä»£ç æ¥å¯¹ä¸€äº›Gitçš„åŠŸèƒ½è¿›è¡Œæ›´åŠ è¯¦ç»†çš„åˆ†æã€‚æˆ‘ä¸€ç›´è®¤ä¸ºåŸºç¡€ä¸€æ—¦æ‰“å¥½ï¼Œé‚£ä¹ˆä¸€äº›æ›´é«˜çº§çš„ç”¨æ³•ä¹Ÿå¯ä»¥å¾ªåºæ¸è¿›åœ°äº†è§£ï¼Œè€Œä¸”æ˜¯æ›´åŠ é€å½»çš„äº†è§£ã€‚ä¸æ˜¯åƒåšä¸»ä¸€å¼€å§‹é‚£æ ·ä»¥ä¸ºåªè¦æ­»è®°ç¡¬èƒŒ<code>git add</code>ï¼Œ<code>git commit</code>,<code>git pull</code>ï¼Œ<code>git clone</code>ç­‰å¸¸è§å‘½ä»¤çš„ä¸€äº›ç”¨æ³•å°±å¯ä»¥äº†ğŸ˜­ï¼ˆå®é™…ä¸Šç½‘ä¸Šå¤§å¤šæ•°æ•™ç¨‹å°±æ˜¯è¿™æ ·æ•™çš„&mldr;ï¼‰ï¼Œåœ¨è¿™ä¸Šé¢èµ°äº†ä¸å°‘å¼¯è·¯ï¼Œæ‰€ä»¥ä»å¤´å¼€å§‹æ‰“åœ°åŸºå†™ä½œæ­¤æ–‡ç•™ä»¥è­¦ç¤ºâš ï¸ã€‚</p><h2 id=gitä»“åº“git-repository>Gitä»“åº“ï¼ˆGit Repositoryï¼‰<a hidden class=anchor aria-hidden=true href=#gitä»“åº“git-repository>#</a></h2><p>è¦å­¦ä¹ Gitï¼Œé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“æˆ‘ä»¬è¿è¡ŒGitå‘½ä»¤æ˜¯å¯¹ä»€ä¹ˆå¯¹è±¡è¿›è¡Œæ“ä½œçš„ï¼Œåœ¨Gitçš„ç›¸å…³æœ¯è¯­ä¸­ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå¯¹è±¡å«åšGitä»“åº“ï¼ˆGit Repositoryï¼‰ï¼ŒGitä»“åº“å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œæˆ‘ä»¬é€šè¿‡.gitæ–‡ä»¶å¤¹ï¼ˆéšè—æ–‡ä»¶å¤¹ï¼‰å¯¹Gitä»“åº“ä¸­çš„å·¥ä½œåŒºä¸­çš„æ–‡ä»¶ï¼ˆééšè—æ–‡ä»¶å¤¹ï¼‰å†…å®¹çš„æ”¹å˜è¿›è¡Œè®°å½•ï¼Œå½“ç„¶å¹¶ä¸æ˜¯æ‰€æœ‰ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶çš„æ”¹å˜éƒ½ä¼šè¢«è®°å½•ï¼Œè¢«.gitingoreæ–‡ä»¶æ‰€æ ‡è¯†çš„æ–‡ä»¶è¢«æ”¹å˜å.gitæ–‡ä»¶å¤¹ä¸ä¼šå¯¹å…¶è¿›è¡Œè®°å½•ã€‚æ ¹æ®æˆ‘ä¸Šé¢æ‰€è¯´ï¼Œ<font color=#c00000>Gitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•</font>ã€‚</p><p>æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸‹ç®€ç•¥çš„å…¬å¼ï¼š</p><div>$$\mathrm{Git}\ \mathrm{Repository} = \mathrm{.git}\ \mathrm{folder} + \mathrm{worktree}\ \mathrm{folder}\tag{1}$$</div><p>æ›´åŠ è¯¦å°½çš„æ¥è¯´ä»¥<code>python</code>æ¥æ„å»ºGitä»“åº“ç±»ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>GitRepository</span> <span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;A git repository&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>worktree</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>gitdir</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>worktree</span> <span class=o>=</span> <span class=n>path</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>gitdir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s2>&#34;.git&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=gitæ–‡ä»¶å¤¹å†…éƒ¨ç»“æ„æ¢ç©¶>.gitæ–‡ä»¶å¤¹å†…éƒ¨ç»“æ„æ¢ç©¶<a hidden class=anchor aria-hidden=true href=#gitæ–‡ä»¶å¤¹å†…éƒ¨ç»“æ„æ¢ç©¶>#</a></h2><p>å‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“äº†<font color=#ff0000>Gitæ“ä½œæœ€éšæ™¦çš„åœ°æ–¹å°±åœ¨äºå¯¹äº.gitæ–‡ä»¶å¤¹ä¸­å†…å®¹çš„ä¿®æ”¹æ¥ä¿è¯å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•</font>ï¼Œé‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¯¹æ­¤è¿›è¡Œè„±è´«æ”»åšäº†ã€‚ç”±äº.gitæ˜¯éšè—æ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå¯¹.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒæœ‰ä¸€å®šçš„äº†è§£ï¼Œ<code>git init</code>åˆå§‹åŒ–åçš„.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒå¦‚å›¾1æ‰€ç¤ºï¼Œæ­¤æ—¶Gitä»“åº“å†…é™¤äº†.gitæ–‡ä»¶å¤¹ä¹‹å¤–ä¸€ç‰‡è’èŠœã€‚</p><center><img src=./img/gitinit.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾1ï¼šè¿è¡Œgit initä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„</strong></center><p>ç„¶åæˆ‘ä»¬å†æœ¬åœ°Gitä»“åº“ä¸­æ·»åŠ å¯è§æ–‡ä»¶ï¼Œæ·»åŠ åçš„ç»“æœå¦‚å›¾2æ‰€ç¤ºã€‚</p><center><img src=./img/add.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾2ï¼šGitä»“åº“æ·»åŠ æ–‡ä»¶åçš„æ–‡ä»¶åˆ†å¸ƒ</strong></center><p>å°†ä¸Šè¿°æ‰€æœ‰æ–‡ä»¶è¿è¡Œ<code>git add</code>ä¹‹ååœ¨è¿›è¡Œ<code>git commit</code>è§‚å¯Ÿ.gitæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ†å¸ƒï¼Œå¦‚å›¾3æ‰€ç¤ºã€‚å¯ä»¥çœ‹åˆ°ç›¸è¾ƒäºæœ€åˆçš„.gitæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨<code>git add</code>å’Œ<code>git commit</code>ä¹‹åæ–‡ä»¶å¤¹ä¸­å¤šå‡ºäº†<code>index</code>æ–‡ä»¶ï¼Œ<code>log</code>æ–‡ä»¶å¤¹ï¼Œ<code>objects</code>æ–‡ä»¶å¤¹ä¸­çš„8ä¸ªæ–‡ä»¶ä»¥åŠ<code>refs/heads</code>ä¸‹çš„<code>main</code>æ–‡ä»¶ï¼Œå…¶ä»–çš„ä¸€äº›å˜åŒ–æˆ‘ä»¬ä¸åšè€ƒè™‘ã€‚<font color=#ff0000>æœ‰æœå¯¼å› æˆ‘ä»¬å¯ä»¥çŸ¥é“.gitæ–‡ä»¶å¤¹å†…éƒ¨çš„è¿™äº›å˜åŒ–ä¸­æœ‰å¯¹äºGitä»“åº“ééšè—æ–‡ä»¶å¤¹æ–‡ä»¶ä¿®æ”¹çš„è®°å½•ã€‚</font></p><center><img src=./img/gitaddcommit.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾3ï¼šè¿è¡Œgit addå’Œgit commitä¹‹å.gitæ–‡ä»¶å¤¹çš„æ–‡ä»¶åˆ†å¸ƒç»“æ„</strong></center><h2 id=gitå¯¹è±¡git-object>Gitå¯¹è±¡ï¼ˆGit Objectï¼‰<a hidden class=anchor aria-hidden=true href=#gitå¯¹è±¡git-object>#</a></h2><p>ä¸Šé¢çš„å˜åŒ–ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿè¦çŸ¥é“Gitä¸­çš„å‡ ä¹ä¸€åˆ‡éƒ½è¢«å­˜å‚¨ä¸ºGitå¯¹è±¡ï¼ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡Gitå¯¹è±¡è¿›è¡Œæ“ä½œæ¥å®Œæˆä¸Šé¢çš„å˜åŒ–ã€‚è¯´äº†è¿™ä¹ˆå¤šï¼Œè®©æˆ‘ä»¬æ¥ä¸ºGitå¯¹è±¡ä¸‹ä¸€ä¸ªæ¯”è¾ƒå®˜æ–¹çš„å®šä¹‰ï¼š<font color=#ff0000>Gitå¯¹è±¡å°±æ˜¯åœ¨ Git ä»“åº“ä¸­çš„æ–‡ä»¶ï¼Œå®ƒä»¬çš„è·¯å¾„ç”±å®ƒä»¬çš„å†…å®¹å†³å®šã€‚</font></p><p>Gitå¯¹è±¡èŒƒæ€§å¯ä»¥å€Ÿç”±<code>python</code>æ¥å®ç°ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>GitObject</span> <span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>data</span> <span class=o>!=</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>deserialize</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>init</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>serialize</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;&#34;&#34;å°†å¯¹è±¡è½¬å˜ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Unimplemented!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>deserialize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;&#34;&#34;dataé€šå¸¸ä¸ºzipæ–‡ä»¶è§£å‹ç¼©åçš„byteæ ¼å¼ï¼Œæ ¹æ®ç±»å‹è§£ç &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Unimplemented!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>init</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span> <span class=c1># Just do nothing. This is a reasonable default!</span>
</span></span></code></pre></div><p>Gitå¯¹è±¡åˆç»†åˆ†ä¸ºä»¥ä¸‹å››ç§ç±»å‹ï¼šGitBlobï¼ˆBinary Large Objectï¼‰å¯¹è±¡ï¼Œ GitCommitå¯¹è±¡ï¼Œ GitTreeå¯¹è±¡ï¼Œ GitTagå¯¹è±¡ï¼Œä»¥ä¸‹åˆ†åˆ«è¿›è¡Œä»‹ç»ã€‚</p><h3 id=gitblobå¯¹è±¡>GitBlobå¯¹è±¡<a hidden class=anchor aria-hidden=true href=#gitblobå¯¹è±¡>#</a></h3><p>æˆ‘ä»¬å…ˆæœ€ç›´è§‚çš„çœ‹çœ‹Gitä¸­å¯¹äºBlobå†…å®¹çš„å±•ç¤ºï¼Œå¦‚å›¾4æ‰€ç¤ºï¼š</p><center><img src=./img/blob.png alt=å›¾ç‰‡1 width=800></center><center><strong>å›¾4ï¼šè¿è¡Œgit cat-fileä¹‹åå¯¹a.txtæ‰€å¯¹åº”çš„ç±»å‹å’Œç±»å‹å†…å®¹çš„å±•ç¤º</strong></center><p>Blobs æ˜¯ç”¨æˆ·æ•°æ®ï¼šä½ æ”¾å…¥ Git ä¸­çš„æ¯ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼ˆå¦‚a.txtã€b.txtã€src/c.txtã€src/d.txtä¸­çš„å†…å®¹ï¼‰çš„å­—èŠ‚å½¢å¼éƒ½è¢«å­˜å‚¨ä¸ºä¸€ä¸ª blobã€‚è¿™æ ·åšä½¿å®ƒä»¬å¾ˆå®¹æ˜“æ“ä½œï¼Œå› ä¸º blob æ²¡æœ‰ç‰¹å®šçš„è¯­æ³•æˆ–çº¦æŸï¼Œé™¤äº†åŸºæœ¬çš„å¯¹è±¡å­˜å‚¨æœºåˆ¶ä¹‹å¤–ï¼Œå®ƒä»¬åªæ˜¯æœªæŒ‡å®šçš„æ•°æ®ã€‚</p><p>GitBlobå¯¹è±¡çš„<code>python</code>å®ç°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>GitBlob</span><span class=p>(</span><span class=n>GitObject</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>fmt</span><span class=o>=</span><span class=sa>b</span><span class=s1>&#39;blob&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>serialize</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>blobdata</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>deserialize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>blobdata</span> <span class=o>=</span> <span class=n>data</span>
</span></span></code></pre></div><h3 id=gittreeå¯¹è±¡>GitTreeå¯¹è±¡<a hidden class=anchor aria-hidden=true href=#gittreeå¯¹è±¡>#</a></h3><p>åŒä¸Šï¼Œæˆ‘ä»¬å…ˆæœ€ç›´è§‚çš„çœ‹çœ‹Gitä¸­å¯¹äºæ ‘å†…å®¹çš„å±•ç¤ºï¼Œå¦‚å›¾5æ‰€ç¤ºï¼š</p><center><img src=./img/tree.png alt=å›¾ç‰‡1 width=600></center><center><strong>å›¾5ï¼šè¿è¡Œgit cat-fileä¹‹åå¯¹æœ€é¡¶å±‚çš„æ ‘æ‰€å¯¹åº”çš„ç±»å‹å’Œç±»å‹å†…å®¹çš„å±•ç¤º</strong></center><p>éæ­£å¼åœ°è¯´ï¼Œæ ‘ï¼ˆtreeï¼‰æè¿°äº†Gitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹ï¼Œå®ƒå°† blobsï¼ˆæ–‡ä»¶å¯¹è±¡ï¼‰ä¸è·¯å¾„å…³è”èµ·æ¥ã€‚æ ‘æ˜¯ä¸€ä¸ªç”±ä¸‰ä¸ªå…ƒç´ ç»„æˆçš„å…ƒç»„æ•°ç»„ï¼Œè¿™äº›å…ƒç´ åŒ…æ‹¬æ–‡ä»¶æ¨¡å¼ã€ç›¸å¯¹äºå·¥ä½œæ ‘çš„è·¯å¾„ï¼Œä»¥åŠä¸€ä¸ª SHA-1 å€¼ã€‚ä¸€ä¸ªå…¸å‹çš„æ ‘çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><table><thead><tr><th>Mode</th><th>SHA-1</th><th>Path</th></tr></thead><tbody><tr><td>100644</td><td>06f844865cfc4b68116d2cbf00833b294aae63ec</td><td>.DS_Store</td></tr><tr><td>100644</td><td>e12523960bf9941182c801077be75dce699ff37c</td><td>a.txt</td></tr><tr><td>100644</td><td>753e270e92068316ec7fa2b6a40e780a4e1d14d7</td><td>b.txt</td></tr><tr><td>040000</td><td>30d66379dddee7068ab4fd3a17cc1ef9555278ac</td><td>src</td></tr></tbody></table><p>æ¨¡å¼ï¼ˆModeï¼‰å°±æ˜¯æ–‡ä»¶çš„æ¨¡å¼ï¼Œè·¯å¾„ï¼ˆPathï¼‰æ˜¯æ–‡ä»¶çš„ä½ç½®ã€‚SHA-1 æ˜¯æŒ‡å‘ä¸€ä¸ª blob æˆ–å¦ä¸€ä¸ªæ ‘å¯¹è±¡ã€‚å¦‚æœæ˜¯ blobï¼Œè·¯å¾„è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼›å¦‚æœæ˜¯æ ‘å¯¹è±¡ï¼Œè·¯å¾„è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªç›®å½•ã€‚</p><p>å¸¸è§çš„æ–‡ä»¶æ¨¡å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><ul><li><strong>100644</strong>: æ™®é€šæ–‡ä»¶ï¼Œå…·æœ‰æ ‡å‡†çš„è¯»å†™æƒé™ï¼ˆæ™®é€šçš„æ–‡æœ¬æ–‡ä»¶æˆ–ä»£ç æ–‡ä»¶ï¼‰ã€‚</li><li><strong>100755</strong>: å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå…·æœ‰æ‰§è¡Œæƒé™ï¼ˆå¦‚è„šæœ¬æˆ–å¯æ‰§è¡Œç¨‹åºï¼‰ã€‚</li><li><strong>040000</strong>: ç›®å½•ï¼ˆdirectoryï¼‰ã€‚</li><li><strong>120000</strong>: ç¬¦å·é“¾æ¥ï¼ˆsymbolic linkï¼‰ã€‚</li><li><strong>160000</strong>: Git å­æ¨¡å—ï¼ˆsubmoduleï¼‰ã€‚</li></ul><p>è€Œå®é™…ä¸Šå½“æˆ‘ä»¬è§£ææ ‘çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å¯¹<code>.git/objects</code>ä¸­æ ‘çš„SHA-1è·¯å¾„æ‰€ä»£è¡¨çš„æ–‡ä»¶è¿›è¡Œè§£å‹ç¼©åæçº¯åˆ°çš„æ ‘å¯¹è±¡å†…å®¹çš„å­—èŠ‚ç¼–ç ï¼Œå®ƒä»¬çš„æ ¼å¼é€šå¸¸å¦‚ä¸‹ï¼š</p><blockquote><p>[mode] space [path] 0x00 [sha-1] ï¼ˆbyteæ ¼å¼ï¼‰</p></blockquote><p>ç”±äºæ ‘å¯¹åº”çš„æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ä¸æ­¢ä¸€ä¸ªï¼Œæœ‰æ—¶ç”šè‡³ä¼šæœ‰åœ¨æ–‡ä»¶å¤¹ä¸­è¿›è¡Œæ–‡ä»¶å¤¹åµŒå¥—ã€‚å› æ­¤æˆ‘ä»¬è¦è®¾è®¡å‡ºå¶å­å¯¹åº”å•ä¸ªæ–‡ä»¶ï¼Œæ ‘å¯¹åº”ç”±ä¸åŒæ–‡ä»¶æ‰€ç»„æˆçš„æ–‡ä»¶å¤¹ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å°†å¶å­å¯¹è±¡å’Œæ ‘å¯¹è±¡æŒ‰ä»¥ä¸‹<code>python</code>ä»£ç æ¥è¡¨ç¤ºï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>GitTreeLeaf</span> <span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mode</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>sha</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mode</span> <span class=o>=</span> <span class=n>mode</span> <span class=c1># æ¨¡å¼</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>path</span> <span class=o>=</span> <span class=n>path</span> <span class=c1># æ–‡ä»¶è·¯å¾„</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sha</span> <span class=o>=</span> <span class=n>sha</span> <span class=c1># æ–‡ä»¶è·¯å¾„ç´¢å¼•åˆ°çš„æ–‡ä»¶å†…å®¹æ ‡å‡†åŒ–åæ‰€å¯¹åº”çš„sha-1å€¼</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GitTree</span><span class=p>(</span><span class=n>GitObject</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>fmt</span><span class=o>=</span><span class=sa>b</span><span class=s1>&#39;tree&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>deserialize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	    <span class=c1># tree_parseæ˜¯è§£ææ‰€å¾—åˆ°çš„æ ‘å¯¹è±¡çš„å­—èŠ‚ç¼–ç æ•°æ®</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=n>tree_parse</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>serialize</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	    <span class=c1># tree_serializeå°†è§£æåçš„ç»“æœæ±‚é€†å¾—åˆ°æ ‘å¯¹è±¡çš„å­—èŠ‚ç¼–ç æ•°æ®</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>tree_serialize</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>init</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>items</span> <span class=o>=</span> <span class=nb>list</span><span class=p>()</span>
</span></span></code></pre></div><p>ç”±äºä¸€ä¸ªæ ‘ä¸­æœ‰æ—¶ä¸å•å•åŒ…å«å¶å­æ›´æœ‰å¯èƒ½åŒ…å«å­æ ‘ï¼Œå…·ä½“æƒ…å½¢è§ä¸Šé¢ä¸€æ£µæ ‘çš„å…¸å‹æƒ…å†µï¼Œ<code>tree_parse</code>å’Œ<code>tree_serialize</code>å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>tree_parse</span><span class=p>(</span><span class=n>raw</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pos</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nb>max</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>raw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=nb>list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>pos</span> <span class=o>&lt;</span> <span class=nb>max</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pos</span><span class=p>,</span> <span class=n>data</span> <span class=o>=</span> <span class=n>tree_parse_one</span><span class=p>(</span><span class=n>raw</span><span class=p>,</span> <span class=n>pos</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tree_parse_one</span><span class=p>(</span><span class=n>raw</span><span class=p>,</span> <span class=n>start</span><span class=o>=</span><span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=c1># [mode] space [path] 0x00 [sha-1] ï¼ˆbyteæ ¼å¼ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=c1># æŸ¥æ‰¾å­—èŠ‚å½¢å¼ç©ºæ ¼ä»¥ç¡®å®šmode</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>raw</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39; &#39;</span><span class=p>,</span> <span class=n>start</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>x</span><span class=o>-</span><span class=n>start</span> <span class=o>==</span> <span class=mi>5</span> <span class=ow>or</span> <span class=n>x</span><span class=o>-</span><span class=n>start</span><span class=o>==</span><span class=mi>6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è¯»å–mode</span>
</span></span><span class=line><span class=cl>    <span class=n>mode</span> <span class=o>=</span> <span class=n>raw</span><span class=p>[</span><span class=n>start</span><span class=p>:</span><span class=n>x</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>mode</span><span class=p>)</span> <span class=o>==</span> <span class=mi>5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ ‡å‡†åˆ°6å­—èŠ‚</span>
</span></span><span class=line><span class=cl>        <span class=n>mode</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;0&#34;</span> <span class=o>+</span> <span class=n>mode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æŸ¥æ‰¾å­—èŠ‚å½¢å¼ç©ºç»ˆæ­¢ç¬¦ä»¥ç¡®å®špath</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=n>raw</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># è¯»å–path</span>
</span></span><span class=line><span class=cl>    <span class=n>path</span> <span class=o>=</span> <span class=n>raw</span><span class=p>[</span><span class=n>x</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>y</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è¯»å–shaâ€¦</span>
</span></span><span class=line><span class=cl>    <span class=c1># raw[y+1:y+21] æå–çš„æ˜¯ 20 å­—èŠ‚çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆSHA-1 å“ˆå¸Œå€¼ï¼‰ã€‚</span>
</span></span><span class=line><span class=cl>    <span class=n>raw_sha</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>raw</span><span class=p>[</span><span class=n>y</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>y</span><span class=o>+</span><span class=mi>21</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># int.from_bytes(raw[y+1:y+21], &#34;big&#34;)å°†æå–çš„ 20 å­—èŠ‚äºŒè¿›åˆ¶æ•°æ®è½¬</span>
</span></span><span class=line><span class=cl>    <span class=c1># æ¢ä¸ºä¸€ä¸ªæ•´æ•°ï¼Œç„¶åä½¿ç”¨ format(raw_sha, &#34;040x&#34;) å°†è¿™ä¸ªæ•´æ•°è½¬æ¢ä¸º 40 </span>
</span></span><span class=line><span class=cl>    <span class=c1># ä½çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸² ã€‚Gitä¸­é€šå¸¸ä½¿ç”¨çš„shaå€¼æ—¶è¿™ç§å½¢å¼ã€‚æ¯”å¦‚.DS_Storeå¯¹åº”</span>
</span></span><span class=line><span class=cl>    <span class=c1># çš„06f844865cfc4b68116d2cbf00833b294aae63ec</span>
</span></span><span class=line><span class=cl>    <span class=n>sha</span> <span class=o>=</span> <span class=nb>format</span><span class=p>(</span><span class=n>raw_sha</span><span class=p>,</span> <span class=s2>&#34;040x&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>y</span><span class=o>+</span><span class=mi>21</span><span class=p>,</span> <span class=n>GitTreeLeaf</span><span class=p>(</span><span class=n>mode</span><span class=p>,</span> <span class=n>path</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf8&#34;</span><span class=p>),</span> <span class=n>sha</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tree_serialize</span><span class=p>(</span><span class=n>obj</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=n>tree_leaf_sort_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>obj</span><span class=o>.</span><span class=n>items</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>+=</span> <span class=n>i</span><span class=o>.</span><span class=n>mode</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39; &#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>+=</span> <span class=n>i</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>sha</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>i</span><span class=o>.</span><span class=n>sha</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>+=</span> <span class=n>sha</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tree_leaf_sort_key</span><span class=p>(</span><span class=n>leaf</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>leaf</span><span class=o>.</span><span class=n>mode</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;10&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>leaf</span><span class=o>.</span><span class=n>path</span> <span class=c1># æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>leaf</span><span class=o>.</span><span class=n>path</span> <span class=o>+</span> <span class=s2>&#34;/&#34;</span> <span class=c1># æ–‡ä»¶å¤¹</span>
</span></span></code></pre></div><h3 id=gitcommitå¯¹è±¡>GitCommitå¯¹è±¡<a hidden class=anchor aria-hidden=true href=#gitcommitå¯¹è±¡>#</a></h3><p>åŒä¸Šï¼Œæˆ‘ä»¬å…ˆæœ€ç›´è§‚çš„çœ‹çœ‹Gitä¸­å¯¹äºæ ‘å†…å®¹çš„å±•ç¤ºï¼Œå¦‚å›¾6æ‰€ç¤ºï¼š</p><center><img src=./img/commit.png alt=å›¾ç‰‡1 width=600></center><center><strong>å›¾6ï¼šè¿è¡Œgit cat-fileä¹‹åå¯¹æœ€é¡¶å±‚çš„æäº¤æ‰€å¯¹åº”çš„ç±»å‹å’Œç±»å‹å†…å®¹çš„å±•ç¤º</strong></center><p>ä¸€ä¸ªæäº¤ï¼ˆCommitï¼‰çš„å…¸å‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>tree 50306289de5ae719af85eaad3430d785517a11e7
</span></span><span class=line><span class=cl>parent 735a65cef921f8e30ae55fdf19b695eb15ea8d45
</span></span><span class=line><span class=cl>author fordelkon &lt;27xxx88816@qq.com&gt; 1741406298 +0800
</span></span><span class=line><span class=cl>committer fordelkon &lt;27xxx88816@qq.com&gt; 1741406298 +0800
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>life is short, I use Python
</span></span></code></pre></div><p>ä»ä¸Šé¢çš„å…¸å‹æ¥çœ‹ï¼Œä¸€ä¸ªæäº¤ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>æ ‘å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å·¥ä½œæ ‘çš„å†…å®¹ã€æ–‡ä»¶å’Œç›®å½•ï¼›</li><li>é›¶ä¸ªã€ä¸€ä¸ªæˆ–å¤šä¸ªçˆ¶æäº¤ï¼›</li><li>ä¸€ä¸ªä½œè€…èº«ä»½ï¼ˆå§“åå’Œé‚®ç®±ï¼‰ä»¥åŠä¸€ä¸ªæ—¶é—´æˆ³ï¼›</li><li>ä¸€ä¸ªæäº¤è€…èº«ä»½ï¼ˆå§“åå’Œé‚®ç®±ï¼‰ä»¥åŠä¸€ä¸ªæ—¶é—´æˆ³ï¼›</li><li>ä¸€ä¸ªæäº¤ä¿¡æ¯ã€‚
ä»æäº¤çš„ç»„æˆæ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç™½å·²ç»åˆ›å»ºå¥½çš„æäº¤æ˜¯ä¸å¯å˜çš„ã€‚å¦‚æœæˆ‘ä»¬æ›´æ”¹äº†ä½œè€…ã€çˆ¶æäº¤æˆ–ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å®é™…ä¸Šæœ€ç»ˆä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ã€ä¸åŒçš„æäº¤å¯¹è±¡ä¸æ”¹å˜åçš„ç»“æœç»‘å®šã€‚æ‰€ä»¥æ¯ä¸€ä¸ªæäº¤éƒ½ä¸å®ƒåœ¨æ•´ä¸ªä»“åº“ä¸­çš„ä½ç½®åŠå…¶ä¸æœ€åˆæäº¤çš„å…³ç³»ç´§å¯†ç›¸è¿ã€‚æ¢å¥è¯è¯´ï¼Œä¸€ä¸ªç»™å®šçš„æäº¤ ID ï¼ˆsha-1ï¼‰ä¸ä»…æ ‡è¯†äº†æŸäº›æ–‡ä»¶çš„å†…å®¹ï¼Œè¿˜å°†æäº¤ä¸å®ƒçš„æ•´ä¸ªå†å²åŠæ•´ä¸ªä»“åº“ç»‘å®šåœ¨ä¸€èµ·ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰äº†æäº¤ï¼Œæˆ‘ä»¬çš„Gitçš„å†å²è®°å½•åŠŸèƒ½å°±æœ‰äº†ä¿è¯ï¼</li></ul><p>ä¸€ä¸ªæäº¤å¯¹è±¡çš„<code>python</code>ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>GitCommit</span><span class=p>(</span><span class=n>GitObject</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>fmt</span><span class=o>=</span><span class=sa>b</span><span class=s1>&#39;commit&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>deserialize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=c1># kvlm_parseæ˜¯è§£ææ‰€å¾—åˆ°çš„æäº¤å¯¹è±¡çš„å­—èŠ‚ç¼–ç æ•°æ®</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>kvlm</span> <span class=o>=</span> <span class=n>kvlm_parse</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>serialize</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=c1># kvlm_serializeå°†è§£æåçš„ç»“æœæ±‚é€†å¾—åˆ°æäº¤å¯¹è±¡çš„å­—èŠ‚ç¼–ç æ•°æ®</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>kvlm_serialize</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>kvlm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>init</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>kvlm</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span></code></pre></div><p>ç”±æäº¤çš„å…¸å‹æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†æäº¤å¯¹è±¡çš„å­—èŠ‚ç¼–ç æ•°æ®è½¬æ¢æˆé”®å€¼å¯¹çš„å­—å…¸æ ¼å¼ï¼Œç”±äºæœ‰ç©ºæ ¼å’Œå›è½¦ã€‚æ›´å½¢è±¡çš„è¡¨ç¤ºå¦‚ä¸‹:</p><blockquote><p>[key1] space [value1] \n &mldr; [keyn] space [valuen] \n [commit]</p></blockquote><p>å› æ­¤ï¼Œ<code>kvlm_parse</code>å’Œ<code>kvlm_serialize</code>çš„pythonä»£ç å¦‚ä¸‹æ‰€ç¤º</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>kvlm_parse</span><span class=p>(</span><span class=n>raw</span><span class=p>,</span> <span class=n>start</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>dct</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># å¦‚æœ dct ä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸€ä¸ªç©ºå­—å…¸</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>dct</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dct</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># ä¸èƒ½åœ¨å‡½æ•°å‚æ•°ä¸­ç›´æ¥å£°æ˜ dct=dict()ï¼Œå¦åˆ™æ‰€æœ‰å‡½æ•°è°ƒç”¨ä¼šå…±ç”¨åŒä¸€ä¸ªå­—å…¸ï¼Œ</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¯¼è‡´æ¯æ¬¡è°ƒç”¨æ—¶å­—å…¸ä¸æ–­å¢é•¿ã€‚</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è¿™ä¸ªå‡½æ•°æ˜¯é€’å½’çš„ï¼šå®ƒè¯»å–ä¸€ä¸ªé”®/å€¼å¯¹ï¼Œç„¶åè°ƒç”¨è‡ªèº«æ¥å¤„ç†ä¸‹ä¸€ä¸ªä½ç½®ã€‚</span>
</span></span><span class=line><span class=cl>    <span class=c1># å› æ­¤æˆ‘ä»¬é¦–å…ˆéœ€è¦çŸ¥é“å½“å‰çš„ä½ç½®ï¼šæ˜¯åœ¨ä¸€ä¸ªå…³é”®å­—ï¼Œè¿˜æ˜¯å·²ç»åˆ°äº†æ¶ˆæ¯éƒ¨åˆ†ã€‚</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æŸ¥æ‰¾ä¸‹ä¸€ä¸ªç©ºæ ¼å’Œæ¢è¡Œç¬¦çš„ä½ç½®</span>
</span></span><span class=line><span class=cl>    <span class=n>spc</span> <span class=o>=</span> <span class=n>raw</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39; &#39;</span><span class=p>,</span> <span class=n>start</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>nl</span> <span class=o>=</span> <span class=n>raw</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>start</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å¦‚æœç©ºæ ¼å‡ºç°åœ¨æ¢è¡Œç¬¦ä¹‹å‰ï¼Œè¯´æ˜æˆ‘ä»¬æœ‰ä¸€ä¸ªå…³é”®å­—ã€‚å¦åˆ™ï¼Œå®ƒæ˜¯æœ€ç»ˆçš„æ¶ˆæ¯éƒ¨åˆ†ï¼Œ</span>
</span></span><span class=line><span class=cl>    <span class=c1># æˆ‘ä»¬ä¼šè¯»å–ç›´åˆ°æ–‡ä»¶çš„æœ«å°¾ã€‚</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># åŸºæœ¬æƒ…å†µ</span>
</span></span><span class=line><span class=cl>    <span class=c1># =========</span>
</span></span><span class=line><span class=cl>    <span class=c1># å¦‚æœæ¢è¡Œç¬¦å…ˆå‡ºç°ï¼ˆæˆ–è€…æ ¹æœ¬æ²¡æœ‰ç©ºæ ¼ï¼Œè¿™ç§æƒ…å†µä¸‹ find è¿”å› -1ï¼‰ï¼Œ</span>
</span></span><span class=line><span class=cl>    <span class=c1># æˆ‘ä»¬å‡è®¾é‡åˆ°äº†ä¸€ä¸ªç©ºè¡Œã€‚ç©ºè¡Œæ„å‘³ç€å‰©ä½™çš„æ•°æ®æ˜¯æ¶ˆæ¯éƒ¨åˆ†ã€‚</span>
</span></span><span class=line><span class=cl>    <span class=c1># æˆ‘ä»¬å°†å®ƒå­˜å‚¨åœ¨å­—å…¸ä¸­ï¼Œé”®ä¸º Noneï¼Œç„¶åè¿”å›ã€‚</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>spc</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=n>nl</span> <span class=o>&lt;</span> <span class=n>spc</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>nl</span> <span class=o>==</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>        <span class=n>dct</span><span class=p>[</span><span class=kc>None</span><span class=p>]</span> <span class=o>=</span> <span class=n>raw</span><span class=p>[</span><span class=n>start</span><span class=o>+</span><span class=mi>1</span><span class=p>:]</span>  <span class=c1># å­˜å‚¨æ¶ˆæ¯éƒ¨åˆ†</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>dct</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># é€’å½’æƒ…å†µ</span>
</span></span><span class=line><span class=cl>    <span class=c1># ==============</span>
</span></span><span class=line><span class=cl>    <span class=c1># è¯»å–ä¸€ä¸ªé”®å€¼å¯¹å¹¶é€’å½’å¤„ç†ä¸‹ä¸€ä¸ªã€‚</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>raw</span><span class=p>[</span><span class=n>start</span><span class=p>:</span><span class=n>spc</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æŸ¥æ‰¾å€¼çš„ç»“å°¾ã€‚ä»¥ç©ºæ ¼å¼€å¤´çš„è¡Œè¡¨ç¤ºå€¼çš„å»¶ç»­è¡Œï¼Œ</span>
</span></span><span class=line><span class=cl>    <span class=c1># å› æ­¤æˆ‘ä»¬éœ€è¦å¾ªç¯ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªä¸æ˜¯ä»¥ç©ºæ ¼å¼€å¤´çš„æ¢è¡Œç¬¦ã€‚</span>
</span></span><span class=line><span class=cl>    <span class=n>end</span> <span class=o>=</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>end</span> <span class=o>=</span> <span class=n>raw</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>end</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>raw</span><span class=p>[</span><span class=n>end</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=nb>ord</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>):</span> <span class=k>break</span>  <span class=c1># æ‰¾åˆ°ä¸€ä¸ªä¸ä»¥ç©ºæ ¼å¼€å¤´çš„æ¢è¡Œç¬¦</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è·å–å€¼ï¼ŒåŒæ—¶åˆ é™¤å»¶ç»­è¡Œçš„å‰å¯¼ç©ºæ ¼</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span> <span class=o>=</span> <span class=n>raw</span><span class=p>[</span><span class=n>spc</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=n>end</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1> &#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ä¸è¦è¦†ç›–ç°æœ‰çš„æ•°æ®å†…å®¹</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>dct</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¦‚æœå­—å…¸ä¸­å·²æœ‰è¯¥é”®ï¼Œä¸”å€¼ä¸ºåˆ—è¡¨ï¼Œåˆ™ç›´æ¥æ·»åŠ æ–°å€¼</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>type</span><span class=p>(</span><span class=n>dct</span><span class=p>[</span><span class=n>key</span><span class=p>])</span> <span class=o>==</span> <span class=nb>list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>dct</span><span class=p>[</span><span class=n>key</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># å¦‚æœå·²æœ‰çš„å€¼ä¸æ˜¯åˆ—è¡¨ï¼Œåˆ›å»ºä¸€ä¸ªåˆ—è¡¨æ¥å­˜å‚¨å¤šä¸ªå€¼</span>
</span></span><span class=line><span class=cl>            <span class=n>dct</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span> <span class=n>dct</span><span class=p>[</span><span class=n>key</span><span class=p>],</span> <span class=n>value</span> <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¦‚æœå­—å…¸ä¸­æ²¡æœ‰è¯¥é”®ï¼Œåˆ™ç›´æ¥å­˜å‚¨é”®å€¼å¯¹</span>
</span></span><span class=line><span class=cl>        <span class=n>dct</span><span class=p>[</span><span class=n>key</span><span class=p>]</span><span class=o>=</span><span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># é€’å½’å¤„ç†å‰©ä½™çš„éƒ¨åˆ†</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>kvlm_parse</span><span class=p>(</span><span class=n>raw</span><span class=p>,</span> <span class=n>start</span><span class=o>=</span><span class=n>end</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=n>dct</span><span class=o>=</span><span class=n>dct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>kvlm_serialize</span><span class=p>(</span><span class=n>kvlm</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>  <span class=c1># åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„å­—èŠ‚ä¸²ç”¨äºå­˜å‚¨åºåˆ—åŒ–ç»“æœ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è¾“å‡ºå­—æ®µ</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>kvlm</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=c1># è·³è¿‡æ¶ˆæ¯ä½“æœ¬èº«ï¼ˆæ¶ˆæ¯å­˜å‚¨åœ¨å­—å…¸çš„ None é”®ä¸­ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>k</span> <span class=o>==</span> <span class=kc>None</span><span class=p>:</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>=</span> <span class=n>kvlm</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># å°†å•ä¸ªå€¼è§„èŒƒåŒ–ä¸ºåˆ—è¡¨ï¼Œä»¥ä¾¿ç»Ÿä¸€å¤„ç†</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>type</span><span class=p>(</span><span class=n>val</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>val</span> <span class=o>=</span> <span class=p>[</span> <span class=n>val</span> <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># éå†å€¼åˆ—è¡¨ï¼Œå¤„ç†æ¯ä¸ªå€¼</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>val</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># æ‹¼æ¥é”®å’Œå€¼ï¼Œå¹¶ç¡®ä¿æ¢è¡Œç¬¦åé¢æœ‰ä¸€ä¸ªç©ºæ ¼ï¼ˆç”¨äºè¡¨ç¤ºå€¼çš„å»¶ç»­è¡Œï¼‰</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>+=</span> <span class=n>k</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39; &#39;</span> <span class=o>+</span> <span class=p>(</span><span class=n>v</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1> &#39;</span><span class=p>))</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æœ€åæ‹¼æ¥æ¶ˆæ¯ä½“ï¼Œæ¶ˆæ¯ä½“ä¹‹å‰éœ€è¦ä¸€ä¸ªç©ºè¡Œåˆ†éš”</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>kvlm</span><span class=p>[</span><span class=kc>None</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span>  <span class=c1># è¿”å›åºåˆ—åŒ–åçš„å­—èŠ‚ä¸²</span>
</span></span></code></pre></div><h3 id=gittagå¯¹è±¡>GitTagå¯¹è±¡<a hidden class=anchor aria-hidden=true href=#gittagå¯¹è±¡>#</a></h3><p>æ ‡ç­¾å®é™…ä¸Šå°±æ˜¯å¼•ç”¨ï¼ˆrefsï¼‰ã€‚å®ƒä»¬ä½äº .git/refs/tags/ ç›®å½•ä¸‹ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ ‡ç­¾æœ‰ä¸¤ç§ç±»å‹ï¼šè½»é‡æ ‡ç­¾å’Œæ ‡ç­¾å¯¹è±¡ã€‚</p><h4 id=è½»é‡æ ‡ç­¾lightweight-tags>è½»é‡æ ‡ç­¾ï¼ˆâ€œLightweightâ€ tagsï¼‰<a hidden class=anchor aria-hidden=true href=#è½»é‡æ ‡ç­¾lightweight-tags>#</a></h4><p>ä»…ä»…æ˜¯æŒ‡å‘æäº¤ã€æ ‘å¯¹è±¡æˆ– blob å¯¹è±¡çš„æ™®é€šå¼•ç”¨ã€‚</p><h4 id=æ ‡ç­¾å¯¹è±¡tag-objects>æ ‡ç­¾å¯¹è±¡ï¼ˆTag objectsï¼‰<a hidden class=anchor aria-hidden=true href=#æ ‡ç­¾å¯¹è±¡tag-objects>#</a></h4><p>æ˜¯æŒ‡å‘æ ‡ç­¾ç±»å‹å¯¹è±¡çš„æ™®é€šå¼•ç”¨ã€‚ä¸è½»é‡æ ‡ç­¾ä¸åŒï¼Œæ ‡ç­¾å¯¹è±¡åŒ…å«ä½œè€…ã€æ—¥æœŸã€å¯é€‰çš„ PGP ç­¾åä»¥åŠå¯é€‰çš„æ³¨é‡Šã€‚å®ƒä»¬çš„æ ¼å¼ä¸æäº¤å¯¹è±¡ç›¸åŒã€‚</p><p>å› æ­¤ï¼ŒGitTagçš„<code>python</code>ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>GitTag</span><span class=p>(</span><span class=n>GitCommit</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>fmt</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;tag&#39;</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å·²ç»äº†è§£äº†ä¸Šé¢å››ç§Gitå¯¹è±¡ï¼Œç”±Gitå¯¹è±¡çš„å†…å®¹å†³å®šè·¯å¾„çš„æ€§è´¨ï¼Œå¯ä»¥ä¿è¯å¯¹äºééšè—æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶å†…å®¹ä¿®æ”¹çš„è®°å½•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒGitä»“åº“ééšè—æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ä¸€æ—¦è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆç›¸åº”çš„Gitå¯¹è±¡çš„è·¯å¾„ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜ï¼Œå°†ä¿®æ”¹åçš„ä¸åŒçš„Gitå¯¹è±¡çš„æ–‡ä»¶æ ‡å‡†åŒ–åå‹ç¼©æŒ‰ç…§æ”¹å˜çš„è·¯å¾„å­˜å‚¨åœ¨<code>.git/objects</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å¯¹è¯¥æ”¹å˜çš„è®°å½•ã€‚é‚£ä¹ˆæ–‡ä»¶çš„å†…å®¹å’Œæ–‡ä»¶çš„è·¯å¾„æœ‰ç€æ˜ç¡®çš„æ˜ å°„å…³ç³»å—ï¼ŸGitç»™å‡ºçš„ç­”æ¡ˆæ˜¯å¯¹æ ‡å‡†åŒ–åçš„æ–‡ä»¶å†…å®¹è¿›è¡ŒÂ <a href=https://en.wikipedia.org/wiki/SHA-1>SHA-1</a><a href=https://en.wikipedia.org/wiki/Cryptographic_hash_function>å“ˆå¸Œ</a>åå¾—åˆ°æ–‡ä»¶çš„è·¯å¾„ã€‚å¦‚ä½•è¿›è¡Œæ ‡å‡†åŒ–ä¹Ÿæ˜¯æˆ‘ä»¬å€¼å¾—æ³¨æ„çš„ï¼ŒGitä¸­å®ç°çš„æ–¹æ¡ˆæ˜¯<font color=#ff0000>å­—èŠ‚å½¢å¼ç±»å‹å¤´+å­—èŠ‚å½¢å¼ç©ºæ ¼+å­—èŠ‚å½¢å¼å¤§å°+å­—èŠ‚å½¢å¼ç©ºåˆ†ç¦»ç¬¦+å¯¹è±¡å†…å®¹çš„å­—èŠ‚ç¼–ç ã€‚</font> å…·ä½“æ–¹æ¡ˆå¦‚ä¸‹æ‰€ç¤ºï¼š</p><blockquote><p>[fmt] space [size] 0x00 [data] (byteæ ¼å¼)</p></blockquote><p>æ ¹æ®è¿™ä¸€æ ‡å‡†åŒ–çš„å½¢å¼æˆ‘ä»¬å¯ä»¥å¯¹å¯¹è±¡è¿›è¡Œè¯»å’Œå†™æ“ä½œï¼Œæ‰€æœ‰å¯¹è±¡çš„æ ¸å¿ƒè½½ä½“æ˜¯å¯¹è±¡å†…å®¹çš„å­—èŠ‚ç¼–ç ã€‚å…·ä½“<code>python</code>ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>object_read</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=n>sha</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Read object sha from Git repository repo.  Return a
</span></span></span><span class=line><span class=cl><span class=s2>    GitObject whose exact type depends on the object.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=c1># ç”±sha1å€¼å¾—åˆ°å¯¹åº”è·¯å¾„</span>
</span></span><span class=line><span class=cl>    <span class=n>path</span> <span class=o>=</span> <span class=n>repo_file</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=s2>&#34;objects&#34;</span><span class=p>,</span> <span class=n>sha</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>2</span><span class=p>],</span> <span class=n>sha</span><span class=p>[</span><span class=mi>2</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isfile</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span> <span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>raw</span> <span class=o>=</span> <span class=n>zlib</span><span class=o>.</span><span class=n>decompress</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># è¯»å–å¯¹è±¡ç±»å‹</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>raw</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39; &#39;</span><span class=p>)</span> <span class=c1># 0x20 å­—èŠ‚å½¢å¼ç©ºæ ¼</span>
</span></span><span class=line><span class=cl>        <span class=n>fmt</span> <span class=o>=</span> <span class=n>raw</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=n>x</span><span class=p>]</span> <span class=c1># å­—èŠ‚å½¢å¼ç±»å‹å¤´</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># è¯»å–æœ‰æ•ˆçš„å¯¹è±¡å¤§å°</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=n>raw</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=c1># 0x00 å­—èŠ‚å½¢å¼ç©ºåˆ†ç¦»ç¬¦</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>raw</span><span class=p>[</span><span class=n>x</span><span class=p>:</span><span class=n>y</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;ascii&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>size</span> <span class=o>!=</span> <span class=nb>len</span><span class=p>(</span><span class=n>raw</span><span class=p>)</span><span class=o>-</span><span class=n>y</span><span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Malformed object </span><span class=si>{</span><span class=n>sha</span><span class=si>}</span><span class=s2>: bad length&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># æ ¹æ®å¯¹è±¡ç±»å‹é€‰æ‹©ç”Ÿæˆå™¨</span>
</span></span><span class=line><span class=cl>        <span class=k>match</span> <span class=n>fmt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=sa>b</span><span class=s1>&#39;commit&#39;</span> <span class=p>:</span> <span class=n>c</span><span class=o>=</span><span class=n>GitCommit</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=sa>b</span><span class=s1>&#39;tree&#39;</span>   <span class=p>:</span> <span class=n>c</span><span class=o>=</span><span class=n>GitTree</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=sa>b</span><span class=s1>&#39;tag&#39;</span>    <span class=p>:</span> <span class=n>c</span><span class=o>=</span><span class=n>GitTag</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=sa>b</span><span class=s1>&#39;blob&#39;</span>   <span class=p>:</span> <span class=n>c</span><span class=o>=</span><span class=n>GitBlob</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>_</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unknown type </span><span class=si>{</span><span class=n>fmt</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;ascii&#34;</span><span class=p>)</span><span class=si>}</span><span class=s2> for object </span><span class=si>{</span><span class=n>sha</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># è°ƒç”¨ç”Ÿæˆå™¨è¿”å›å¯¹è±¡</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>c</span><span class=p>(</span><span class=n>raw</span><span class=p>[</span><span class=n>y</span><span class=o>+</span><span class=mi>1</span><span class=p>:])</span> <span class=c1># raw[y+1:]å¯¹è±¡å†…å®¹çš„å­—èŠ‚ç¼–ç </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>object_write</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span> <span class=n>repo</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># å¯¹è±¡å†…å®¹çš„å­—èŠ‚ç¼–ç </span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=n>serialize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># æ·»åŠ ä¸€äº›å‰ç¼€æˆä¸ºæ ‡å‡†æ ¼å¼</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>obj</span><span class=o>.</span><span class=n>fmt</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39; &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>))</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    <span class=c1># è®¡ç®—sha1</span>
</span></span><span class=line><span class=cl>    <span class=n>sha</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha1</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>repo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># ç”±sha1å€¼å¾—åˆ°å¯¹åº”è·¯å¾„</span>
</span></span><span class=line><span class=cl>        <span class=n>path</span><span class=o>=</span><span class=n>repo_file</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=s2>&#34;objects&#34;</span><span class=p>,</span> <span class=n>sha</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>2</span><span class=p>],</span> <span class=n>sha</span><span class=p>[</span><span class=mi>2</span><span class=p>:],</span> <span class=n>mkdir</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Compress and write</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>zlib</span><span class=o>.</span><span class=n>compress</span><span class=p>(</span><span class=n>result</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sha</span>
</span></span></code></pre></div><p>å¥½äº†ï¼Œå‰æˆå·²ç»å‡†å¤‡äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬å¯ä»¥å‡­å€ŸGitä»“åº“å’ŒGitå¯¹è±¡æ¥å®ç°æœ€æœ€æœ€é‡è¦çš„Gitä¸¤è¿å‡»å—ï¼ˆ<code>git add</code>å’Œ<code>git commit</code>ï¼‰ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯&mldr;&mldr;å¦å®šçš„ã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬å·²ç»æ‹¥æœ‰äº†è¿™ä¹ˆå¤šçš„å¯¹è±¡ï¼Œä¹Ÿæœ‰äº†è¯»å–å’Œå†™å…¥å¯¹è±¡çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬æ”¹å˜æ–‡ä»¶ï¼ˆä¸å¦¨å°±æ”¹å˜a.txtæ–‡ä»¶çš„å†…å®¹ï¼‰ï¼Œç”±å‰é¢æˆ‘ä»¬è¯´çš„ä¸»è¦çš„ä¸‰ç§å¯¹è±¡æ¥çœ‹ï¼ŒGitBlobå…ƒæ•°æ®ä¼šæ”¹å˜ï¼Œéšä¹‹è€Œæ¥çš„GitTreeå…ƒæ•°æ®ä¼šæ”¹å˜ï¼Œè¿›è€ŒGitCommitå…ƒæ•°æ®ä¹Ÿä¼šæ”¹å˜ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸æ˜¯ä¸€æŒ¥è€Œå°±çš„ï¼Œæ‰€ä»¥Gitç§æ‰ä¼šåˆ†ä¸º<code>git add</code>å’Œ<code>git commit</code>ä¸¤æ­¥èµ°ã€‚åœ¨<code>git add</code>çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å°†ä¿®æ”¹åçš„æ–‡ä»¶å±æ€§å˜åŒ–æäº¤åˆ°æš‚å­˜åŒºï¼ˆStaging areaï¼‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å›¾3ä¸­çš„<code>.git/index</code>æ–‡ä»¶ä¸­ã€‚ç„¶åä½¿ç”¨<code>git commit</code>å°†æš‚å­˜åŒºä¸­çš„æ‰€æœ‰è®°å½•çš„æ–‡ä»¶ç»Ÿåˆç”Ÿæˆæ–°çš„GitTreeï¼Œè¿›è€Œç”Ÿæˆæ–°çš„GitCommitã€‚å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªè¡¨ç¤ºæš‚å­˜åŒºçš„ç±»å‹ã€‚</p><h2 id=æš‚å­˜åŒºstaging-area>æš‚å­˜åŒºï¼ˆStaging areaï¼‰<a hidden class=anchor aria-hidden=true href=#æš‚å­˜åŒºstaging-area>#</a></h2><p>æš‚å­˜åŒºåœ¨.gitæ–‡ä»¶å¤¹ä¸­çš„å±•ç°å½¢å¼å°±æ˜¯<code>.git/index</code>æ–‡ä»¶ï¼Œåœ¨ä¸€æ¬¡æäº¤ä¹‹åï¼Œ<code>.git/index</code>æ–‡ä»¶å¯ä»¥çœ‹ä½œæ˜¯è¯¥æäº¤çš„ä¸€ç§å‰¯æœ¬ï¼šå®ƒä¿å­˜äº†ä¸å¯¹åº”çš„æ ‘ç›¸åŒçš„è·¯å¾„/Blobï¼ˆå¯¹è±¡ï¼‰çš„å…³è”å…³ç³»ã€‚ä½†å®ƒè¿˜ä¿å­˜äº†Gitä»“åº“ä¸­å…³äºæ–‡ä»¶çš„é¢å¤–ä¿¡æ¯ï¼Œæ¯”å¦‚å®ƒä»¬çš„åˆ›å»º/ä¿®æ”¹æ—¶é—´ï¼Œå› æ­¤ <code>git status</code> é€šå¸¸ä¸éœ€è¦å®é™…æ¯”è¾ƒæ–‡ä»¶ï¼šå®ƒåªéœ€è¦æ£€æŸ¥æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´æ˜¯å¦ä¸ç´¢å¼•æ–‡ä»¶ä¸­å­˜å‚¨çš„æ—¶é—´ç›¸åŒï¼Œåªæœ‰å½“å®ƒä»¬ä¸åŒæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œå®é™…çš„æ¯”è¾ƒã€‚ç±»æ¯”æ ‘å¯¹è±¡çš„è¡¨ç¤ºï¼Œ<code>.git/index</code>æ–‡ä»¶ä¸­åŒ…å«è®¸å¤šå…ƒç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯å¯¹å•ä¸ªå…ƒç´ è¿›è¡Œè¡¨ç¤ºï¼Œä¹‹åæ˜¯å¯¹æ•´ä½“<code>.git/index</code>æ–‡ä»¶è¿›è¡Œè¡¨ç¤ºã€‚</p><p>å•ä¸ªå…ƒç´ å’Œæ•´ä½“<code>.git/index</code>æ–‡ä»¶çš„<code>python</code>è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>GitIndexEntry</span> <span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ctime</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>mtime</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>dev</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>ino</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>mode_type</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>mode_perms</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>uid</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>gid</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>fsize</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>sha</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>flag_assume_valid</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>flag_stage</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ–‡ä»¶å…ƒæ•°æ®æœ€åæ›´æ”¹çš„æ—¶é—´ã€‚æ ¼å¼æ˜¯ä¸€ä¸ªäºŒå…ƒç»„</span>
</span></span><span class=line><span class=cl>        <span class=c1># (ä»¥ç§’ä¸ºå•ä½çš„æ—¶é—´æˆ³, çº³ç§’)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ctime</span> <span class=o>=</span> <span class=n>ctime</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ–‡ä»¶æ•°æ®æœ€åæ›´æ”¹çš„æ—¶é—´ã€‚æ ¼å¼æ˜¯ä¸€ä¸ªäºŒå…ƒç»„</span>
</span></span><span class=line><span class=cl>        <span class=c1># (ä»¥ç§’ä¸ºå•ä½çš„æ—¶é—´æˆ³, çº³ç§’)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mtime</span> <span class=o>=</span> <span class=n>mtime</span>
</span></span><span class=line><span class=cl>        <span class=c1># åŒ…å«è¯¥æ–‡ä»¶çš„è®¾å¤‡ID</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dev</span> <span class=o>=</span> <span class=n>dev</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ–‡ä»¶çš„inodeç¼–å·</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ino</span> <span class=o>=</span> <span class=n>ino</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¯¹è±¡ç±»å‹ï¼Œå¯ä»¥æ˜¯ b1000 (æ™®é€šæ–‡ä»¶), b1010 (ç¬¦å·é“¾æ¥),</span>
</span></span><span class=line><span class=cl>        <span class=c1># b1110 (gitlink)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mode_type</span> <span class=o>=</span> <span class=n>mode_type</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¯¹è±¡çš„æƒé™ï¼Œè¡¨ç¤ºä¸ºä¸€ä¸ªæ•´æ•°</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mode_perms</span> <span class=o>=</span> <span class=n>mode_perms</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ–‡ä»¶æ‰€æœ‰è€…çš„ç”¨æˆ·ID</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>uid</span> <span class=o>=</span> <span class=n>uid</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ–‡ä»¶æ‰€æœ‰è€…çš„ç»„ID</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>gid</span> <span class=o>=</span> <span class=n>gid</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¯¹è±¡çš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fsize</span> <span class=o>=</span> <span class=n>fsize</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¯¹è±¡çš„SHAå“ˆå¸Œå€¼</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sha</span> <span class=o>=</span> <span class=n>sha</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ ‡å¿—ï¼šå‡è®¾è¯¥å¯¹è±¡æœ‰æ•ˆ</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>flag_assume_valid</span> <span class=o>=</span> <span class=n>flag_assume_valid</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ–‡ä»¶çš„é˜¶æ®µæ ‡å¿—</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>flag_stage</span> <span class=o>=</span> <span class=n>flag_stage</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¯¹è±¡çš„åç§°ï¼ˆåŒ…æ‹¬å®Œæ•´è·¯å¾„ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GitIndex</span> <span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>entries</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=c1># ext = None</span>
</span></span><span class=line><span class=cl>    <span class=c1># sha = None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>version</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>entries</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>entries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>entries</span> <span class=o>=</span> <span class=nb>list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=n>version</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>entries</span> <span class=o>=</span> <span class=n>entries</span>
</span></span></code></pre></div><p><code>.git/index</code>æ–‡ä»¶æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯å‡ºäºæ€§èƒ½è€ƒè™‘ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒçš„æ ¼å¼ç›¸å¯¹ç®€å•ã€‚æ–‡ä»¶å¼€å§‹éƒ¨åˆ†æ˜¯ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯ï¼ŒåŒ…å«äº† DIRC é­”æ³•å­—èŠ‚ã€ç‰ˆæœ¬å·ä»¥åŠè¯¥ç´¢å¼•æ–‡ä»¶ä¸­çš„æ¡ç›®æ€»æ•°ã€‚æ›´å½¢è±¡çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><blockquote><p>[DIRC] [version] [count] [entries]</p></blockquote><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®šä¹‰<code>index_read</code>å’Œ<code>index_write</code>å‡½æ•°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>index_read</span><span class=p>(</span><span class=n>repo</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># è·å–ä»“åº“ç´¢å¼•æ–‡ä»¶çš„è·¯å¾„</span>
</span></span><span class=line><span class=cl>    <span class=n>index_file</span> <span class=o>=</span> <span class=n>repo_file</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=s2>&#34;index&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å¦‚æœç´¢å¼•æ–‡ä»¶ä¸å­˜åœ¨ï¼ˆä¾‹å¦‚æ–°ä»“åº“ï¼‰ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºçš„ GitIndex å®ä¾‹</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>index_file</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>GitIndex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æ‰“å¼€ç´¢å¼•æ–‡ä»¶ï¼Œä»¥äºŒè¿›åˆ¶æ–¹å¼è¯»å–</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>index_file</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>raw</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ç´¢å¼•æ–‡ä»¶çš„å¤´éƒ¨åŒ…å« 12 ä¸ªå­—èŠ‚</span>
</span></span><span class=line><span class=cl>    <span class=n>header</span> <span class=o>=</span> <span class=n>raw</span><span class=p>[:</span><span class=mi>12</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>signature</span> <span class=o>=</span> <span class=n>header</span><span class=p>[:</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># æ£€æŸ¥ç´¢å¼•æ–‡ä»¶çš„é­”æ³•å­—èŠ‚ï¼Œå¿…é¡»ä¸º &#34;DIRC&#34;ï¼Œä»£è¡¨ &#34;DirCache&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>signature</span> <span class=o>==</span> <span class=sa>b</span><span class=s2>&#34;DIRC&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># ä»å¤´éƒ¨è§£æç‰ˆæœ¬å·ï¼ˆ4-8å­—èŠ‚ï¼‰ï¼Œæ­¤å¤„åªæ”¯æŒç‰ˆæœ¬ 2</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>header</span><span class=p>[</span><span class=mi>4</span><span class=p>:</span><span class=mi>8</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>version</span> <span class=o>==</span> <span class=mi>2</span><span class=p>,</span> <span class=s2>&#34;wyag åªæ”¯æŒç´¢å¼•æ–‡ä»¶ç‰ˆæœ¬ 2&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># ä»å¤´éƒ¨è§£æç´¢å¼•æ–‡ä»¶ä¸­çš„æ¡ç›®æ•°é‡ï¼ˆ8-12å­—èŠ‚ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>header</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>12</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ç”¨äºå­˜å‚¨è¯»å–åˆ°çš„ç´¢å¼•æ¡ç›®</span>
</span></span><span class=line><span class=cl>    <span class=n>entries</span> <span class=o>=</span> <span class=nb>list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ç´¢å¼•æ–‡ä»¶å†…å®¹éƒ¨åˆ†ä»ç¬¬ 12 ä¸ªå­—èŠ‚å¼€å§‹</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span> <span class=o>=</span> <span class=n>raw</span><span class=p>[</span><span class=mi>12</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å¾ªç¯è§£ææ¯ä¸ªæ¡ç›®ï¼Œæ ¹æ®æ–‡ä»¶å¤´éƒ¨ç»™å‡ºçš„æ¡ç›®æ•°è¿›è¡Œå¾ªç¯</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>count</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£æåˆ›å»ºæ—¶é—´ï¼ˆç§’æ•°å’Œçº³ç§’æ•°ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=n>ctime_s</span> <span class=o>=</span>  <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>4</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ctime_ns</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>4</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>8</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£æä¿®æ”¹æ—¶é—´ï¼ˆç§’æ•°å’Œçº³ç§’æ•°ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=n>mtime_s</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>8</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>12</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>mtime_ns</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>12</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>16</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£æè®¾å¤‡ ID</span>
</span></span><span class=line><span class=cl>        <span class=n>dev</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>16</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>20</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£æ inode ç¼–å·</span>
</span></span><span class=line><span class=cl>        <span class=n>ino</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>20</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>24</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¿½ç•¥çš„å­—æ®µ</span>
</span></span><span class=line><span class=cl>        <span class=n>unused</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>24</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>26</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=mi>0</span> <span class=o>==</span> <span class=n>unused</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£ææ–‡ä»¶æ¨¡å¼ï¼ˆåŒ…æ‹¬ç±»å‹å’Œæƒé™ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=n>mode</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>26</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>28</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>mode_type</span> <span class=o>=</span> <span class=n>mode</span> <span class=o>&gt;&gt;</span> <span class=mi>12</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>mode_type</span> <span class=ow>in</span> <span class=p>[</span><span class=mb>0b1000</span><span class=p>,</span> <span class=mb>0b1010</span><span class=p>,</span> <span class=mb>0b1110</span><span class=p>]</span>  <span class=c1># æ–‡ä»¶ç±»å‹å¿…é¡»æ˜¯å¸¸è§„æ–‡ä»¶ã€ç¬¦å·é“¾æ¥æˆ– gitlink</span>
</span></span><span class=line><span class=cl>        <span class=n>mode_perms</span> <span class=o>=</span> <span class=n>mode</span> <span class=o>&amp;</span> <span class=mb>0b0000000111111111</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£æç”¨æˆ· ID å’Œç»„ ID</span>
</span></span><span class=line><span class=cl>        <span class=n>uid</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>28</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>32</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>gid</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>32</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>36</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£ææ–‡ä»¶å¤§å°</span>
</span></span><span class=line><span class=cl>        <span class=n>fsize</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>36</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>40</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£æ SHAï¼ˆå¯¹è±¡ IDï¼‰ï¼Œå¹¶æ ¼å¼åŒ–ä¸º 40 å­—ç¬¦çš„å°å†™åå…­è¿›åˆ¶å­—ç¬¦ä¸²</span>
</span></span><span class=line><span class=cl>        <span class=n>sha</span> <span class=o>=</span> <span class=nb>format</span><span class=p>(</span><span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>40</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>60</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>),</span> <span class=s2>&#34;040x&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£ææ ‡å¿—ä½</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=o>+</span><span class=mi>60</span><span class=p>:</span> <span class=n>idx</span><span class=o>+</span><span class=mi>62</span><span class=p>],</span> <span class=s2>&#34;big&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£æå‡å®šæœ‰æ•ˆæ ‡å¿—ä½</span>
</span></span><span class=line><span class=cl>        <span class=n>flag_assume_valid</span> <span class=o>=</span> <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=mb>0b1000000000000000</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£ææ‰©å±•æ ‡å¿—ä½ï¼ˆè¢«å¿½ç•¥ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=n>flag_extended</span> <span class=o>=</span> <span class=p>(</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=mb>0b0100000000000000</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=ow>not</span> <span class=n>flag_extended</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£æé˜¶æ®µæ ‡å¿—ä½</span>
</span></span><span class=line><span class=cl>        <span class=n>flag_stage</span> <span class=o>=</span>  <span class=n>flags</span> <span class=o>&amp;</span> <span class=mb>0b0011000000000000</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£ææ–‡ä»¶åé•¿åº¦ï¼ˆ12 ä½ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=n>name_length</span> <span class=o>=</span> <span class=n>flags</span> <span class=o>&amp;</span> <span class=mb>0b0000111111111111</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># è¯»å–äº† 62 ä¸ªå­—èŠ‚ï¼Œç»§ç»­å¤„ç†æ–‡ä»¶å</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>+=</span> <span class=mi>62</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># å¦‚æœæ–‡ä»¶åé•¿åº¦å°äº 0xFFFï¼Œåˆ™æ–‡ä»¶åä¹‹åæœ‰ä¸€ä¸ªç©ºå­—èŠ‚ç»ˆæ­¢ç¬¦</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name_length</span> <span class=o>&lt;</span> <span class=mh>0xFFF</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>assert</span> <span class=n>content</span><span class=p>[</span><span class=n>idx</span> <span class=o>+</span> <span class=n>name_length</span><span class=p>]</span> <span class=o>==</span> <span class=mh>0x00</span>
</span></span><span class=line><span class=cl>            <span class=n>raw_name</span> <span class=o>=</span> <span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=p>:</span><span class=n>idx</span><span class=o>+</span><span class=n>name_length</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>+=</span> <span class=n>name_length</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># å¤„ç†æ–‡ä»¶åé•¿åº¦å¤§äºç­‰äº 0xFFF çš„æƒ…å†µï¼Œéœ€è¦æŸ¥æ‰¾ç©ºå­—èŠ‚ç»ˆæ­¢ç¬¦</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;æ³¨æ„: æ–‡ä»¶åé•¿åº¦ä¸º 0x</span><span class=si>{</span><span class=n>name_length</span><span class=si>:</span><span class=s2>X</span><span class=si>}</span><span class=s2> å­—èŠ‚é•¿ã€‚&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>null_idx</span> <span class=o>=</span> <span class=n>content</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>idx</span> <span class=o>+</span> <span class=mh>0xFFF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>raw_name</span> <span class=o>=</span> <span class=n>content</span><span class=p>[</span><span class=n>idx</span><span class=p>:</span> <span class=n>null_idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=n>null_idx</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># å°†æ–‡ä»¶åè§£æä¸º UTF-8 å­—ç¬¦ä¸²</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span> <span class=o>=</span> <span class=n>raw_name</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># ç´¢å¼•æ–‡ä»¶ä¸­çš„æ•°æ®ä»¥ 8 å­—èŠ‚å¯¹é½ï¼Œå› æ­¤éœ€è¦æ ¹æ®æŒ‡é’ˆå¯¹é½è°ƒæ•´ idx</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>=</span> <span class=mi>8</span> <span class=o>*</span> <span class=n>ceil</span><span class=p>(</span><span class=n>idx</span> <span class=o>/</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># å°†è§£æå‡ºçš„ç´¢å¼•æ¡ç›®æ·»åŠ åˆ°åˆ—è¡¨ä¸­</span>
</span></span><span class=line><span class=cl>        <span class=n>entries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>GitIndexEntry</span><span class=p>(</span><span class=n>ctime</span><span class=o>=</span><span class=p>(</span><span class=n>ctime_s</span><span class=p>,</span> <span class=n>ctime_ns</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                                     <span class=n>mtime</span><span class=o>=</span><span class=p>(</span><span class=n>mtime_s</span><span class=p>,</span>  <span class=n>mtime_ns</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                                     <span class=n>dev</span><span class=o>=</span><span class=n>dev</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>ino</span><span class=o>=</span><span class=n>ino</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>mode_type</span><span class=o>=</span><span class=n>mode_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>mode_perms</span><span class=o>=</span><span class=n>mode_perms</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>uid</span><span class=o>=</span><span class=n>uid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>gid</span><span class=o>=</span><span class=n>gid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>fsize</span><span class=o>=</span><span class=n>fsize</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>sha</span><span class=o>=</span><span class=n>sha</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>flag_assume_valid</span><span class=o>=</span><span class=n>flag_assume_valid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>flag_stage</span><span class=o>=</span><span class=n>flag_stage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>name</span><span class=o>=</span><span class=n>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è¿”å›åŒ…å«æ‰€æœ‰ç´¢å¼•æ¡ç›®çš„ GitIndex å®ä¾‹</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>GitIndex</span><span class=p>(</span><span class=n>version</span><span class=o>=</span><span class=n>version</span><span class=p>,</span> <span class=n>entries</span><span class=o>=</span><span class=n>entries</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>index_write</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>repo_file</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=s2>&#34;index&#34;</span><span class=p>),</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># å†™å…¥å¤´éƒ¨ä¿¡æ¯</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># å†™å…¥é­”æœ¯å­—èŠ‚ &#34;DIRC&#34; ä»¥æ ‡è¯†è¯¥æ–‡ä»¶ä¸º Git ç´¢å¼•æ–‡ä»¶ã€‚</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;DIRC&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># å†™å…¥ç‰ˆæœ¬å·ï¼ˆå›ºå®šä¸º 2ï¼‰ã€‚</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>index</span><span class=o>.</span><span class=n>version</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1># å†™å…¥ç´¢å¼•æ¡ç›®æ•°é‡ã€‚</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>index</span><span class=o>.</span><span class=n>entries</span><span class=p>)</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># å†™å…¥æ¡ç›®æ•°æ®</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>index</span><span class=o>.</span><span class=n>entries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># å†™å…¥åˆ›å»ºæ—¶é—´ï¼ˆç§’ï¼‰å’Œåˆ›å»ºæ—¶é—´çš„çº³ç§’éƒ¨åˆ†ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>ctime</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>ctime</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=c1># å†™å…¥ä¿®æ”¹æ—¶é—´ï¼ˆç§’ï¼‰å’Œä¿®æ”¹æ—¶é—´çš„çº³ç§’éƒ¨åˆ†ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>mtime</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>mtime</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=c1># å†™å…¥è®¾å¤‡å·å’Œ inode å·ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>dev</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>ino</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># å†™å…¥æ–‡ä»¶æƒé™æ¨¡å¼ï¼ˆç±»å‹å’Œæƒé™åˆå¹¶ï¼‰ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>mode</span> <span class=o>=</span> <span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>mode_type</span> <span class=o>&lt;&lt;</span> <span class=mi>12</span><span class=p>)</span> <span class=o>|</span> <span class=n>e</span><span class=o>.</span><span class=n>mode_perms</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>mode</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># å†™å…¥ç”¨æˆ· ID å’Œç»„ IDã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>uid</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>gid</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># å†™å…¥æ–‡ä»¶å¤§å°ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>fsize</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=c1># å†™å…¥ SHA-1 å¯¹è±¡ IDã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>sha</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># å¤„ç†æ ‡å¿—ä½ `flag_assume_valid`ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>flag_assume_valid</span> <span class=o>=</span> <span class=mh>0x1</span> <span class=o>&lt;&lt;</span> <span class=mi>15</span> <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>flag_assume_valid</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># å°†æ–‡ä»¶åç¼–ç ä¸º UTF-8ï¼Œå¹¶è®¡ç®—é•¿åº¦ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>name_bytes</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>bytes_len</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>name_bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>bytes_len</span> <span class=o>&gt;=</span> <span class=mh>0xFFF</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>name_length</span> <span class=o>=</span> <span class=mh>0xFFF</span>  <span class=c1># é•¿åº¦è¿‡é•¿æ—¶ï¼Œæ ‡è®°ä¸º 0xFFFã€‚</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>name_length</span> <span class=o>=</span> <span class=n>bytes_len</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># å°† `flag_assume_valid`ã€`flag_stage` å’Œåç§°é•¿åº¦åˆå¹¶åˆ° 2 ä¸ªå­—èŠ‚ä¸­ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>((</span><span class=n>flag_assume_valid</span> <span class=o>|</span> <span class=n>e</span><span class=o>.</span><span class=n>flag_stage</span> <span class=o>|</span> <span class=n>name_length</span><span class=p>)</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># å†™å…¥æ–‡ä»¶åï¼Œå¹¶é™„åŠ ä¸€ä¸ª 0x00 ä½œä¸ºç»“å°¾ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>name_bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>((</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># è®¡ç®—å½“å‰æ¡ç›®çš„å­—èŠ‚æ•°ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>+=</span> <span class=mi>62</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>name_bytes</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># è‹¥æ¡ç›®ä¸æ˜¯ 8 å­—èŠ‚å¯¹é½ï¼Œåˆ™è¿›è¡Œå¡«å……ã€‚</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>idx</span> <span class=o>%</span> <span class=mi>8</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>pad</span> <span class=o>=</span> <span class=mi>8</span> <span class=o>-</span> <span class=p>(</span><span class=n>idx</span> <span class=o>%</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>((</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=n>pad</span><span class=p>,</span> <span class=s2>&#34;big&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>idx</span> <span class=o>+=</span> <span class=n>pad</span>
</span></span></code></pre></div><p>æŒ‰ç…§æˆ‘ä»¬å‰é¢æ‰€è¯´çš„ï¼Œ<code>git add</code>ä¼šæ ¹æ®æ‰€ä¿®æ”¹çš„æ–‡ä»¶è·¯å¾„å¯¹<code>.git/index</code>æ–‡ä»¶ä¸­çš„å†…å®¹è¿›è¡Œä¿®æ”¹ã€‚å…·ä½“å®ç°æ–¹å¼æ˜¯ä»<code>.git/index</code>æ–‡ä»¶ä¸­ç§»é™¤æŒ‡å®šè·¯å¾„çš„æ¡ç›®ï¼ˆä¸ç‰©ç†åˆ é™¤æ–‡ä»¶ï¼‰ï¼Œç„¶åå¯¹æ¯ä¸ªè·¯å¾„ï¼Œè¯»å–æ–‡ä»¶å†…å®¹ï¼Œè®¡ç®—æ–‡ä»¶çš„å“ˆå¸Œå€¼å¹¶è·å–æ–‡ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œç„¶åå°†æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯æ·»åŠ åˆ°<code>.git/index</code>æ–‡ä»¶ä¸­ï¼ŒåŒ…æ‹¬ ctimeã€mtimeã€æ–‡ä»¶æƒé™ç­‰ï¼Œæœ€åå°†æ–°çš„ç´¢å¼•æ¡ç›®å†™å›ç´¢å¼•æ–‡ä»¶ã€‚å…·ä½“çš„<code>add</code>å‡½æ•°å®ç°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=n>paths</span><span class=p>,</span> <span class=n>delete</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>skip_missing</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># é¦–å…ˆè°ƒç”¨ rm å‡½æ•°ä»ç´¢å¼•ä¸­ç§»é™¤è¿™äº›è·¯å¾„çš„æ¡ç›®ï¼Œé¿å…é‡å¤ï¼ˆä¸ç‰©ç†åˆ é™¤æ–‡ä»¶ï¼‰ã€‚</span>
</span></span><span class=line><span class=cl>    <span class=n>rm</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=n>paths</span><span class=p>,</span> <span class=n>delete</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>skip_missing</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è·å–å·¥ä½œæ ‘çš„æ ¹ç›®å½•è·¯å¾„ï¼ˆæœ«å°¾åŠ ä¸Šè·¯å¾„åˆ†éš”ç¬¦ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>worktree</span> <span class=o>=</span> <span class=n>repo</span><span class=o>.</span><span class=n>worktree</span> <span class=o>+</span> <span class=n>os</span><span class=o>.</span><span class=n>sep</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å°†è·¯å¾„è½¬æ¢ä¸º (ç»å¯¹è·¯å¾„ï¼Œç›¸å¯¹è·¯å¾„) çš„å¯¹ï¼Œå¹¶ç¡®ä¿å®ƒä»¬åœ¨å·¥ä½œæ ‘å†…ä¸”ä¸ºæ–‡ä»¶</span>
</span></span><span class=line><span class=cl>    <span class=n>clean_paths</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>paths</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>abspath</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>  <span class=c1># è·å–ç»å¯¹è·¯å¾„</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>abspath</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>worktree</span><span class=p>)</span> <span class=ow>and</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isfile</span><span class=p>(</span><span class=n>abspath</span><span class=p>)):</span>  <span class=c1># ç¡®ä¿è·¯å¾„åœ¨å·¥ä½œæ ‘å†…ä¸”ä¸ºæ–‡ä»¶</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Not a file, or outside the worktree: </span><span class=si>{</span><span class=n>paths</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>  <span class=c1># å¦‚æœè·¯å¾„æ— æ•ˆæˆ–ä¸åœ¨å·¥ä½œæ ‘å†…ï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
</span></span><span class=line><span class=cl>        <span class=n>relpath</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>relpath</span><span class=p>(</span><span class=n>abspath</span><span class=p>,</span> <span class=n>repo</span><span class=o>.</span><span class=n>worktree</span><span class=p>)</span>  <span class=c1># è·å–ç›¸å¯¹è·¯å¾„</span>
</span></span><span class=line><span class=cl>        <span class=n>clean_paths</span><span class=o>.</span><span class=n>add</span><span class=p>((</span><span class=n>abspath</span><span class=p>,</span> <span class=n>relpath</span><span class=p>))</span>  <span class=c1># æ·»åŠ åˆ° clean_paths é›†åˆä¸­</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æŸ¥æ‰¾å¹¶è¯»å–ç´¢å¼•ã€‚ç”±äº `rm` å·²ç»ä¿®æ”¹äº†ç´¢å¼•ï¼Œè¿™é‡Œå†æ¬¡è¯»å–ã€‚</span>
</span></span><span class=line><span class=cl>    <span class=c1># @FIXMEï¼šå¯ä»¥é€šè¿‡ä¼ é€’å‘½ä»¤æ¥ç§»åŠ¨ç´¢å¼•ï¼Œè€Œä¸æ˜¯åå¤è¯»å†™ç´¢å¼•ã€‚</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span> <span class=o>=</span> <span class=n>index_read</span><span class=p>(</span><span class=n>repo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># éå†æ¯ä¸ªè·¯å¾„å¯¹ï¼Œè¯»å–æ–‡ä»¶ï¼Œç”Ÿæˆå“ˆå¸Œå¹¶æ›´æ–°ç´¢å¼•æ¡ç›®</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>abspath</span><span class=p>,</span> <span class=n>relpath</span><span class=p>)</span> <span class=ow>in</span> <span class=n>clean_paths</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>abspath</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>fd</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sha</span> <span class=o>=</span> <span class=n>object_hash</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;blob&#34;</span><span class=p>,</span> <span class=n>repo</span><span class=p>)</span>  <span class=c1># è®¡ç®—æ–‡ä»¶çš„ SHA å“ˆå¸Œå€¼</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>stat</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>stat</span><span class=p>(</span><span class=n>abspath</span><span class=p>)</span>  <span class=c1># è·å–æ–‡ä»¶çŠ¶æ€</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># è·å–æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´å’Œä¿®æ”¹æ—¶é—´ï¼ˆç§’å’Œçº³ç§’ï¼‰</span>
</span></span><span class=line><span class=cl>            <span class=n>ctime_s</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>stat</span><span class=o>.</span><span class=n>st_ctime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>ctime_ns</span> <span class=o>=</span> <span class=n>stat</span><span class=o>.</span><span class=n>st_ctime_ns</span> <span class=o>%</span> <span class=mi>10</span><span class=o>**</span><span class=mi>9</span>
</span></span><span class=line><span class=cl>            <span class=n>mtime_s</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>stat</span><span class=o>.</span><span class=n>st_mtime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>mtime_ns</span> <span class=o>=</span> <span class=n>stat</span><span class=o>.</span><span class=n>st_mtime_ns</span> <span class=o>%</span> <span class=mi>10</span><span class=o>**</span><span class=mi>9</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># åˆ›å»º Git ç´¢å¼•æ¡ç›®å¯¹è±¡</span>
</span></span><span class=line><span class=cl>            <span class=n>entry</span> <span class=o>=</span> <span class=n>GitIndexEntry</span><span class=p>(</span><span class=n>ctime</span><span class=o>=</span><span class=p>(</span><span class=n>ctime_s</span><span class=p>,</span> <span class=n>ctime_ns</span><span class=p>),</span> <span class=n>mtime</span><span class=o>=</span><span class=p>(</span><span class=n>mtime_s</span><span class=p>,</span> <span class=n>mtime_ns</span><span class=p>),</span> <span class=n>dev</span><span class=o>=</span><span class=n>stat</span><span class=o>.</span><span class=n>st_dev</span><span class=p>,</span> <span class=n>ino</span><span class=o>=</span><span class=n>stat</span><span class=o>.</span><span class=n>st_ino</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                  <span class=n>mode_type</span><span class=o>=</span><span class=mb>0b1000</span><span class=p>,</span> <span class=n>mode_perms</span><span class=o>=</span><span class=mo>0o644</span><span class=p>,</span> <span class=n>uid</span><span class=o>=</span><span class=n>stat</span><span class=o>.</span><span class=n>st_uid</span><span class=p>,</span> <span class=n>gid</span><span class=o>=</span><span class=n>stat</span><span class=o>.</span><span class=n>st_gid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                  <span class=n>fsize</span><span class=o>=</span><span class=n>stat</span><span class=o>.</span><span class=n>st_size</span><span class=p>,</span> <span class=n>sha</span><span class=o>=</span><span class=n>sha</span><span class=p>,</span> <span class=n>flag_assume_valid</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                  <span class=n>flag_stage</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=n>relpath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># å°†æ–°æ¡ç›®æ·»åŠ åˆ°ç´¢å¼•æ¡ç›®åˆ—è¡¨</span>
</span></span><span class=line><span class=cl>            <span class=n>index</span><span class=o>.</span><span class=n>entries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å°†æ›´æ–°åçš„ç´¢å¼•å†™å›æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>    <span class=n>index_write</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rm</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=n>paths</span><span class=p>,</span> <span class=n>delete</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>skip_missing</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># æŸ¥æ‰¾å¹¶è¯»å–ç´¢å¼•æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span> <span class=o>=</span> <span class=n>index_read</span><span class=p>(</span><span class=n>repo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è·å–å·¥ä½œæ ‘çš„æ ¹ç›®å½•è·¯å¾„ï¼ˆæœ«å°¾åŠ ä¸Šè·¯å¾„åˆ†éš”ç¬¦ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>worktree</span> <span class=o>=</span> <span class=n>repo</span><span class=o>.</span><span class=n>worktree</span> <span class=o>+</span> <span class=n>os</span><span class=o>.</span><span class=n>sep</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å°†è¾“å…¥è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„ï¼Œå¹¶ç¡®ä¿å®ƒä»¬ä½äºå·¥ä½œæ ‘å†…</span>
</span></span><span class=line><span class=cl>    <span class=n>abspaths</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>paths</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>abspath</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>  <span class=c1># è·å–ç»å¯¹è·¯å¾„</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>abspath</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>worktree</span><span class=p>):</span>  <span class=c1># ç¡®ä¿è·¯å¾„åœ¨å·¥ä½œæ ‘ä¸­</span>
</span></span><span class=line><span class=cl>            <span class=n>abspaths</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>abspath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Cannot remove paths outside of worktree: </span><span class=si>{</span><span class=n>paths</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>  <span class=c1># å¦‚æœè·¯å¾„ä¸åœ¨å·¥ä½œæ ‘å†…ï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å°†è¦ä¿ç•™çš„ç´¢å¼•æ¡ç›®åˆ—è¡¨ï¼Œç”¨äºæ›´æ–°ç´¢å¼•æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>    <span class=n>kept_entries</span> <span class=o>=</span> <span class=nb>list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># å°†è¦åˆ é™¤çš„è·¯å¾„åˆ—è¡¨ï¼Œç”¨äºç‰©ç†åˆ é™¤æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>    <span class=n>remove</span> <span class=o>=</span> <span class=nb>list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># éå†ç´¢å¼•æ¡ç›®ï¼Œåˆ é™¤åŒ¹é…çš„è·¯å¾„ï¼Œä¿ç•™å…¶ä½™æ¡ç›®</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>index</span><span class=o>.</span><span class=n>entries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>full_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>repo</span><span class=o>.</span><span class=n>worktree</span><span class=p>,</span> <span class=n>e</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>  <span class=c1># è·å–ç´¢å¼•æ¡ç›®çš„å®Œæ•´è·¯å¾„</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>full_path</span> <span class=ow>in</span> <span class=n>abspaths</span><span class=p>:</span>  <span class=c1># å¦‚æœè·¯å¾„åœ¨å¾…åˆ é™¤åˆ—è¡¨ä¸­</span>
</span></span><span class=line><span class=cl>            <span class=n>remove</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>full_path</span><span class=p>)</span>  <span class=c1># åŠ å…¥å¾…åˆ é™¤åˆ—è¡¨</span>
</span></span><span class=line><span class=cl>            <span class=n>abspaths</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>full_path</span><span class=p>)</span>  <span class=c1># ä»å¾…åˆ é™¤è·¯å¾„ä¸­ç§»é™¤</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>kept_entries</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>  <span class=c1># ä¿ç•™è¯¥æ¡ç›®</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å¦‚æœæœ‰æœªåœ¨ç´¢å¼•ä¸­æ‰¾åˆ°çš„è·¯å¾„ï¼Œä¸” skip_missing=Falseï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>abspaths</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>skip_missing</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Cannot remove paths not in the index: </span><span class=si>{</span><span class=n>abspaths</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ç‰©ç†åˆ é™¤æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>delete</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>remove</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>os</span><span class=o>.</span><span class=n>unlink</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>  <span class=c1># åˆ é™¤æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æ›´æ–°ç´¢å¼•æ¡ç›®ï¼Œå¹¶å°†å…¶å†™å›ç´¢å¼•æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span><span class=o>.</span><span class=n>entries</span> <span class=o>=</span> <span class=n>kept_entries</span>
</span></span><span class=line><span class=cl>    <span class=n>index_write</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=n>index</span><span class=p>)</span>
</span></span></code></pre></div><p>ç„¶åå†ä½¿ç”¨<code>git add</code>ä¹‹åçš„<code>.git/index</code>æ–‡ä»¶ç”Ÿæˆæ ‘å¯¹è±¡ï¼Œæœ€åå†å€Ÿç”±æ ‘å¯¹è±¡ç”Ÿæˆæäº¤å¯¹è±¡ï¼ï¼ï¼å…·ä½“<code>python</code>ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>tree_from_index</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=n>index</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># åˆå§‹åŒ–ä¸€ä¸ªå­—å…¸ï¼Œç”¨äºå­˜å‚¨ç›®å½•åŠå…¶å†…å®¹ï¼Œæ ¹ç›®å½• &#34;&#34; å­˜å‚¨ä¸€ä¸ªç©ºåˆ—è¡¨ã€‚</span>
</span></span><span class=line><span class=cl>    <span class=n>contents</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>contents</span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># éå†ç´¢å¼•ä¸­çš„æ¯ä¸ªæ¡ç›®ï¼Œæ„å»ºç›®å½•ç»“æ„ã€‚</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>index</span><span class=o>.</span><span class=n>entries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dirname</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>entry</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>  <span class=c1># è·å–å½“å‰æ¡ç›®çš„ç›®å½•å</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># éå†ç›®å½•è·¯å¾„ï¼Œç›´åˆ°æ ¹ç›®å½•ï¼Œç¡®ä¿æ¯ä¸ªç›®å½•éƒ½è¢«åˆ›å»º</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span> <span class=o>=</span> <span class=n>dirname</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>key</span> <span class=o>!=</span> <span class=s2>&#34;&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>contents</span><span class=p>:</span>  <span class=c1># å¦‚æœè¯¥ç›®å½•å°šæœªåœ¨ contents ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªç©ºåˆ—è¡¨</span>
</span></span><span class=line><span class=cl>                <span class=n>contents</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=nb>list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># å°†æ¡ç›®æ·»åŠ åˆ°å¯¹åº”ç›®å½•çš„å†…å®¹åˆ—è¡¨ä¸­</span>
</span></span><span class=line><span class=cl>        <span class=n>contents</span><span class=p>[</span><span class=n>dirname</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è·å–æ‰€æœ‰ç›®å½•çš„è·¯å¾„å¹¶æŒ‰è·¯å¾„é•¿åº¦ä»é•¿åˆ°çŸ­æ’åº</span>
</span></span><span class=line><span class=cl>    <span class=n>sorted_paths</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>contents</span><span class=o>.</span><span class=n>keys</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=nb>len</span><span class=p>,</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># åˆå§‹åŒ–æ ‘çš„ SHA-1 å“ˆå¸Œï¼ˆæ ¹æ ‘çš„å“ˆå¸Œå€¼å°†ä¼šä¿å­˜åœ¨è¿™é‡Œï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>sha</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># éå†æ’åºåçš„è·¯å¾„ï¼ˆç›®å½•ï¼‰ï¼Œæ„å»ºæ ‘å¯¹è±¡</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>sorted_paths</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>tree</span> <span class=o>=</span> <span class=n>GitTree</span><span class=p>()</span>  <span class=c1># åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºæ ‘å¯¹è±¡</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># éå†è¯¥ç›®å½•ä¸‹çš„æ¡ç›®ï¼Œç”Ÿæˆæ ‘å¶å¹¶æ·»åŠ åˆ°æ ‘ä¸­</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>contents</span><span class=p>[</span><span class=n>path</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span> <span class=n>GitIndexEntry</span><span class=p>):</span>  <span class=c1># æ™®é€šçš„æ–‡ä»¶æ¡ç›®</span>
</span></span><span class=line><span class=cl>                <span class=c1># è½¬æ¢æ–‡ä»¶çš„æƒé™æ¨¡å¼ï¼ŒGit ä½¿ç”¨åå…­è¿›åˆ¶è¡¨ç¤ºï¼Œæ ‘å¯¹è±¡éœ€è¦çš„æ˜¯å…«è¿›åˆ¶ ASCII å­—ç¬¦ä¸²</span>
</span></span><span class=line><span class=cl>                <span class=n>leaf_mode</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>entry</span><span class=o>.</span><span class=n>mode_type</span><span class=si>:</span><span class=s2>02o</span><span class=si>}{</span><span class=n>entry</span><span class=o>.</span><span class=n>mode_perms</span><span class=si>:</span><span class=s2>04o</span><span class=si>}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;ascii&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>leaf</span> <span class=o>=</span> <span class=n>GitTreeLeaf</span><span class=p>(</span><span class=n>mode</span><span class=o>=</span><span class=n>leaf_mode</span><span class=p>,</span> <span class=n>path</span><span class=o>=</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=n>entry</span><span class=o>.</span><span class=n>name</span><span class=p>),</span> <span class=n>sha</span><span class=o>=</span><span class=n>entry</span><span class=o>.</span><span class=n>sha</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>  <span class=c1># å­ç›®å½•æ¡ç›®ï¼ˆæ ‘ï¼‰</span>
</span></span><span class=line><span class=cl>                <span class=n>leaf</span> <span class=o>=</span> <span class=n>GitTreeLeaf</span><span class=p>(</span><span class=n>mode</span><span class=o>=</span><span class=sa>b</span><span class=s2>&#34;040000&#34;</span><span class=p>,</span> <span class=n>path</span><span class=o>=</span><span class=n>entry</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>sha</span><span class=o>=</span><span class=n>entry</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>tree</span><span class=o>.</span><span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>leaf</span><span class=p>)</span>  <span class=c1># å°†å¶å­æ·»åŠ åˆ°æ ‘å¯¹è±¡ä¸­</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># å°†ç”Ÿæˆçš„æ ‘å¯¹è±¡å†™å…¥å¯¹è±¡å­˜å‚¨ï¼Œå¹¶è·å–å…¶ SHA-1 å“ˆå¸Œ</span>
</span></span><span class=line><span class=cl>        <span class=n>sha</span> <span class=o>=</span> <span class=n>object_write</span><span class=p>(</span><span class=n>tree</span><span class=p>,</span> <span class=n>repo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># å°†æ ‘å¯¹è±¡çš„å“ˆå¸Œå€¼æ·»åŠ åˆ°å…¶çˆ¶ç›®å½•çš„å†…å®¹åˆ—è¡¨ä¸­ï¼Œä½œä¸ºä¸€å¯¹ (æ–‡ä»¶å, SHA)</span>
</span></span><span class=line><span class=cl>        <span class=n>parent</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>  <span class=c1># è·å–çˆ¶ç›®å½•è·¯å¾„</span>
</span></span><span class=line><span class=cl>        <span class=n>base</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>   <span class=c1># è·å–å½“å‰ç›®å½•çš„åç§°ï¼ˆä¾‹å¦‚ &#34;main.go&#34;ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=n>contents</span><span class=p>[</span><span class=n>parent</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>base</span><span class=p>,</span> <span class=n>sha</span><span class=p>))</span>  <span class=c1># å°†çˆ¶ç›®å½•ä¸æ–°ç”Ÿæˆçš„æ ‘çš„å“ˆå¸Œå€¼å…³è”</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sha</span>  <span class=c1># è¿”å›æ ¹æ ‘çš„ SHA-1 å“ˆå¸Œ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>commit_create</span><span class=p>(</span><span class=n>repo</span><span class=p>,</span> <span class=n>tree</span><span class=p>,</span> <span class=n>parent</span><span class=p>,</span> <span class=n>author</span><span class=p>,</span> <span class=n>timestamp</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>commit</span> <span class=o>=</span> <span class=n>GitCommit</span><span class=p>()</span>  <span class=c1># åˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤å¯¹è±¡</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># è®¾ç½®æäº¤å¯¹è±¡çš„æ ‘å­—æ®µä¸ºå½“å‰æäº¤çš„æ ‘å¯¹è±¡çš„ SHA-1 å€¼</span>
</span></span><span class=line><span class=cl>    <span class=n>commit</span><span class=o>.</span><span class=n>kvlm</span><span class=p>[</span><span class=sa>b</span><span class=s2>&#34;tree&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>tree</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;ascii&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># å¦‚æœæœ‰çˆ¶æäº¤ï¼Œè®¾ç½®çˆ¶æäº¤å­—æ®µ</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>parent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>commit</span><span class=o>.</span><span class=n>kvlm</span><span class=p>[</span><span class=sa>b</span><span class=s2>&#34;parent&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>parent</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;ascii&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æ¸…ç†æäº¤ä¿¡æ¯ï¼Œå¹¶åœ¨æœ«å°¾åŠ ä¸Šæ¢è¡Œç¬¦</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=n>message</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># æ ¼å¼åŒ–æ—¶åŒºåç§»ï¼ˆä¾‹å¦‚ &#34;+0200&#34; æˆ– &#34;-0700&#34;ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>offset</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>timestamp</span><span class=o>.</span><span class=n>astimezone</span><span class=p>()</span><span class=o>.</span><span class=n>utcoffset</span><span class=p>()</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>())</span>  <span class=c1># è·å–æ—¶åŒºåç§»ï¼ˆç§’ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>hours</span> <span class=o>=</span> <span class=n>offset</span> <span class=o>//</span> <span class=mi>3600</span>  <span class=c1># è®¡ç®—å°æ—¶</span>
</span></span><span class=line><span class=cl>    <span class=n>minutes</span> <span class=o>=</span> <span class=p>(</span><span class=n>offset</span> <span class=o>%</span> <span class=mi>3600</span><span class=p>)</span> <span class=o>//</span> <span class=mi>60</span>  <span class=c1># è®¡ç®—åˆ†é’Ÿ</span>
</span></span><span class=line><span class=cl>    <span class=n>tz</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>{}{:02}{:02}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&#34;+&#34;</span> <span class=k>if</span> <span class=n>offset</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&#34;-&#34;</span><span class=p>,</span> <span class=n>hours</span><span class=p>,</span> <span class=n>minutes</span><span class=p>)</span>  <span class=c1># æ ¼å¼åŒ–æ—¶åŒºå­—ç¬¦ä¸²</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å°†ä½œè€…ä¿¡æ¯æ ¼å¼åŒ–ä¸º &#34;Author Name &lt;email&gt; timestamp timezone&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>author</span> <span class=o>=</span> <span class=n>author</span> <span class=o>+</span> <span class=n>timestamp</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34; </span><span class=si>%s</span><span class=s2> &#34;</span><span class=p>)</span> <span class=o>+</span> <span class=n>tz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è®¾ç½®æäº¤å¯¹è±¡çš„ä½œè€…å’Œæäº¤è€…å­—æ®µä¸ºç›¸åŒçš„å€¼</span>
</span></span><span class=line><span class=cl>    <span class=n>commit</span><span class=o>.</span><span class=n>kvlm</span><span class=p>[</span><span class=sa>b</span><span class=s2>&#34;author&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>author</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>commit</span><span class=o>.</span><span class=n>kvlm</span><span class=p>[</span><span class=sa>b</span><span class=s2>&#34;committer&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>author</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è®¾ç½®æäº¤ä¿¡æ¯å­—æ®µ</span>
</span></span><span class=line><span class=cl>    <span class=n>commit</span><span class=o>.</span><span class=n>kvlm</span><span class=p>[</span><span class=kc>None</span><span class=p>]</span> <span class=o>=</span> <span class=n>message</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å°†æäº¤å¯¹è±¡å†™å…¥å¯¹è±¡å­˜å‚¨ï¼Œå¹¶è¿”å›å…¶ SHA-1 å“ˆå¸Œ</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>object_write</span><span class=p>(</span><span class=n>commit</span><span class=p>,</span> <span class=n>repo</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=gitäºŒè¿å‡»å¯è§†åŒ–>GitäºŒè¿å‡»å¯è§†åŒ–<a hidden class=anchor aria-hidden=true href=#gitäºŒè¿å‡»å¯è§†åŒ–>#</a></h2><p>å·²ç»äº†è§£äº†ä¸Šé¢çš„åº•å±‚åŸç†åï¼Œå¯¹Gitä¸¤è¿å‡»çš„çš„å¯è§†åŒ–ä¹Ÿå°±ååˆ†ç®€å•äº†ï¼Œè¯¦è§ä¸‹å›¾ï¼Œå‚è€ƒ<a href=https://zhuanlan.zhihu.com/p/96631135>è¿™æ‰æ˜¯çœŸæ­£çš„Gitâ€”â€”Gitå†…éƒ¨åŸç†æ­ç§˜ï¼</a>ï¼š
<input type=checkbox id=zoomCheck-ebf77 hidden>
<label for=zoomCheck-ebf77><img class=zoomCheck loading=lazy decoding=async src=./img/object.png alt=image>
</label><input type=checkbox id=zoomCheck-e1011 hidden>
<label for=zoomCheck-e1011><img class=zoomCheck loading=lazy decoding=async src=./img/change.gif alt=gif>
</label><input type=checkbox id=zoomCheck-0d927 hidden>
<label for=zoomCheck-0d927><img class=zoomCheck loading=lazy decoding=async src=./img/add.gif alt=gif>
</label><input type=checkbox id=zoomCheck-c023b hidden>
<label for=zoomCheck-c023b><img class=zoomCheck loading=lazy decoding=async src=./img/commit.gif alt=gif>
</label>ç°åœ¨ï¼ŒğŸ˜®â€ğŸ’¨ï¼Œæ‰€æœ‰GitåŸºç¡€çš„å†…å®¹çš„åº•å±‚åŸç†ä»¥åŠå…¶ä»£ç å½¢å¼å·®ä¸å¤šå°±è®²è§£å®Œäº†ã€‚è¿˜æœ‰ä¸€äº›æ¯”è¾ƒé«˜çº§çš„Gitå†…å®¹æˆ‘ä»¬ç•™å¾…åæ–‡ã€‚</p><h2 id=gitå¸¸ç”¨å‘½ä»¤è¿›é˜¶>Gitå¸¸ç”¨å‘½ä»¤è¿›é˜¶<a hidden class=anchor aria-hidden=true href=#gitå¸¸ç”¨å‘½ä»¤è¿›é˜¶>#</a></h2><p>æˆ‘ä»¬å·²ç»å¯è§†åŒ–äº†Gitä¸¤è¿å‡»ä¸­ç»†èŠ‚ï¼Œä¸‹é¢æˆ‘ä»¬å¯ä»¥ä»é«˜å±‚æ¬¡çš„è§†è§’ï¼ˆGitCommitï¼‰æ¥å¯¹Gitä¸­çš„é«˜é˜¶å¸¸ç”¨å‘½ä»¤è¿›è¡Œå¯è§†åŒ–ï¼Œå¯è§†åŒ–ç»“æœç”±<a href="https://learngitbranching.js.org/?locale=zh_CN">Learn Git Branch</a>æä¾›ã€‚æˆ‘ä»¬ç»è¿‡ä¸€ç³»åˆ—çš„<code>git add</code>å’Œ<code>git commit</code>ä»¥åŠ<code>git checkout</code>ä¹‹åå¾—åˆ°çš„åˆå§‹çš„GitCommitçš„åˆ†å¸ƒæƒ…å†µå¦‚å›¾7æ‰€ç¤ºã€‚</p><center><img src=./img/highlevel.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾7ï¼šåˆå§‹GitCommitåˆ†å¸ƒæƒ…å†µ</strong></center><p>æ¥ä¸‹æ¥å…ˆä»‹ç»çš„4ä¸ªå‘½ä»¤çš„è”ç³»å¦‚å›¾8æ‰€ç¤ºï¼š</p><center><img src=./img/git3.png alt=å›¾ç‰‡1 width=400></center><center><img src=./img/git3high.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾8ï¼šgit resetã€git checkoutã€git addå’Œ git commitçš„è”ç³»</strong></center><p><code>git add</code>å’Œ<code>git commit</code> å‘½ä»¤æˆ‘ä»¬å·²ç»è¯¦ç»†ä»‹ç»è¿‡äº†ï¼Œä¸‹é¢å†ç®€è¦å¯¹å¯¹è¿™4ä¸ªå‘½ä»¤è¿›è¡Œå™è¿°ã€‚</p><ul><li><code>git addÂ files</code>Â æŠŠå½“å‰æ–‡ä»¶æ”¾å…¥æš‚å­˜åŒºåŸŸã€‚</li><li><code>git commit -m message</code>Â ç»™æš‚å­˜åŒºåŸŸç”Ÿæˆå¿«ç…§å¹¶æäº¤ï¼Œè€Œ<code>git commit -a -m message</code>è‡ªåŠ¨å°†æ‰€æœ‰è¢«è·Ÿè¸ªçš„æ–‡ä»¶çš„æ›´æ”¹æš‚å­˜å¹¶æäº¤ï¼Œçœç•¥äº†<code>git add</code>çš„æ­¥éª¤ã€‚</li><li><code>git reset files</code>Â ç”¨æ¥æ’¤é”€æœ€åä¸€æ¬¡<code>git addÂ files</code>ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨<code>git reset</code>Â æ’¤é”€æ‰€æœ‰æš‚å­˜åŒºåŸŸæ–‡ä»¶ã€‚</li><li><code>git checkout files</code>Â æŠŠæ–‡ä»¶ä»æš‚å­˜åŒºåŸŸå¤åˆ¶åˆ°å·¥ä½œç›®å½•ï¼Œç”¨æ¥ä¸¢å¼ƒæœ¬åœ°ä¿®æ”¹ï¼Œè€Œ<code>git checkout HEAD files</code>Â ç”¨æ¥å°†å·¥ä½œç›®å½•ä¸­æŒ‡å®šæ–‡ä»¶æ¢å¤åˆ°å½“å‰åˆ†æ”¯æœ€æ–°ä¸€æ¬¡æäº¤æ—¶çš„çŠ¶æ€ï¼ˆå³ HEAD æŒ‡é’ˆæŒ‡å‘çš„æäº¤ï¼‰ã€‚è¿™ç›¸å½“äºä¸¢å¼ƒå¯¹è¿™äº›æ–‡ä»¶çš„æ‰€æœ‰æœªæäº¤ä¿®æ”¹ï¼Œæ¢å¤åˆ°ä¸Šä¸€æ¬¡æäº¤çš„ç‰ˆæœ¬ã€‚</li></ul><h3 id=git-checkout><code>git checkout</code><a hidden class=anchor aria-hidden=true href=#git-checkout>#</a></h3><h4 id=åˆ†æ”¯å‚æ•°>åˆ†æ”¯å‚æ•°<a hidden class=anchor aria-hidden=true href=#åˆ†æ”¯å‚æ•°>#</a></h4><p>checkoutå‘½ä»¤ç”¨äºä»å†å²æäº¤ï¼ˆæˆ–è€…æš‚å­˜åŒºåŸŸï¼‰ä¸­æ‹·è´æ–‡ä»¶åˆ°å·¥ä½œç›®å½•ï¼Œä¹Ÿå¯ç”¨äºåˆ‡æ¢åˆ†æ”¯ã€‚å½“ä¸æŒ‡å®šæ–‡ä»¶åï¼Œè€Œæ˜¯ç»™å‡ºä¸€ä¸ªï¼ˆæœ¬åœ°ï¼‰åˆ†æ”¯æ—¶ï¼Œé‚£ä¹ˆ<code>HEAD</code>æ ‡è¯†ä¼šç§»åŠ¨åˆ°é‚£ä¸ªåˆ†æ”¯ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬â€œåˆ‡æ¢â€åˆ°é‚£ä¸ªåˆ†æ”¯äº†ï¼‰ï¼Œç„¶åæš‚å­˜åŒºåŸŸå’Œå·¥ä½œç›®å½•ä¸­çš„å†…å®¹ä¼šå’Œ<code>HEAD</code>å¯¹åº”çš„æäº¤èŠ‚ç‚¹ä¸€è‡´ã€‚æ–°æäº¤èŠ‚ç‚¹ï¼ˆä¸‹å›¾ä¸­çš„C1ï¼‰ä¸­çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šè¢«å¤åˆ¶ï¼ˆåˆ°æš‚å­˜åŒºåŸŸå’Œå·¥ä½œç›®å½•ä¸­ï¼‰ï¼›åªå­˜åœ¨äºè€çš„æäº¤èŠ‚ç‚¹ï¼ˆC5ï¼‰ä¸­çš„æ–‡ä»¶ä¼šè¢«åˆ é™¤ï¼›ä¸å±äºä¸Šè¿°ä¸¤è€…çš„æ–‡ä»¶ä¼šè¢«å¿½ç•¥ï¼Œä¸å—å½±å“ã€‚(åˆ†æ”¯åœ¨<code>.git</code>æ–‡ä»¶å¤¹ä¸­å¯¹åº”<code>.git/refs/heads/</code>ä¸­çš„æ–‡ä»¶ï¼Œ<code>HEAD</code>å¯¹åº”<code>.git</code>æ–‡ä»¶å¤¹ä¸­çš„<code>HEAD</code>æ–‡ä»¶ï¼Œ<code>git checkout stable</code>å°†<code>HEAD</code>æ–‡ä»¶å†…å®¹ç”±<code>ref: refs/heads/main</code>æ”¹å˜æˆ<code>ref: refs/heads/stable</code>åŒæ—¶æš‚å­˜åŒºå’Œå·¥ä½œç›®å½•ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–)</p><center><img src=./img/branch.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾9ï¼šgit checkout stableå°†åˆ†æ”¯ä»mainè½¬æ¢åˆ°stable</strong></center><h4 id=è¢«åˆ†ç¦»çš„headæ ‡è¯†>è¢«åˆ†ç¦»çš„HEADæ ‡è¯†<a hidden class=anchor aria-hidden=true href=#è¢«åˆ†ç¦»çš„headæ ‡è¯†>#</a></h4><p>å¦‚æœæ—¢æ²¡æœ‰æŒ‡å®šæ–‡ä»¶åï¼Œä¹Ÿæ²¡æœ‰æŒ‡å®šåˆ†æ”¯åï¼Œè€Œæ˜¯ä¸€ä¸ªæ ‡ç­¾ã€è¿œç¨‹åˆ†æ”¯ã€SHA-1å€¼æˆ–è€…æ˜¯åƒmain~3ç±»ä¼¼çš„ä¸œè¥¿ï¼Œå°±å¾—åˆ°ä¸€ä¸ªåŒ¿ååˆ†æ”¯ï¼Œç§°ä½œdetached HEADï¼ˆè¢«åˆ†ç¦»çš„HEADæ ‡è¯†ï¼‰ï¼Œæš‚å­˜åŒºåŸŸå’Œå·¥ä½œç›®å½•ä¸­çš„å†…å®¹ä¼šå’Œ<code>HEAD</code>å¯¹åº”çš„æäº¤èŠ‚ç‚¹ä¸€è‡´ã€‚</p><center><img src=./img/detached.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾10ï¼šgit checkout main~3å°†HEADåˆ†ç¦»å‡ºæ¥</strong></center><p>HEADå¤„äºåˆ†ç¦»çŠ¶æ€æ—¶ï¼Œæäº¤æ“ä½œå¯ä»¥æ­£å¸¸è¿›è¡Œå¦‚å›¾11æ‰€ç¤ºï¼Œä½†æ˜¯ä¸ä¼šæ›´æ–°ä»»ä½•å·²å‘½åçš„åˆ†æ”¯ã€‚(ä½ å¯ä»¥è®¤ä¸ºè¿™æ˜¯åœ¨æ›´æ–°ä¸€ä¸ªåŒ¿ååˆ†æ”¯ã€‚)ä¸€æ—¦æ­¤åä½ åˆ‡æ¢åˆ°åˆ«çš„åˆ†æ”¯ï¼Œæ¯”å¦‚è¯´mainï¼Œé‚£ä¹ˆè¿™ä¸ªæäº¤èŠ‚ç‚¹ï¼ˆå¯èƒ½ï¼‰å†ä¹Ÿä¸ä¼šè¢«å¼•ç”¨åˆ°ï¼Œç„¶åå°±ä¼šè¢«ä¸¢å¼ƒæ‰äº†ï¼Œå¦‚å›¾12æ‰€ç¤ºã€‚</p><center><img src=./img/detached_commit.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾11ï¼šHEADæ ‡è¯†å¤„äºåˆ†ç¦»çŠ¶æ€æ—¶çš„æäº¤æ“ä½œ</strong></center><center><img src=./img/detached_main.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾12ï¼šgit checkout mainè¿è¡Œåä¹‹å‰æäº¤èŠ‚ç‚¹çš„æƒ…å†µ</strong></center><p>ä½†æ˜¯ï¼Œå¦‚æœä½ æƒ³ä¿å­˜è¿™ä¸ªçŠ¶æ€ï¼Œå¯ä»¥ç”¨å‘½ä»¤<code>git checkout -bÂ name</code>æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯ï¼Œå¦‚å›¾13æ‰€ç¤ºã€‚</p><center><img src=./img/new_branch.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾13ï¼šgit checkout -b newè¿è¡Œåå¯ä»¥ä¿å­˜æäº¤çŠ¶æ€</strong></center><h3 id=git-reset><code>git reset</code><a hidden class=anchor aria-hidden=true href=#git-reset>#</a></h3><p>resetå‘½ä»¤æŠŠå½“å‰åˆ†æ”¯æŒ‡å‘å¦ä¸€ä¸ªä½ç½®ï¼Œå¹¶ä¸”æœ‰é€‰æ‹©çš„å˜åŠ¨å·¥ä½œç›®å½•å’Œç´¢å¼•ã€‚ä¹Ÿç”¨æ¥åœ¨ä»å†å²ä»“åº“ä¸­å¤åˆ¶æ–‡ä»¶åˆ°ç´¢å¼•ï¼Œè€Œä¸åŠ¨å·¥ä½œç›®å½•ã€‚</p><p>å¦‚æœä¸ç»™é€‰é¡¹ï¼Œç§»åŠ¨<code>HEAD</code>åˆ°æŒ‡å®šçš„æäº¤ï¼Œå¹¶ä¸”å°†æ›´æ”¹ä»æš‚å­˜åŒºç§»é™¤ï¼Œä½†ä¿ç•™åœ¨å·¥ä½œç›®å½•ä¸­ï¼ˆéœ€è¦<code>git add</code>å’Œ<code>git commit</code>ï¼‰ã€‚å¦‚æœç”¨<code>--hard</code>é€‰é¡¹ï¼Œç§»åŠ¨<code>HEAD</code>åˆ°æŒ‡å®šçš„æäº¤ï¼Œå¹¶ä¸”é‡ç½®æš‚å­˜åŒºå’Œå·¥ä½œç›®å½•ï¼Œå¦‚æœç”¨<code>--soft</code>é€‰é¡¹ï¼Œä»…ä»…ç§»åŠ¨<code>HEAD</code>åˆ°æŒ‡å®šçš„æäº¤ï¼Œä½†ä¿ç•™å·¥ä½œåŒºå’Œæš‚å­˜åŒºçš„æ›´æ”¹ï¼ˆä»…éœ€è¦<code>git commit</code>ï¼‰ã€‚</p><center><img src=./img/reset.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾14ï¼šç°å°†HEADæŒ‡å‘mainåˆ†æ”¯å†è¿è¡Œgit reset main~3åçš„æƒ…å†µ</strong></center><p>å¦‚æœæ²¡æœ‰ç»™å‡ºæäº¤ç‚¹çš„ç‰ˆæœ¬å·ï¼Œé‚£ä¹ˆé»˜è®¤ç”¨HEADã€‚è¿™æ ·ï¼Œåˆ†æ”¯æŒ‡å‘ä¸å˜ï¼Œä½†æ˜¯ç´¢å¼•ä¼šå›æ»šåˆ°æœ€åä¸€æ¬¡æäº¤ï¼Œå¦‚æœç”¨<code>--hard</code>é€‰é¡¹ï¼Œå·¥ä½œç›®å½•ä¹ŸåŒæ ·ã€‚</p><h3 id=git-merge><code>git merge</code><a hidden class=anchor aria-hidden=true href=#git-merge>#</a></h3><p>merge å‘½ä»¤æŠŠä¸åŒåˆ†æ”¯åˆå¹¶èµ·æ¥ã€‚åˆå¹¶å‰ï¼Œç´¢å¼•å¿…é¡»å’Œå½“å‰æäº¤ç›¸åŒã€‚å¦‚æœå¦ä¸€ä¸ªåˆ†æ”¯æ˜¯å½“å‰æäº¤çš„ç¥–çˆ¶èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåˆå¹¶å‘½ä»¤å°†ä»€ä¹ˆä¹Ÿä¸åšã€‚ å¦ä¸€ç§æƒ…å†µæ˜¯å¦‚æœå½“å‰æäº¤æ˜¯å¦ä¸€ä¸ªåˆ†æ”¯çš„ç¥–çˆ¶èŠ‚ç‚¹ï¼Œå°±å¯¼è‡´fast-forwardåˆå¹¶ã€‚æŒ‡å‘åªæ˜¯ç®€å•çš„ç§»åŠ¨ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„æäº¤ã€‚</p><center><img src=./img/merge_before.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾14ï¼šè¿è¡Œgit merge mainå‰çš„æƒ…å†µ</strong></center><center><img src=./img/merge_after.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾15ï¼šè¿è¡Œgit merge mainåçš„æƒ…å†µï¼Œå¿«é€Ÿå‰è¿›</strong></center><p>å¦åˆ™å°±æ˜¯ä¸€æ¬¡çœŸæ­£çš„åˆå¹¶ã€‚é»˜è®¤æŠŠå½“å‰æäº¤(C5Â å¦‚ä¸‹æ‰€ç¤º)å’Œå¦ä¸€ä¸ªæäº¤(C7)ä»¥åŠä»–ä»¬çš„å…±åŒç¥–çˆ¶èŠ‚ç‚¹(C2)è¿›è¡Œä¸€æ¬¡<a href=http://en.wikipedia.org/wiki/Three-way_merge>ä¸‰æ–¹åˆå¹¶</a>ã€‚ç»“æœæ˜¯å…ˆä¿å­˜å½“å‰ç›®å½•å’Œç´¢å¼•ï¼Œç„¶åå’Œçˆ¶èŠ‚ç‚¹C7ä¸€èµ·åšä¸€æ¬¡æ–°æäº¤ã€‚</p><center><img src=./img/merge_before2.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾16ï¼šè¿è¡Œgit merge mainå‰çš„æƒ…å†µ</strong></center><center><img src=./img/merge_after2.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾17ï¼šè¿è¡Œgit merge mainåçš„æƒ…å†µï¼Œæ­£å®—èåˆ</strong></center><h3 id=git-cherry-pick><code>git cherry-pick</code><a hidden class=anchor aria-hidden=true href=#git-cherry-pick>#</a></h3><p><code>git cherry-pick</code>å‘½ä»¤"å¤åˆ¶"ä¸€ä¸ªæäº¤èŠ‚ç‚¹å¹¶åœ¨å½“å‰åˆ†æ”¯åšä¸€æ¬¡å®Œå…¨ä¸€æ ·çš„æ–°æäº¤ï¼Œæš‚å­˜åŒºå’Œå·¥ä½œç›®å½•éƒ½å‘ç”Ÿæ”¹å˜ã€‚</p><center><img src=./img/cherry_pick_before.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾18ï¼šè¿è¡Œgit cherry-pick C4ä¹‹å‰çš„æƒ…å†µ</strong></center><center><img src=./img/cherry_pick_after.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾19ï¼šè¿è¡Œgit cherry-pick C4ä¹‹åçš„æƒ…å†µï¼Œå¤åˆ¶C4åœ¨å½“å‰mainåˆ†æ”¯ä¸‹åšä¸€æ¬¡å®Œå…¨ç›¸åŒçš„æäº¤</strong></center>### `git rebase`<p>è¡åˆæ˜¯åˆå¹¶å‘½ä»¤çš„å¦ä¸€ç§é€‰æ‹©ã€‚åˆå¹¶æŠŠä¸¤ä¸ªçˆ¶åˆ†æ”¯åˆå¹¶è¿›è¡Œä¸€æ¬¡æäº¤ï¼Œæäº¤å†å²ä¸æ˜¯çº¿æ€§çš„ã€‚è¡åˆåœ¨å½“å‰åˆ†æ”¯ä¸Šé‡æ¼”å¦ä¸€ä¸ªåˆ†æ”¯çš„å†å²ï¼Œæäº¤å†å²æ˜¯çº¿æ€§çš„ã€‚ æœ¬è´¨ä¸Šï¼Œè¿™æ˜¯çº¿æ€§åŒ–çš„è‡ªåŠ¨çš„Â <code>cherry-pick</code>ã€‚</p><center><img src=./img/rebase_bug_before.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾20ï¼šè¿è¡Œgit rebase bugFixä¹‹å‰çš„æƒ…å†µ</strong></center><center><img src=./img/rebase_bug_after.png alt=å›¾ç‰‡1 width=400></center><center><strong>å›¾21ï¼šè¿è¡Œgit rebase bugFixä¹‹åçš„æƒ…å†µ</strong></center><h2 id=gitæœ¬åœ°ä»“åº“è¿æ¥å¹¶ä¸Šä¼ è¿œç¨‹ä»“åº“>Gitæœ¬åœ°ä»“åº“è¿æ¥å¹¶ä¸Šä¼ è¿œç¨‹ä»“åº“<a hidden class=anchor aria-hidden=true href=#gitæœ¬åœ°ä»“åº“è¿æ¥å¹¶ä¸Šä¼ è¿œç¨‹ä»“åº“>#</a></h2><h3 id=ä½¿ç”¨sshå¯†é’¥å°†æœ¬åœ°gitå’Œè¿œç¨‹githubé…å¯¹>ä½¿ç”¨sshå¯†é’¥å°†æœ¬åœ°gitå’Œè¿œç¨‹GitHubé…å¯¹<a hidden class=anchor aria-hidden=true href=#ä½¿ç”¨sshå¯†é’¥å°†æœ¬åœ°gitå’Œè¿œç¨‹githubé…å¯¹>#</a></h3><p>å‚è€ƒ<a href=https://zhuanlan.zhihu.com/p/138305054>https://zhuanlan.zhihu.com/p/138305054</a></p><h3 id=æœ¬åœ°ä¸Šä¼ è¿œç¨‹6æ­¥èµ°æˆ˜ç•¥>æœ¬åœ°ä¸Šä¼ è¿œç¨‹6æ­¥èµ°æˆ˜ç•¥<a hidden class=anchor aria-hidden=true href=#æœ¬åœ°ä¸Šä¼ è¿œç¨‹6æ­¥èµ°æˆ˜ç•¥>#</a></h3><ul><li><code>git init</code>ï¼šå°†æ–‡ä»¶å¤¹è®¾ç½®ä¸ºæœ¬åœ°ä»“åº“ï¼Œåªæœ‰è¿™æ ·æ‰å¯ä»¥æŠŠæœ¬åœ°çš„æ–‡ä»¶ä¼ å…¥githubä»“åº“ã€‚</li><li><code>git remote add originÂ git@github.com:yourusername/yourprojectname.git</code>ï¼šå°†æœ¬åœ°ä»“åº“ä¸githubä»“åº“è¿›è¡Œå…³è”ã€‚</li><li><code>git pull origin main(or master)</code>ï¼šå°†GitHubä¸Šä»“åº“çš„å†…å®¹pullåˆ°æœ¬åœ°ä»“åº“ï¼Œä¸¤è€…ä¿æŒä¸€è‡´ã€‚</li><li><code>git add</code>ï¼šéœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ æ·»åŠ æ–‡ä»¶åˆ°æœ¬åœ°åº“ã€‚ï¼ˆ<font color=#ff0000>å†æ¬¡ä¸Šä¼ å°±æ˜¯3æ­¥èµ°æˆ˜ç•¥</font>ï¼‰</li><li><code>git commit -m â€œinformationâ€</code>ï¼šæäº¤æ–‡ä»¶åˆ°æœ¬åœ°åº“ã€‚ï¼ˆ<font color=#ff0000>å†æ¬¡ä¸Šä¼ å°±æ˜¯3æ­¥èµ°æˆ˜ç•¥</font>ï¼‰</li><li><code>git push origin main(or master)</code>ï¼šä¸Šä¼ æ–‡ä»¶ã€‚ï¼ˆ<font color=#ff0000>å†æ¬¡ä¸Šä¼ å°±æ˜¯3æ­¥èµ°æˆ˜ç•¥</font>ï¼‰</li></ul><h2 id=å‚è€ƒç½‘ç«™>å‚è€ƒç½‘ç«™<a hidden class=anchor aria-hidden=true href=#å‚è€ƒç½‘ç«™>#</a></h2><ul><li><a href=https://wyag.thb.lt/#org2e1a2c4>Write yourself a Git!</a></li><li><a href=https://zhuanlan.zhihu.com/p/96631135>è¿™æ‰æ˜¯çœŸæ­£çš„Gitâ€”â€”Gitå†…éƒ¨åŸç†æ­ç§˜ï¼</a></li><li><a href="https://learngitbranching.js.org/?locale=zh_CN">Learn Git Branch</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://fordelkon.github.io/tags/git/>Git</a></li><li><a href=https://fordelkon.github.io/tags/python/>Python</a></li></ul><nav class=paginav><a class=prev href=https://fordelkon.github.io/posts/cmd_intro_1/><span class=title>Â« Prev</span><br><span>ä½¿ç”¨å‘½ä»¤è¡Œçš„è‰ºæœ¯1</span>
</a><a class=next href=https://fordelkon.github.io/teaching/probdis/><span class=title>Next Â»</span><br><span>æ·±åº¦å­¦ä¹ ä¸­å¸¸ç”¨çš„æ¦‚ç‡åˆ†å¸ƒæ€»ç»“</span></a></nav></footer><div class=giscus_comments><script src=https://giscus.app/client.js data-repo=jesse-wei/jessewei.dev-PaperMod data-repo-id=R_kgDOJhJgPg data-category=Comments data-category-id=DIC_kwDOJhJgPs4CWei3 data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div><script async>document.querySelector("div.giscus_comments > script").setAttribute("data-theme",localStorage.getItem("pref-theme")?localStorage.getItem("pref-theme"):window.matchMedia("(prefers-color-scheme: dark)").matches?"transparent_dark":"light"),document.querySelector("#theme-toggle").addEventListener("click",()=>{let e=document.querySelector("iframe.giscus-frame");e&&e.contentWindow.postMessage({giscus:{setConfig:{theme:localStorage.getItem("pref-theme")?localStorage.getItem("pref-theme")==="dark"?"light":"transparent_dark":document.body.className.includes("dark")?"light":"transparent_dark"}}},"https://giscus.app")})</script></article></main><footer class=footer style=padding-top:18px;padding-bottom:18px><div class=social-icons style=padding-bottom:0><a style=border-bottom:none href=https://github.com/fordelkon rel=me title=Github><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a style=border-bottom:none href=https://x.com/fordelkon rel=me title=Twitter><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg>
</a><a style=border-bottom:none href=mailto:dlkong201893@gmail.com rel=me title=Email><svg viewBox="0 0 24 21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div><span>&copy; 2025 <a href=https://fordelkon.github.io/>DL Kong</a></span>
<span>â€¢
Powered by
<a href=https://gohugo.io/>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/>PaperMod</a>
</span><span>â€¢
<a href=/privacy>Privacy Policy</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let b=document.querySelector("#menu-trigger"),m=document.querySelector(".menu");b.addEventListener("click",function(){m.classList.toggle("hidden")}),document.body.addEventListener("click",function(e){b.contains(e.target)||m.classList.add("hidden")})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>